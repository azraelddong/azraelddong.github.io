<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Nettyå­¦ä¹ </title>
    <link href="/2025/08/12/netty/"/>
    <url>/2025/08/12/netty/</url>
    
    <content type="html"><![CDATA[<h1 id="Nettyå­¦ä¹ "><a href="#Nettyå­¦ä¹ " class="headerlink" title="Nettyå­¦ä¹ "></a>Nettyå­¦ä¹ </h1><p>Nettyæ˜¯ä¸€ä¸ª<strong>å¼‚æ­¥çš„ï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨</strong>çš„ç½‘ç»œæ¡†æ¶ã€‚</p><p>ä¹¦ç±æ¨èï¼š</p><ul><li>netty in actionï¼ˆåå®æˆ˜ï¼‰</li><li>nettyæƒå¨æŒ‡å—ï¼ˆnetty5ç†è®ºï¼‰</li></ul><h2 id="BIOã€NIO"><a href="#BIOã€NIO" class="headerlink" title="BIOã€NIO"></a>BIOã€NIO</h2><h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h3><p>é˜»å¡IOå®ç°æœåŠ¡ç«¯ServerSocketæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é˜»å¡ioæœåŠ¡ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockIoMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();<br><br>        <span class="hljs-comment">// æœåŠ¡ç«¯ServerSocketæœåŠ¡</span><br>        <span class="hljs-type">ServerSocket</span> <span class="hljs-variable">serverSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-number">7777</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨è¿æ¥.....&quot;</span>);<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> serverSocket.accept();<br><br>            System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯å·²è¿æ¥....&quot;</span>);<br><br>            executorService.execute(() -&gt; &#123;<br>                System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹idï¼š&quot;</span> + Thread.currentThread().getId() + <span class="hljs-string">&quot;ï¼Œçº¿ç¨‹åç§°ï¼š&quot;</span> + Thread.currentThread().getName());<br>                handler(socket);<br>            &#125;);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¤„ç†å™¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handler</span><span class="hljs-params">(Socket socket)</span> &#123;<br>        <span class="hljs-keyword">try</span> (socket) &#123;<br>            <span class="hljs-comment">// è¯»å–</span><br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> socket.getInputStream();<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br><br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹idï¼š&quot;</span> + Thread.currentThread().getId() + <span class="hljs-string">&quot;ï¼Œçº¿ç¨‹åç§°ï¼š&quot;</span> + Thread.currentThread().getName());<br>                <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> is.read(bytes);<br>                <span class="hljs-comment">// ğŸŒˆç»“æŸè¿”å›-1</span><br>                <span class="hljs-keyword">if</span> (read == -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, read));<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä½¿ç”¨telnetè¿›è¡Œè¿æ¥</p><p><img src="/2025/08/12/netty/image-20250812161413186.png" alt="image-telnetè¿æ¥æœåŠ¡ç«¯å‘½ä»¤"></p><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="/2025/08/12/netty/image-20250812161457946.png" alt="image-ç»“æœ"></p><p>ç»“è®ºï¼š</p><p>æ¯æ¬¡æ–°çš„å®¢æˆ·ç«¯è¿æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯éƒ½ä¼šæ–°èµ·ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè¯»å†™å¤„ç†ï¼Œä¸¥é‡æµªè´¹æœåŠ¡å™¨èµ„æºå’Œå¢åŠ CPUç³»ç»Ÿå¼€é”€ï¼›è€Œä¸”è¿æ¥åï¼Œæ²¡æœ‰æ•°æ®è¯»å†™çš„æ—¶å€™ï¼Œä¼šé˜»å¡ä½ï¼Œè¿˜ä¸ä¼šé‡Šæ”¾æœåŠ¡ç«¯èµ„æºï¼Œé€ æˆç³»ç»Ÿèµ„æºæµªè´¹ï¼›</p><h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><p>NIOä¸­ä¸‰ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ï¼š</p><ul><li>Channelï¼šé€šé“</li><li>Bufferï¼šç¼“å†²åŒº</li><li>Selectorï¼šé€‰æ‹©å™¨</li></ul><p><strong>NIOè¿æ¥å…³ç³»ï¼šå®¢æˆ·ç«¯ &#x3D;&#x3D;&gt; bufferç¼“å†²åŒº &lt;&#x3D;&#x3D;&gt; Channelé€šé“ &#x3D;&#x3D;&gt; Selectoré€‰æ‹©å™¨</strong></p><ul><li>æ¯ä¸ªclientéƒ½å¯¹åº”ä¸€ä¸ªbufferç¼“å†²åŒº</li><li>bufferç¼“å†²å™¨å’Œchannelé€šé“åŒå‘è¿æ¥</li><li>channelé€šé“æ³¨å†Œåˆ°selectoré€‰æ‹©å™¨</li><li>selectoré€‰æ‹©å™¨é€‰æ‹©å“ªä¸ªé€šé“æ˜¯ç”±**äº‹ä»¶ï¼ˆEventï¼‰**æ¥å†³å®šçš„</li></ul><p>ç¼“å†²å™¨ï¼ˆBufferï¼‰è¯»å†™æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.nio.IntBuffer;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é€šé“è¯»å†™</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicNioMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">IntBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> IntBuffer.allocate(<span class="hljs-number">5</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; buffer.capacity(); i++) &#123;<br>            buffer.put(i * <span class="hljs-number">2</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// ğŸŒˆè¯»å†™è½¬æ¢å¿…è¦çš„ï¼ï¼ï¼</span><br>        buffer.flip();<br><br>        <span class="hljs-keyword">while</span> (buffer.hasRemaining()) &#123;<br>            System.out.println(buffer.get());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="/2025/08/12/netty/image-20250812171744045.png" alt="é€šé“è¯»å†™ç»“æœ"></p><h4 id="Bufferç¼“å†²åŒº"><a href="#Bufferç¼“å†²åŒº" class="headerlink" title="Bufferç¼“å†²åŒº"></a>Bufferç¼“å†²åŒº</h4><p>Bufferçˆ¶ç±»ä¸­æœ‰4ä¸ªé‡è¦çš„å­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mark</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> limit;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;<br></code></pre></td></tr></table></figure><h4 id="Channelé€šé“"><a href="#Channelé€šé“" class="headerlink" title="Channelé€šé“"></a>Channelé€šé“</h4><p>1.æ–‡ä»¶è¯»å–ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileReadWriteNioMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a.txt&quot;</span>);<br><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/b.txt&quot;</span>);<br><br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">inChannel</span> <span class="hljs-operator">=</span> is.getChannel();<br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">outChannel</span> <span class="hljs-operator">=</span> os.getChannel();<br><br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">30</span>);<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br><br>            <span class="hljs-comment">// ğŸŒˆç‰¹åˆ«é‡è¦ï¼ï¼ï¼ï¼ä¸€å®šè¦å¤ä½ï¼Œä¸ç„¶ä¼šä¸€ç›´è¾“å‡º0</span><br>            buffer.clear();<br><br>            <span class="hljs-comment">// è¯»å–</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> inChannel.read(buffer);<br>            System.out.println(<span class="hljs-string">&quot;read = &quot;</span> + read);<br>            <span class="hljs-keyword">if</span> (read == -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// ç¼“å†²åŒºåè½¬</span><br>            buffer.flip();<br><br>            <span class="hljs-comment">// å†™å…¥</span><br>            outChannel.write(buffer);<br>        &#125;<br><br>        is.close();<br>        os.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong> å¾ªç¯è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®çš„æ—¶å€™ï¼Œæ¯æ¬¡å¿…é¡»è¦å¤ä½ä¸ç„¶ï¼Œä¼šæœ‰ä¸¥é‡çš„bug</p><p>æ­£å¸¸çš„æƒ…å†µï¼Œæ˜¯å¯ä»¥æ­£å¸¸ç»“æŸçš„ï¼›</p><p>ä½†æ˜¯å¦‚æœä¸å¤ä½çš„æƒ…å†µä¸‹ï¼Œä¼šæ­»å¾ªç¯æ‰“å°0ï¼Œç¨‹åºä¹Ÿç»“æŸä¸äº†ã€‚</p><p><img src="/2025/08/12/netty/image-20250813115308065.png" alt="ä¸å¤ä½çš„ç»“æœå›¾"></p><p>2.å¯ä»¥ä½¿ç”¨transfromå’Œtranstoæ–¹æ³•è¿›è¡Œæ‹·è´æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileTransNioMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a2.txt&quot;</span>);<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a.txt&quot;</span>);<br><br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">inChannel</span> <span class="hljs-operator">=</span> is.getChannel();<br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">outChannel</span> <span class="hljs-operator">=</span> os.getChannel();<br><br>        outChannel.transferFrom(inChannel, <span class="hljs-number">0</span>, inChannel.size());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>transferFrom(ReadableByteChannel channel, long position, long count)</p><p>transTo(long position, long count, WriteableByteChannel channel)</p><ul><li>Channel ï¼šæ¥æºé€šé“</li><li>positionï¼šèµ·å§‹ä½ç½®</li><li>countï¼šè¯»å–çš„ä¸ªæ•°</li></ul><p>3.MappedByteBufferï¼šå¯ä»¥ç›´æ¥åœ¨å †å¤–å†…å­˜ä¿®æ”¹å†…å®¹ï¼Œä¸éœ€è¦æ‹·è´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.io.RandomAccessFile;<br><span class="hljs-keyword">import</span> java.nio.MappedByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MappedByteBufferMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">randomAccessFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a.txt&quot;</span>, <span class="hljs-string">&quot;rw&quot;</span>);<br><br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">fileChannel</span> <span class="hljs-operator">=</span> randomAccessFile.getChannel();<br><br>        <span class="hljs-type">MappedByteBuffer</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> fileChannel.map(FileChannel.MapMode.READ_WRITE, <span class="hljs-number">0</span>, fileChannel.size());<br><br>        <span class="hljs-comment">// ä¿®æ”¹ä¸‹æ ‡æ˜¯0çš„å­—èŠ‚</span><br>        map.put(<span class="hljs-number">0</span>, (<span class="hljs-type">byte</span>) <span class="hljs-string">&#x27;H&#x27;</span>);<br><br>        randomAccessFile.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="Selectoré€‰æ‹©å™¨"><a href="#Selectoré€‰æ‹©å™¨" class="headerlink" title="Selectoré€‰æ‹©å™¨"></a>Selectoré€‰æ‹©å™¨</h4><p>Selectorå¯ä»¥æ³¨å†Œå¤šä¸ªé€šé“ï¼Œé€šè¿‡äº‹ä»¶ï¼ˆeventï¼‰æ¥å†³å®šæ¥ä½¿ç”¨å“ªä¸ªé€šé“ã€‚</p><p>Selectorä¸­ä¿å­˜äº†SelectionKeyé›†å’Œï¼Œè€ŒSelectionKeyä¸­ä¿å­˜äº†ç›‘å¬çš„é€šé“ä¿¡æ¯å’Œç›‘å¬çš„ç±»å‹ï¼ˆOP_ACCEPTã€OP_CONNECTã€OP_READã€OP_WRITEï¼‰</p><p>å¸¸ç”¨çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Selector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> Selector.open();<span class="hljs-comment">// å¼€å¯selector</span><br><br><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> selector.select();<span class="hljs-comment">// é€‰æ‹©å™¨ç›‘å¬çš„é€šé“æœ‰äº‹ä»¶å‘ç”Ÿçš„ä¸ªæ•°ï¼Œæ²¡æœ‰äº‹ä»¶å°±ä¼šä¸€ç›´é˜»å¡ä½</span><br><br>Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();<span class="hljs-comment">// é€‰æ‹©å™¨ä¸­æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“å¯¹åº”çš„key</span><br><br>Set&lt;SelectionKey&gt; keys = selector.keys();<span class="hljs-comment">// é€‰æ‹©å™¨ä¸Šæ‰€æœ‰é€šé“å¯¹åº”çš„keysï¼Œä¸ç®¡æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿ</span><br><br><br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨NIOå®ç°ä¸€ä¸ªç®€æ˜“çš„ç¾¤èŠåŠŸèƒ½</strong></p><p>Serverç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio.chat;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.Channel;<br><span class="hljs-keyword">import</span> java.nio.channels.SelectionKey;<br><span class="hljs-keyword">import</span> java.nio.channels.Selector;<br><span class="hljs-keyword">import</span> java.nio.channels.ServerSocketChannel;<br><span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * èŠå¤©æœåŠ¡ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatServerMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ChatServerMain</span> <span class="hljs-variable">chatServer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatServerMain</span>();<br>        chatServer.listen();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> Selector selector;<br>    <span class="hljs-keyword">private</span> ServerSocketChannel serverSocketChannel;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8899</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatServerMain</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            serverSocketChannel = ServerSocketChannel.open();<br>            serverSocketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>            serverSocketChannel.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(port));<br><br>            selector = Selector.open();<br><br>            serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT); <span class="hljs-comment">// è¿æ¥äº‹ä»¶</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç›‘å¬äº‹ä»¶</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listen</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-comment">// æ²¡æœ‰äº‹ä»¶é˜»å¡ä½</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> selector.select();<br>                <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// è¯´æ˜æœ‰äº‹ä»¶å‘ç”Ÿ</span><br>                    Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();<br>                    Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();<br>                    <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                        <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> iterator.next();<br>                        <span class="hljs-keyword">if</span> (next.isAcceptable()) &#123;  <span class="hljs-comment">// OP_ACCEPT</span><br>                            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> serverSocketChannel.accept();<br>                            socketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>                            socketChannel.register(selector, SelectionKey.OP_READ);<br><br>                            System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯ä¸Šçº¿ï¼Œaddress:&quot;</span> + socketChannel.getRemoteAddress());<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (next.isReadable()) &#123;    <span class="hljs-comment">// OP_READ</span><br>                            read(next);<br>                        &#125;<br><br>                        iterator.remove();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                serverSocketChannel.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¯»å–æ¶ˆæ¯</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">read</span><span class="hljs-params">(SelectionKey key)</span> &#123;<br>        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel = (SocketChannel) key.channel();<br><br>            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">1024</span>);<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> channel.read(buffer);<br><br>            <span class="hljs-keyword">if</span> (read &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer.array());<br>                System.out.println(<span class="hljs-string">&quot;å‘é€çš„æ¶ˆæ¯ï¼š&quot;</span> + msg);<br><br>                <span class="hljs-comment">// è½¬å‘æ¶ˆæ¯</span><br>                sendOther(msg, channel);<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">if</span> (channel != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    System.out.println(channel.getRemoteAddress() + <span class="hljs-string">&quot; ç¦»çº¿äº†....&quot;</span>);<br>                    channel.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>                    ex.printStackTrace();<br>                &#125;<br>            &#125;<br>            key.cancel();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è½¬å‘æ¶ˆæ¯ï¼Œæ’é™¤è‡ªèº«</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOther</span><span class="hljs-params">(String msg, SocketChannel self)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Set&lt;SelectionKey&gt; keys = selector.keys();<br>        <span class="hljs-keyword">for</span> (SelectionKey key : keys) &#123;<br>            <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> key.channel();<br>            <span class="hljs-keyword">if</span> (channel <span class="hljs-keyword">instanceof</span> SocketChannel &amp;&amp; channel != self) &#123;<br>                <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> (SocketChannel) channel;<br>                <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(msg.getBytes());<br><br>                socketChannel.write(buffer);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Clientç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio.chat;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.SelectionKey;<br><span class="hljs-keyword">import</span> java.nio.channels.Selector;<br><span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * èŠå¤©å®¢æˆ·ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatClientMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ChatClientMain</span> <span class="hljs-variable">chatClientMain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatClientMain</span>();<br><br>        <span class="hljs-comment">// æ¯éš”3sè¯»å–ä¸€æ¬¡é€šé“ä¿¡æ¯</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                chatClientMain.receive();<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">3_000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>        <span class="hljs-keyword">while</span> (scanner.hasNextLine()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> scanner.nextLine();<br>            chatClientMain.send(msg);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8899</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">private</span> SocketChannel socketChannel;<br>    <span class="hljs-keyword">private</span> Selector selector;<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatClientMain</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            socketChannel = SocketChannel.open(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(host, port));<br>            socketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>            selector = Selector.open();<br><br>            socketChannel.register(selector, SelectionKey.OP_READ);<br><br>            username = socketChannel.getLocalAddress().toString().substring(<span class="hljs-number">1</span>);<br>            System.out.println(username + <span class="hljs-string">&quot;is ok....&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String msg)</span> &#123;<br>        msg = username + <span class="hljs-string">&quot;è¯´ï¼š&quot;</span> + msg;<br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(msg.getBytes());<br>        <span class="hljs-keyword">try</span> &#123;<br>            socketChannel.write(buffer);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// æ²¡æœ‰äº‹ä»¶é˜»å¡ä½</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> selector.select();<br>            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();<br>                Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();<br>                <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                    <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> iterator.next();<br>                    <span class="hljs-keyword">if</span> (next.isReadable()) &#123;    <span class="hljs-comment">// OP_READ</span><br>                        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> (SocketChannel) next.channel();<br>                        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">1024</span>);<br>                        channel.read(buffer);<br>                        System.out.println(<span class="hljs-string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer.array()));<br>                    &#125;<br>                    iterator.remove();<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>netty</category>
      
    </categories>
    
    
    <tags>
      
      <tag>netty</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>english</title>
    <link href="/2025/07/25/english/"/>
    <url>/2025/07/25/english/</url>
    
    <content type="html"><![CDATA[<ul><li><p><strong>exhaust</strong>                 vt. è€—å°½ï¼Œæ’ç©º  n. åºŸæ°”ï¼Œæ’æ°”</p></li><li><p><strong>hijack</strong>            v. åŠ«æŒï¼Œæ“çºµ n. åŠ«æŒï¼›æ•²è¯ˆ</p></li><li><p><strong>republican</strong>                    adj. å…±å’Œå›½çš„ï¼Œå…±å’Œå…šçš„  n. å…±å’Œå…šå‘˜</p></li><li><p><strong>release</strong>                          v.é‡Šæ”¾ï¼Œæ’æ”¾ï¼ˆæ°”ä½“ï¼‰ï¼›å‘æ³„ï¼ˆæƒ…æ„Ÿï¼‰ï¼›æ”¾å¼€ï¼Œæ¾å¼€ï¼›å‘å¸ƒï¼Œå‘è¡Œï¼›å…é™¤ï¼ˆè´£ä»»ï¼‰ï¼›</p><p>â€‹                                   n.é‡Šæ”¾ï¼Œæ’æ”¾ï¼›å‘å¸ƒå£°æ˜ï¼›å…é™¤ï¼ˆè´£ä»»ï¼‰ï¼›è§£è„±</p></li><li><p><strong>ridiculous</strong>                      adj.å¥½ç¬‘çš„ï¼Œè’è°¬çš„ï¼Œæ„šè ¢çš„</p></li><li><p><strong>manipulate</strong>                   vt.æ“çºµï¼Œå½±å“ï¼›v. ã€è´¢ã€‘æ“çºµ</p></li><li><p><strong>addition</strong>                         n.åŠ æ³•ï¼›é™„åŠ ç‰©ï¼›e.g in addition to é™¤äº† â€¦â€¦ä¹‹å¤–</p></li><li><p><strong>recreation</strong>                     n.å¨±ä¹æ´»åŠ¨ï¼›æ¶ˆé£ï¼›ï¼ˆèº«å¿ƒï¼‰ä¿®å…»</p></li><li><p><strong>melody</strong>                          n.ï¼ˆéŸ³ä¹ï¼‰æ—‹å¾‹</p></li><li><p><strong>accommodation</strong>          n.ä½å®¿ï¼Œä½å¤„ï¼›è°ƒè§£ï¼›é€‚åº”</p></li><li><p><strong>glacier</strong>                            n.å†°å·ï¼Œå†°æ²³</p></li><li><p><strong>glacial</strong>                            adj.å†°å·å½¢æˆçš„</p></li><li><p><strong>tie</strong>                                    n.è”ç³»ï¼Œå…³ç³»ï¼Œçº½å¸¦ï¼›é¢†å¸¦ï¼›å¹³å±€ï¼›æŸç¼š</p></li></ul><p>â€‹         v.æ‰“æˆå¹³å±€ï¼Œå¾—åˆ†ç›¸åŒï¼›æ‰“ç»“ï¼›æ†ç»‘ï¼›ä½¿ç´§å¯†ç»“åˆ </p><ul><li><strong>fracture</strong>                          v.ä½¿éª¨æŠ˜ï¼ŒæŠ˜æ–­ï¼›n.éª¨æŠ˜ï¼›æŠ˜æ–­ï¼›è£‚å£</li><li><strong>crack</strong>                               v.æ‰“ç¢ï¼›æ–­è£‚ï¼ŒæŠ˜æ–­ï¼›n.è£‚ç¼ï¼›è£‚ç¼å£°ï¼›æŒ–è‹¦è¯ï¼›adj.ä¼˜ç§€çš„ï¼Œä¸€æµçš„ï¼›adv.å°–é”çš„</li><li><strong>benevolent</strong>                      adj.ä¹å–„å¥½æ–½çš„ï¼›æ…ˆçˆ±çš„ï¼Œä»æ…ˆçš„</li></ul>]]></content>
    
    
    <categories>
      
      <category>è‹±è¯­</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è€ƒéªŒè‹±è¯­</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>oracle-tools</title>
    <link href="/2025/07/22/oracle-tools/"/>
    <url>/2025/07/22/oracle-tools/</url>
    
    <content type="html"><![CDATA[<h1 id="oracleå°æŠ€å·§"><a href="#oracleå°æŠ€å·§" class="headerlink" title="oracleå°æŠ€å·§"></a>oracleå°æŠ€å·§</h1><p>åœ¨oracleä¸­ï¼Œæœ‰ä¸€äº›å‘½ä»¤æ‰§è¡Œæ•ˆç‡éå¸¸é«˜</p><ul><li>inset int â€¦.. select â€¦ from tableï¼šå°†æŸ¥è¯¢è¡¨çš„æ•°æ®ç›´æ¥æ’å…¥åˆ°å¯¹åº”è¡¨ä¸­</li></ul><p>å®æµ‹å¤‡ä»½åº“25wå·¦å³çš„æ•°æ®ï¼ˆåŒ…å«å¤§å­—æ®µï¼‰ï¼Œæ‰§è¡Œä¸Šé¢çš„å‘½ä»¤èŠ±è´¹ä¸åˆ°10sçš„æ—¶é—´ï¼Œå¯ä»¥æœ‰æ•ˆè¿›è¡Œè¡¨ä¹‹é—´çš„æ•°æ®å¤‡ä»½</p><ul><li>CREATE TABLE â€¦ AS SELECT â€¦ ï¼šåˆ›å»ºè¡¨å¹¶å¤‡ä»½æ•°æ®</li></ul><p>åˆ›å»ºè¡¨å’Œå­—æ®µåç§°æ¥å¤‡ä»½æŸ¥è¯¢çš„æ•°æ®åº“è¡¨æ•°æ®ï¼Œæ•ˆç‡æå‡éå¸¸é«˜</p><p>1.ç®€å•è¡¨å¤‡ä»½</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> employees_copy<br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> employees;<br></code></pre></td></tr></table></figure><p>2.å¤‡ä»½éƒ¨åˆ†æ•°æ®å¹¶ä½¿ç”¨å¹¶è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> recent_orders<br>PARALLEL <span class="hljs-number">8</span><br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> orders<br><span class="hljs-keyword">WHERE</span> order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-type">DATE</span> <span class="hljs-string">&#x27;2023-01-01&#x27;</span>;<br></code></pre></td></tr></table></figure><p>3.åˆ›å»ºè¡¨å¹¶è‡ªå®šä¹‰åˆ—åç§°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> product_info (<br>    id NUMBER,<br>    name VARCHAR2(<span class="hljs-number">100</span>),<br>    price NUMBER<br>)<br>PARALLEL <span class="hljs-number">4</span><br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> product_id,<br>       product_name,<br>       list_price<br><span class="hljs-keyword">FROM</span> products;<br></code></pre></td></tr></table></figure><ul><li>TRUNCATE table ï¼šæ¸…ç©ºè¡¨æ•°æ®è¯­å¥ï¼ˆæ…ç”¨â­ï¸ï¼‰</li><li>ä¿®æ”¹è¡¨å­—æ®µå‘½ä»¤ï¼ˆæœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼‰</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"> <span class="hljs-comment">/*ä¿®æ”¹åŸå­—æ®µånameä¸ºname_tmp*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM rename <span class="hljs-keyword">column</span> EII_ID <span class="hljs-keyword">to</span> EII_ID_T;<br><span class="hljs-comment">/*å¢åŠ ä¸€ä¸ªå’ŒåŸå­—æ®µååŒåçš„å­—æ®µname*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM <span class="hljs-keyword">add</span> EII_ID varchar2(<span class="hljs-number">50</span>);<br><span class="hljs-comment">/*å°†åŸå­—æ®µname_tmpæ•°æ®æ›´æ–°åˆ°å¢åŠ çš„å­—æ®µname*/</span><br><span class="hljs-keyword">update</span> MO_ENTITY_INVOICE_ITEM  <span class="hljs-keyword">set</span> EII_ID<span class="hljs-operator">=</span><span class="hljs-built_in">trim</span>(EII_ID_T);<br><span class="hljs-comment">/*æ›´æ–°å®Œï¼Œåˆ é™¤åŸå­—æ®µname_tmp*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM <span class="hljs-keyword">drop</span> <span class="hljs-keyword">column</span> EII_ID_T<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>oracle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>oracleå°æŠ€å·§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatisæºç è§£æ</title>
    <link href="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="MyBatisæºç è§£æ"><a href="#MyBatisæºç è§£æ" class="headerlink" title="MyBatisæºç è§£æ"></a>MyBatisæºç è§£æ</h1><h2 id="MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ"></a>MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>MyBatisæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œæ”¯æŒ<strong>å®šåˆ¶åŒ–SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„</strong>ã€‚MyBatisé¿å…äº†å‡ ä¹æ‰€æœ‰çš„jdbcä»£ç å’Œæ‰‹åŠ¨è®¾ç½®å‚æ•°å’Œè·å–ç»“æœé›†ã€‚</p><h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ</h2><p>1ã€å‡è½»jdbcå¤æ‚æ€§ï¼Œä¸ç”¨ç¼–å†™é‡å¤çš„ä»£ç </p><p>2ã€å¤„ç†ç®€å•ï¼Œè®©å¼€å‘è€…æ›´åŠ ä¸“æ³¨sqlçš„å¤„ç†</p><h2 id="MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨"><a href="#MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨" class="headerlink" title="MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨"></a>MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨</h2><h3 id="æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰"><a href="#æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰" class="headerlink" title="æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰"></a>æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰</h3><ul><li>SimpleExecutorï¼šæ™®é€šæ‰§è¡Œå™¨</li><li>ReuseExecutorï¼šé‡å¤åˆ©ç”¨æ‰§è¡Œå™¨</li><li>BatchExecutorï¼šæ‰¹å¤„ç†æ‰§è¡Œå™¨</li></ul><h3 id="å¤„ç†å™¨ï¼ˆHandlerï¼‰"><a href="#å¤„ç†å™¨ï¼ˆHandlerï¼‰" class="headerlink" title="å¤„ç†å™¨ï¼ˆHandlerï¼‰"></a>å¤„ç†å™¨ï¼ˆHandlerï¼‰</h3><ul><li>SimpleStatementHandlerï¼šæ™®é€šå¤„ç†å™¨</li><li>PrepareStatementHandlerï¼šé¢„ç¼–è¯‘å¤„ç†å™¨</li><li>CallableStatementHandlerï¼šå­˜å‚¨è¿‡ç¨‹å¤„ç†å™¨</li></ul><h2 id="Mybatisç¼“å­˜"><a href="#Mybatisç¼“å­˜" class="headerlink" title="Mybatisç¼“å­˜"></a>Mybatisç¼“å­˜</h2><h3 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h3><p>mybatisä¸€çº§ç¼“å­˜ä¸­æœ‰ä¸¤ç§çº§åˆ«ï¼Œsessionçº§åˆ«å’Œstatementçº§åˆ«ï¼Œsessionçº§åˆ«çš„ä¸€çº§ç¼“å­˜å¯èƒ½ä¼šå‡ºç°è„è¯»çš„æƒ…å†µï¼Œæ‰€ä»¥æ¨èä½¿ç”¨statementçº§åˆ«ã€‚</p><p>1.å¼€å¯ä¸€çº§ç¼“å­˜ï¼Œç¼“å­˜çº§åˆ«æ˜¯sessionçº§åˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœï¼šèµ°äº†ä¸€çº§ç¼“å­˜</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729171834220.png" alt="image-20250729171834220"></p><p>2.å¼€å¯ä¸€çº§ç¼“å­˜ï¼ŒSESSIONçº§åˆ«ç¼“å­˜ï¼Œä¸­é—´æœ‰æ›´æ–°æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    studentMapper.updateById(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;ææ–¯&quot;</span>);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœï¼šæ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œä¸€çº§ç¼“å­˜å¤±æ•ˆ</p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729172019023.png" alt="image-20250729172019023" style="zoom:150%;"><p>3.å¼€å¯ä¸¤ä¸ªsessionä¼šè¯ï¼Œå…¶ä¸­ä¸€ä¸ªä¼šè¯æ›´æ”¹æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest3</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">sm1</span> <span class="hljs-operator">=</span> sqlSession1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> sqlSession2.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student1:&#123;&#125;&quot;</span>, sm1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student2:&#123;&#125;&quot;</span>, sm2.queryById(<span class="hljs-number">1</span>));<br><br>    sm1.updateById(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;å‘¨äº”&quot;</span>);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student1:&#123;&#125;&quot;</span>, sm1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student2:&#123;&#125;&quot;</span>, sm2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœï¼šä¸¤ä¸ªsessionä¼šè¯äº’ä¸å½±å“ï¼Œsession1æ‰§è¡Œæ›´æ”¹æ“ä½œåï¼Œä¸€çº§ç¼“å­˜å¤±æ•ˆï¼Œsession2è¿˜æ˜¯æ­£å¸¸èµ°ä¸€çº§ç¼“å­˜ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå‡ºç°è„è¯»æƒ…å†µã€‚</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729172517955.png" alt="image-20250729172517955"></p><h3 id="äºŒçº§ç¼“å­˜"><a href="#äºŒçº§ç¼“å­˜" class="headerlink" title="äºŒçº§ç¼“å­˜"></a>äºŒçº§ç¼“å­˜</h3><p>å¼€å¯äºŒçº§ç¼“å­˜</p><p>1.å¼€å¯äºŒçº§ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;setting name=<span class="hljs-string">&quot;cacheEnabled&quot;</span> value=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>2.mapperæ–‡ä»¶ä¸­åŠ å…¥äºŒçº§ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;cache/&gt;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨cache-refæ ‡ç­¾è¡¨ç¤ºå¼•ç”¨åˆ«çš„å‘½åç©ºè§çš„cacheé…ç½®ï¼Œä¸¤ä¸ªå‘½åç©ºè§çš„æ“ä½œä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªcache.</strong></p><blockquote><p>ğŸŒˆæ³¨æ„ï¼šä½†æ˜¯ä¸€ä¸ªå‘½ä»¤ç©ºé—´çš„é…ç½®æ–‡ä»¶åƒä¸‡ä¸è¦åŒæ—¶é…ç½®cacheå’Œcache-refä¸¤ä¸ªæ ‡ç­¾ï¼Œå› ä¸ºä¼šæ ¹æ®åŠ è½½é¡ºåºçš„é—®é¢˜å¯¼è‡´ç‹¬äº«ç¼“å­˜è¿˜æ˜¯å…±äº«ç¼“å­˜ä¸ä¸€å®šï¼ï¼ï¼</p></blockquote><p><strong>å®éªŒ1:</strong></p><p>æµ‹è¯•äºŒçº§ç¼“å­˜ï¼Œä¸æäº¤äº‹åŠ¡ï¼Œä¸¤ä¸ªæŸ¥è¯¢æ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">secondCacheTest1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper1</span> <span class="hljs-operator">=</span> s1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper2</span> <span class="hljs-operator">=</span> s2.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;======&gt; mapper1:&#123;&#125;&quot;</span>, mapper1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;======&gt; mapper2:&#123;&#125;&quot;</span>, mapper2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šmapper1äº‹åŠ¡æ²¡æœ‰æäº¤ï¼Œæ²¡æœ‰èµ°äºŒçº§ç¼“å­˜ã€‚</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804102540851.png" alt="image-äºŒçº§ç¼“å­˜æ²¡æœ‰æäº¤äº‹åŠ¡ç»“æœ"></p><p><strong>å®éªŒ2:</strong></p><p>æµ‹è¯•äºŒçº§ç¼“å­˜ï¼Œæäº¤äº‹åŠ¡ï¼Œä¸¤ä¸ªæŸ¥è¯¢æ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">secondCacheTest1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper1</span> <span class="hljs-operator">=</span> s1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper2</span> <span class="hljs-operator">=</span> s2.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;======&gt; mapper1:&#123;&#125;&quot;</span>, mapper1.queryById(<span class="hljs-number">1</span>));<br>    s1.commit();<br>    log.info(<span class="hljs-string">&quot;======&gt; mapper2:&#123;&#125;&quot;</span>, mapper2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šmapper1äº‹åŠ¡æäº¤åï¼Œèµ°äº†äºŒçº§ç¼“å­˜</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804102425743.png" alt="image-äºŒçº§ç¼“å­˜äº‹åŠ¡æäº¤åç»“æœ"></p><p><strong>å®éªŒ3:</strong></p><p>ä¸¤ä¸ªå®ä½“ï¼Œä¸ä½¿ç”¨cache-refçš„æƒ…å†µä¸‹ï¼Œæ›´æ”¹å…¶ä¸­ä¸€ä¸ªå®ä½“çš„å±æ€§åæäº¤ï¼Œæ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">secondCacheTest2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session3</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> session1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper2</span> <span class="hljs-operator">=</span> session2.getMapper(StudentMapper.class);<br>    <span class="hljs-type">OrderMapper</span> <span class="hljs-variable">orderMapper</span> <span class="hljs-operator">=</span> session3.getMapper(OrderMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;=====&gt; studentMapper:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    session1.close();<br>    log.info(<span class="hljs-string">&quot;=====&gt; studentMapper:&#123;&#125;&quot;</span>, studentMapper2.queryById(<span class="hljs-number">1</span>));<br><br>    orderMapper.updateById(<span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>));<br>    session3.commit();<br>    log.info(<span class="hljs-string">&quot;=====&gt; studentMapper:&#123;&#125;&quot;</span>, studentMapper2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šä¸ä½¿ç”¨cache-refçš„æƒ…å†µä¸‹ï¼Œå³ä½¿åšäº†æ›´æ–°æ“ä½œå¹¶æäº¤ï¼Œä¹Ÿä¼šç»§ç»­èµ°ç¼“å­˜ï¼ï¼ï¼</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804105633154.png" alt="image-äºŒçº§ç¼“å­˜æ²¡æœ‰ä½¿ç”¨cache-ref"></p><p><strong>å®éªŒ4:</strong></p><p>ä¸¤ä¸ªå®ä½“ï¼Œåœ¨å®ä½“çš„é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨cache-refçš„æƒ…å†µä¸‹ï¼Œæ›´æ”¹å…¶ä¸­ä¸€ä¸ªå®ä½“çš„å±æ€§åæäº¤ï¼Œæ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿ</p><p>ç»“è®ºï¼šä½¿ç”¨cache-refæ ‡ç­¾åï¼Œå°†ä¸¤ä¸ªå®ä½“åˆå¹¶æˆä¸€ä¸ªcacheï¼Œæ‰€ä»¥æœ‰æ›´æ–°æ“ä½œåï¼Œä¸ä¼šå†èµ°ç¼“å­˜ã€‚</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804105935423.png" alt="image-äºŒçº§ç¼“å­˜ä½¿ç”¨äº†cache-ref"></p><blockquote><p>ğŸŒˆæ³¨æ„ï¼šä½¿ç”¨cache-refçš„åæœå°±æ˜¯ç¼“å­˜çš„ç²’åº¦å˜ç²—äº†ï¼Œå¤šä¸ªmapperä¸‹çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šå¯¹ç¼“å­˜ä½¿ç”¨é€ æˆå½±å“ã€‚</p></blockquote><h2 id="MyBatisè§£æé…ç½®æ–‡ä»¶"><a href="#MyBatisè§£æé…ç½®æ–‡ä»¶" class="headerlink" title="MyBatisè§£æé…ç½®æ–‡ä»¶"></a>MyBatisè§£æé…ç½®æ–‡ä»¶</h2><h2 id="äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ"><a href="#äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ" class="headerlink" title="äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ"></a>äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ</h2><h3 id="1ã€mybatisè‡ªåŠ¨é…ç½®ç±»-MybatisAutoConfiguration"><a href="#1ã€mybatisè‡ªåŠ¨é…ç½®ç±»-MybatisAutoConfiguration" class="headerlink" title="1ã€mybatisè‡ªåŠ¨é…ç½®ç±» MybatisAutoConfiguration"></a>1ã€mybatisè‡ªåŠ¨é…ç½®ç±» MybatisAutoConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.springframework.context.annotation.Configuration<br><span class="hljs-meta">@ConditionalOnClass(&#123; SqlSessionFactory.class, SqlSessionFactoryBean.class &#125;)</span><br><span class="hljs-meta">@ConditionalOnSingleCandidate(DataSource.class)</span><br><span class="hljs-meta">@EnableConfigurationProperties(MybatisProperties.class)</span><br><span class="hljs-meta">@AutoConfigureAfter(&#123; DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisAutoConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(MybatisAutoConfiguration.class);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MybatisProperties properties;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Interceptor[] interceptors;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandler[] typeHandlers;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LanguageDriver[] languageDrivers;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DatabaseIdProvider databaseIdProvider;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ConfigurationCustomizer&gt; configurationCustomizers;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MybatisAutoConfiguration</span><span class="hljs-params">(MybatisProperties properties, ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br><span class="hljs-params">      ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider, ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br><span class="hljs-params">      ResourceLoader resourceLoader, ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br><span class="hljs-params">      ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider)</span> &#123;<br>    <span class="hljs-built_in">this</span>.properties = properties;<br>    <span class="hljs-built_in">this</span>.interceptors = interceptorsProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.typeHandlers = typeHandlersProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.languageDrivers = languageDriversProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;<br>    <span class="hljs-built_in">this</span>.databaseIdProvider = databaseIdProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.configurationCustomizers = configurationCustomizersProvider.getIfAvailable();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>    checkConfigFileExists();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkConfigFileExists</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.resourceLoader.getResource(<span class="hljs-built_in">this</span>.properties.getConfigLocation());<br>      Assert.state(resource.exists(),<br>          <span class="hljs-string">&quot;Cannot find config location: &quot;</span> + resource + <span class="hljs-string">&quot; (please add config file or check your Mybatis configuration)&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">sqlSessionFactory</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">SqlSessionFactoryBean</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBean</span>();<br>    factory.setDataSource(dataSource);<br>    factory.setVfs(SpringBootVFS.class);<br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      factory.setConfigLocation(<span class="hljs-built_in">this</span>.resourceLoader.getResource(<span class="hljs-built_in">this</span>.properties.getConfigLocation()));<br>    &#125;<br>    applyConfiguration(factory);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.getConfigurationProperties() != <span class="hljs-literal">null</span>) &#123;<br>      factory.setConfigurationProperties(<span class="hljs-built_in">this</span>.properties.getConfigurationProperties());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.interceptors)) &#123;<br>      factory.setPlugins(<span class="hljs-built_in">this</span>.interceptors);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.databaseIdProvider != <span class="hljs-literal">null</span>) &#123;<br>      factory.setDatabaseIdProvider(<span class="hljs-built_in">this</span>.databaseIdProvider);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasLength(<span class="hljs-built_in">this</span>.properties.getTypeAliasesPackage())) &#123;<br>      factory.setTypeAliasesPackage(<span class="hljs-built_in">this</span>.properties.getTypeAliasesPackage());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.getTypeAliasesSuperType() != <span class="hljs-literal">null</span>) &#123;<br>      factory.setTypeAliasesSuperType(<span class="hljs-built_in">this</span>.properties.getTypeAliasesSuperType());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasLength(<span class="hljs-built_in">this</span>.properties.getTypeHandlersPackage())) &#123;<br>      factory.setTypeHandlersPackage(<span class="hljs-built_in">this</span>.properties.getTypeHandlersPackage());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.typeHandlers)) &#123;<br>      factory.setTypeHandlers(<span class="hljs-built_in">this</span>.typeHandlers);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.properties.resolveMapperLocations())) &#123;<br>      factory.setMapperLocations(<span class="hljs-built_in">this</span>.properties.resolveMapperLocations());<br>    &#125;<br>    Set&lt;String&gt; factoryPropertyNames = Stream<br>        .of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>(SqlSessionFactoryBean.class).getPropertyDescriptors()).map(PropertyDescriptor::getName)<br>        .collect(Collectors.toSet());<br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LanguageDriver</span>&gt; defaultLanguageDriver = <span class="hljs-built_in">this</span>.properties.getDefaultScriptingLanguageDriver();<br>    <span class="hljs-keyword">if</span> (factoryPropertyNames.contains(<span class="hljs-string">&quot;scriptingLanguageDrivers&quot;</span>) &amp;&amp; !ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.languageDrivers)) &#123;<br>      <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>      factory.setScriptingLanguageDrivers(<span class="hljs-built_in">this</span>.languageDrivers);<br>      <span class="hljs-keyword">if</span> (defaultLanguageDriver == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.languageDrivers.length == <span class="hljs-number">1</span>) &#123;<br>        defaultLanguageDriver = <span class="hljs-built_in">this</span>.languageDrivers[<span class="hljs-number">0</span>].getClass();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (factoryPropertyNames.contains(<span class="hljs-string">&quot;defaultScriptingLanguageDriver&quot;</span>)) &#123;<br>      <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>      factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> factory.getObject();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyConfiguration</span><span class="hljs-params">(SqlSessionFactoryBean factory)</span> &#123;<br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.properties.getConfiguration();<br>    <span class="hljs-keyword">if</span> (configuration == <span class="hljs-literal">null</span> &amp;&amp; !StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      configuration = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (configuration != <span class="hljs-literal">null</span> &amp;&amp; !CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.configurationCustomizers)) &#123;<br>      <span class="hljs-keyword">for</span> (ConfigurationCustomizer customizer : <span class="hljs-built_in">this</span>.configurationCustomizers) &#123;<br>        customizer.customize(configuration);<br>      &#125;<br>    &#125;<br>    factory.setConfiguration(configuration);<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean</span><br>  <span class="hljs-keyword">public</span> SqlSessionTemplate <span class="hljs-title function_">sqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory)</span> &#123;<br>    <span class="hljs-type">ExecutorType</span> <span class="hljs-variable">executorType</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.properties.getExecutorType();<br>    <span class="hljs-keyword">if</span> (executorType != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sqlSessionFactory, executorType);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sqlSessionFactory);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * This will just scan the same base package as Spring Boot does. If you want more power, you can explicitly use</span><br><span class="hljs-comment">   * &#123;<span class="hljs-doctag">@link</span> org.mybatis.spring.annotation.MapperScan&#125; but this will get typed mappers working correctly, out-of-the-box,</span><br><span class="hljs-comment">   * similar to using Spring Data JPA repositories.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfiguredMapperScannerRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryAware</span>, ImportBeanDefinitionRegistrar &#123;<br><br>    <span class="hljs-keyword">private</span> BeanFactory beanFactory;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br><br>      <span class="hljs-keyword">if</span> (!AutoConfigurationPackages.has(<span class="hljs-built_in">this</span>.beanFactory)) &#123;<br>        logger.debug(<span class="hljs-string">&quot;Could not determine auto-configuration package, automatic mapper scanning disabled.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br><br>      logger.debug(<span class="hljs-string">&quot;Searching for mappers annotated with @Mapper&quot;</span>);<br><br>      List&lt;String&gt; packages = AutoConfigurationPackages.get(<span class="hljs-built_in">this</span>.beanFactory);<br>      <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>        packages.forEach(pkg -&gt; logger.debug(<span class="hljs-string">&quot;Using auto-configuration base package &#x27;&#123;&#125;&#x27;&quot;</span>, pkg));<br>      &#125;<br><br>      <span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;processPropertyPlaceHolders&quot;</span>, <span class="hljs-literal">true</span>);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;annotationClass&quot;</span>, Mapper.class);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;basePackage&quot;</span>, StringUtils.collectionToCommaDelimitedString(packages));<br>      <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">beanWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>(MapperScannerConfigurer.class);<br>      Stream.of(beanWrapper.getPropertyDescriptors())<br>          <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>          .filter(x -&gt; x.getName().equals(<span class="hljs-string">&quot;lazyInitialization&quot;</span>)).findAny()<br>          .ifPresent(x -&gt; builder.addPropertyValue(<span class="hljs-string">&quot;lazyInitialization&quot;</span>, <span class="hljs-string">&quot;$&#123;mybatis.lazy-initialization:false&#125;&quot;</span>));<br>      registry.registerBeanDefinition(MapperScannerConfigurer.class.getName(), builder.getBeanDefinition());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanFactory</span><span class="hljs-params">(BeanFactory beanFactory)</span> &#123;<br>      <span class="hljs-built_in">this</span>.beanFactory = beanFactory;<br>    &#125;<br><br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * If mapper registering configuration or mapper scanning configuration not present, this configuration allow to scan</span><br><span class="hljs-comment">   * mappers based on the same component-scanning path as Spring Boot itself.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@org</span>.springframework.context.annotation.Configuration<br>  <span class="hljs-meta">@Import(AutoConfiguredMapperScannerRegistrar.class)</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean(&#123; MapperFactoryBean.class, MapperScannerConfigurer.class &#125;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerRegistrarNotFoundConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>      logger.debug(<br>          <span class="hljs-string">&quot;Not found configuration for registering mapper bean using @MapperScan, MapperFactoryBean and MapperScannerConfigurer.&quot;</span>);<br>    &#125;<br><br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹ä¸€ä¸‹MybatisAutoConfigurationç±»ä¸Šçš„å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p>@org.springframework.context.annotation.Configurationï¼šè¯¥æ³¨è§£è¡¨æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è§£æåŠ è½½ï¼Œç”ŸæˆBeanå¯¹è±¡æ”¾å…¥å®¹å™¨ä¸­</p><ul><li>å±æ€§å€¼1ï¼švalueï¼šæ³¨å…¥å®¹å™¨ä¸­çš„Beanåç§°ï¼ˆä¸èµ‹å€¼é»˜è®¤å°é©¼å³°ç±»åç§°ï¼‰</li><li>å±æ€§å€¼2ï¼šproxyBeanMethodsï¼šæ˜¯å¦å•ä¾‹ï¼ˆé»˜è®¤trueï¼‰</li></ul></li><li><p>@ConditionalOnClass({ SqlSessionFactory.class, SqlSessionFactoryBean.class })ï¼šç±»æ¡ä»¶åˆ¤æ–­ï¼Œå½“æœ‰SqlSessionFactoryç±»å’ŒSqlSessionFactoryBeanç±»ï¼Œä¸¤ä¸ªç±»åŒæ—¶å­˜åœ¨æ—¶åŠ è½½</p></li><li><p>@ConditionalOnSingleCandidate(DataSource.class)ï¼šå•ä¾‹æ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªç±»å‹çš„DataSourceçš„Beanå®šä¹‰æ—¶æ‰åŠ è½½</p></li><li><p>@EnableConfigurationProperties(MybatisProperties.class)ï¼šåŠ è½½mybatiså±æ€§å€¼</p></li><li><p>@AutoConfigureAfter({ DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class })ï¼šå…ˆå®Œæˆä¸¤ä¸ªé…ç½®ç±»åŠ è½½åå†åŠ è½½ï¼Œå…ˆåé¡ºåºåŠ è½½åˆ¤æ–­</p></li></ul><p>æ ¹æ®æ¡ä»¶æ³¨è§£åˆ¤æ–­åŠ è½½Beanï¼š</p><ul><li>sqlSessionFactoryï¼šsessionå·¥åœº</li><li>sqlSessionTemplateï¼šsessionæ¨¡æ¿æ–¹æ³•ï¼Œsessionå®‰å…¨å¤„ç†å’Œäº‹åŠ¡ç®¡ç†</li><li>mapperScannerRegistrarNotFoundConfigurationï¼šæ²¡æœ‰MapperFactoryBeanå’ŒMapperScannerConfigurerä¸¤ä¸ªBeanæ—¶åŠ è½½ï¼ŒåŒæ—¶å¼•å…¥AutoConfiguredMapperSannerRegistraræ³¨å†Œç±»ã€‚<ul><li><strong>å½“åˆ¤æ–­@ConditionalOnMissingBeanæ¡ä»¶ç±»æ˜¯å¦æ»¡è¶³ï¼Œæ»¡è¶³æ‰ä¼šæ‰§è¡Œ@Importæ³¨è§£å¼•å…¥çš„æ³¨å†Œç±»ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œå¼•å…¥æ³¨å†Œç±»</strong></li><li><strong>å¦‚æœæ²¡æœ‰ä½¿ç”¨@MapperScanæ³¨è§£å’Œæ‰‹åŠ¨é…ç½®è¿‡MapperFactoryBeanã€MapperScannerConfigureré…ç½®ï¼Œä¼šè‡ªåŠ¨æ‰«æå¯åŠ¨ç±»æ‰€åœ¨åŒ…è·¯å¾„</strong></li><li>mapperScannerRegistrarNotFoundConfigurationé…ç½®ä¸­å¼•å…¥äº†AutoConfiguredMapperScannerRegistraræ³¨å†Œå™¨ï¼Œè¯¥ç±»å®ç°äº†ImportBeanDefinitionRegistraræ¥å£ï¼Œåœ¨å®¹å™¨å¯åŠ¨æ—¶ä¼šæ‰§è¡ŒregisterBeanDefinitionsæ–¹æ³•</li><li>è¿™ä¸ªæ³¨å†Œå™¨ä¸­ä¼šæ³¨å…¥MapperScannerConfigurerçš„BeanDifinitionè¿›è¡Œæ³¨å†Œ</li></ul></li></ul><h3 id="2ã€MapperScannerConfigurer-æ‰«æmapperé…ç½®ç±»"><a href="#2ã€MapperScannerConfigurer-æ‰«æmapperé…ç½®ç±»" class="headerlink" title="2ã€MapperScannerConfigurer æ‰«æmapperé…ç½®ç±»"></a>2ã€MapperScannerConfigurer æ‰«æmapperé…ç½®ç±»</h3><p>MapperScannerConfigurerç±»å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£ï¼Œè€ŒBeanDefinitionRegistryPostProcessoræ¥å£ç»§æ‰¿äº†BeanFactoryPostProcessæ¥å£ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.processPropertyPlaceHolders) &#123;<br>    processPropertyPlaceHolders();<br>  &#125;<br><br>  <span class="hljs-type">ClassPathMapperScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);<br>  scanner.setAddToConfig(<span class="hljs-built_in">this</span>.addToConfig);<br>  scanner.setAnnotationClass(<span class="hljs-built_in">this</span>.annotationClass);<br>  scanner.setMarkerInterface(<span class="hljs-built_in">this</span>.markerInterface);<br>  scanner.setSqlSessionFactory(<span class="hljs-built_in">this</span>.sqlSessionFactory);<br>  scanner.setSqlSessionTemplate(<span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>  scanner.setSqlSessionFactoryBeanName(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName);<br>  scanner.setSqlSessionTemplateBeanName(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName);<br>  scanner.setResourceLoader(<span class="hljs-built_in">this</span>.applicationContext);<br>  scanner.setBeanNameGenerator(<span class="hljs-built_in">this</span>.nameGenerator);<br>  scanner.setMapperFactoryBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br>  <span class="hljs-keyword">if</span> (StringUtils.hasText(lazyInitialization)) &#123;<br>    scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));<br>  &#125;<br>  scanner.registerFilters();<br>  <span class="hljs-comment">// æ‰«æmapperæ¥å£æ–¹æ³•</span><br>  scanner.scan(<br>      StringUtils.tokenizeToStringArray(<span class="hljs-built_in">this</span>.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œæ‰«æçš„æ–¹æ³•æ˜¯ClassPathMapperScanner#doScanæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>  <span class="hljs-comment">// æ‰§è¡Œçš„æ˜¯çˆ¶ç±»ClassPathBeanDefinitionScannerç±»ä¸­çš„æ‰«ææ–¹æ³•</span><br>  Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-built_in">super</span>.doScan(basePackages);<br><br>  <span class="hljs-keyword">if</span> (beanDefinitions.isEmpty()) &#123;<br>    LOGGER.warn(() -&gt; <span class="hljs-string">&quot;No MyBatis mapper was found in &#x27;&quot;</span> + Arrays.toString(basePackages)<br>        + <span class="hljs-string">&quot;&#x27; package. Please check your configuration.&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å°†mapperæ¥å£æ–¹æ³•å…¨éƒ½å˜æˆMapperFactoryBeanå·¥å‚å¯¹è±¡</span><br>    processBeanDefinitions(beanDefinitions);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> beanDefinitions;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰«ææŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰mapperæ¥å£åï¼Œæ‰§è¡Œbeanå®šä¹‰ä¿¡æ¯å¤„ç†å™¨æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MapperFactoryBean</span>&gt; mapperFactoryBeanClass = MapperFactoryBean.class;<br><br><span class="hljs-comment">// ===================&gt; æ‰§è¡Œbeanå®šä¹‰ä¿¡æ¯å¤„ç†å™¨ &lt;====================</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinitions</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> &#123;<br>  GenericBeanDefinition definition;<br>  <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;<br>    definition = (GenericBeanDefinition) holder.getBeanDefinition();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">beanClassName</span> <span class="hljs-operator">=</span> definition.getBeanClassName();<br>    LOGGER.debug(() -&gt; <span class="hljs-string">&quot;Creating MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + beanClassName<br>        + <span class="hljs-string">&quot;&#x27; mapperInterface&quot;</span>);<br><br>    <span class="hljs-comment">// the mapper interface is the original class of the bean</span><br>    <span class="hljs-comment">// but, the actual class of the bean is MapperFactoryBean</span><br>    definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName); <span class="hljs-comment">// issue #59</span><br>    <br>    <span class="hljs-comment">// ================&gt; å°†æ‰«æå‡ºæ¥çš„mapperå®šä¹‰ä¿¡æ¯è®¾ç½®æˆmapperFactoryBean &lt;==================</span><br>    definition.setBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br><br>    definition.getPropertyValues().add(<span class="hljs-string">&quot;addToConfig&quot;</span>, <span class="hljs-built_in">this</span>.addToConfig);<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">explicitFactoryUsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName)) &#123;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName));<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionFactory != <span class="hljs-literal">null</span>) &#123;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionFactory);<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName)) &#123;<br>      <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>        LOGGER.warn(<br>            () -&gt; <span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>      &#125;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName));<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionTemplate != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>        LOGGER.warn(<br>            () -&gt; <span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>      &#125;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!explicitFactoryUsed) &#123;<br>      LOGGER.debug(() -&gt; <span class="hljs-string">&quot;Enabling autowire by type for MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>      definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);<br>    &#125;<br>    definition.setLazyInit(lazyInitialization);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨AbstractBeanFactory#doGetBeanæ–¹æ³•ä¸­ï¼Œè·å–åˆ°mapperæ¥å£å¯¹åº”çš„mapperFactoryBeanå·¥å‚å¯¹è±¡åï¼Œæ ¹æ®å·¥å‚å¯¹è±¡åˆ›å»ºmapperProxyä»£ç†å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br>    <span class="hljs-comment">// æ ¹æ®å·¥å‚å¯¹è±¡è·å–å¯¹è±¡</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸šåŠ¡æ–¹æ³•æ­£å¼è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StudentService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StudentDao studentDao;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">queryById</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student1</span> <span class="hljs-operator">=</span> studentDao.queryById(id);<br>        studentDao.updateById(String.valueOf(id), <span class="hljs-string">&quot;å¼ ä¸‰222&quot;</span>);<br>        <span class="hljs-keyword">return</span> student1;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151230617.png" alt="image-20250531151230617"></p><p>æ³¨å…¥çš„beanå¯¹è±¡æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šè¿›å…¥åˆ°MapperProxyä»£ç†ç±»ä¸­çš„invokeæ–¹æ³•ä¸­ï¼Œç„¶åè¿›å…¥åˆ°MapperMethodç±»ä¸­ã€‚</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151601515.png" alt="image-20250531151601515"></p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151739625.png" alt="image-20250531151739625"></p>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
