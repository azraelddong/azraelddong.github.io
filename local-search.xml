<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>english</title>
    <link href="/2025/07/25/english/"/>
    <url>/2025/07/25/english/</url>
    
    <content type="html"><![CDATA[<p>2025.7.25</p><ul><li><strong>exhaust</strong> <ul><li>vt. 耗尽，排空</li><li>n. 废气，排气</li></ul></li></ul><p>e.g：Sometimes parents get exhausted and frustrated（垂头丧气，沮丧） and are unable to maintain a tolerate（容忍） and composed（冷静） style with their kids.</p><p>exhaust pipe：排气管</p><p>exhaust system：排气系统</p><p>exhaust fan：抽风机</p><p>exhaust gas：废气</p><ul><li><strong>hijack</strong><ul><li>v. 劫持，操纵</li><li>n. 劫持；敲诈</li></ul></li></ul><p>e.g The masked man hijack the boy.</p><p>hijack an airplane：劫机</p><ul><li><strong>republican</strong><ul><li>adj. 共和国的，共和党的</li><li>n. 共和党员</li></ul></li></ul><p>e.g Ancient Rome had a republican form of govement.</p>]]></content>
    
    
    <categories>
      
      <category>英语</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考验英语</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>oracle-tools</title>
    <link href="/2025/07/22/oracle-tools/"/>
    <url>/2025/07/22/oracle-tools/</url>
    
    <content type="html"><![CDATA[<h1 id="oracle小技巧"><a href="#oracle小技巧" class="headerlink" title="oracle小技巧"></a>oracle小技巧</h1><p>在oracle中，有一些命令执行效率非常高</p><ul><li>inset int ….. select … from table：将查询表的数据直接插入到对应表中</li></ul><p>实测备份库25w左右的数据（包含大字段），执行上面的命令花费不到10s的时间，可以有效进行表之间的数据备份</p><ul><li>CREATE TABLE … AS SELECT … ：创建表并备份数据</li></ul><p>创建表和字段名称来备份查询的数据库表数据，效率提升非常高</p><p>1.简单表备份</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> employees_copy<br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> employees;<br></code></pre></td></tr></table></figure><p>2.备份部分数据并使用并行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> recent_orders<br>PARALLEL <span class="hljs-number">8</span><br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> orders<br><span class="hljs-keyword">WHERE</span> order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-type">DATE</span> <span class="hljs-string">&#x27;2023-01-01&#x27;</span>;<br></code></pre></td></tr></table></figure><p>3.创建表并自定义列名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> product_info (<br>    id NUMBER,<br>    name VARCHAR2(<span class="hljs-number">100</span>),<br>    price NUMBER<br>)<br>PARALLEL <span class="hljs-number">4</span><br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> product_id,<br>       product_name,<br>       list_price<br><span class="hljs-keyword">FROM</span> products;<br></code></pre></td></tr></table></figure><ul><li>TRUNCATE table ：清空表数据语句（慎用⭐️）</li><li>修改表字段命令（有数据的情况下）</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"> <span class="hljs-comment">/*修改原字段名name为name_tmp*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM rename <span class="hljs-keyword">column</span> EII_ID <span class="hljs-keyword">to</span> EII_ID_T;<br><span class="hljs-comment">/*增加一个和原字段名同名的字段name*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM <span class="hljs-keyword">add</span> EII_ID varchar2(<span class="hljs-number">50</span>);<br><span class="hljs-comment">/*将原字段name_tmp数据更新到增加的字段name*/</span><br><span class="hljs-keyword">update</span> MO_ENTITY_INVOICE_ITEM  <span class="hljs-keyword">set</span> EII_ID<span class="hljs-operator">=</span><span class="hljs-built_in">trim</span>(EII_ID_T);<br><span class="hljs-comment">/*更新完，删除原字段name_tmp*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM <span class="hljs-keyword">drop</span> <span class="hljs-keyword">column</span> EII_ID_T<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>oracle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>oracle小技巧</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis源码解析</title>
    <link href="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="MyBatis源码解析"><a href="#MyBatis源码解析" class="headerlink" title="MyBatis源码解析"></a>MyBatis源码解析</h1><h2 id="MyBatis是什么？"><a href="#MyBatis是什么？" class="headerlink" title="MyBatis是什么？"></a>MyBatis是什么？</h2><p>MyBatis是一款优秀的持久层框架，支持<strong>定制化SQL、存储过程以及高级映射</strong>。MyBatis避免了几乎所有的jdbc代码和手动设置参数和获取结果集。</p><h2 id="为什么要使用MyBatis？"><a href="#为什么要使用MyBatis？" class="headerlink" title="为什么要使用MyBatis？"></a>为什么要使用MyBatis？</h2><p>1、减轻jdbc复杂性，不用编写重复的代码</p><p>2、处理简单，让开发者更加专注sql的处理</p><h2 id="MYBATIS执行器和处理器"><a href="#MYBATIS执行器和处理器" class="headerlink" title="MYBATIS执行器和处理器"></a>MYBATIS执行器和处理器</h2><h3 id="执行器（Executor）"><a href="#执行器（Executor）" class="headerlink" title="执行器（Executor）"></a>执行器（Executor）</h3><ul><li>SimpleExecutor：普通执行器</li><li>ReuseExecutor：重复利用执行器</li><li>BatchExecutor：批处理执行器</li></ul><h3 id="处理器（Handler）"><a href="#处理器（Handler）" class="headerlink" title="处理器（Handler）"></a>处理器（Handler）</h3><ul><li>SimpleStatementHandler：普通处理器</li><li>PrepareStatementHandler：预编译处理器</li><li>CallableStatementHandler：存储过程处理器</li></ul><h2 id="Mybatis缓存"><a href="#Mybatis缓存" class="headerlink" title="Mybatis缓存"></a>Mybatis缓存</h2><h3 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h3><p>mybatis一级缓存中有两种级别，session级别和statement级别，session级别的一级缓存可能会出现脏读的情况，所以推荐使用statement级别。</p><p>1.开启一级缓存，缓存级别是session级别</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>结果：走了一级缓存</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729171834220.png" alt="image-20250729171834220"></p><p>2.开启一级缓存，SESSION级别缓存，中间有更新操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    studentMapper.updateById(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;李斯&quot;</span>);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>结果：执行更新操作后，一级缓存失效</p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729172019023.png" alt="image-20250729172019023" style="zoom:150%;"><p>3.开启两个session会话，其中一个会话更改操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest3</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">sm1</span> <span class="hljs-operator">=</span> sqlSession1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> sqlSession2.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student1:&#123;&#125;&quot;</span>, sm1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student2:&#123;&#125;&quot;</span>, sm2.queryById(<span class="hljs-number">1</span>));<br><br>    sm1.updateById(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;周五&quot;</span>);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student1:&#123;&#125;&quot;</span>, sm1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student2:&#123;&#125;&quot;</span>, sm2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>结果：两个session会话互不影响，session1执行更改操作后，一级缓存失效，session2还是正常走一级缓存，这种情况就会出现脏读情况。</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729172517955.png" alt="image-20250729172517955"></p><h3 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h3><h2 id="了解mybatis-spring-boot-starter实现原理源码解析"><a href="#了解mybatis-spring-boot-starter实现原理源码解析" class="headerlink" title="了解mybatis-spring-boot-starter实现原理源码解析"></a>了解mybatis-spring-boot-starter实现原理源码解析</h2><h3 id="1、mybatis自动配置类-MybatisAutoConfiguration"><a href="#1、mybatis自动配置类-MybatisAutoConfiguration" class="headerlink" title="1、mybatis自动配置类 MybatisAutoConfiguration"></a>1、mybatis自动配置类 MybatisAutoConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.springframework.context.annotation.Configuration<br><span class="hljs-meta">@ConditionalOnClass(&#123; SqlSessionFactory.class, SqlSessionFactoryBean.class &#125;)</span><br><span class="hljs-meta">@ConditionalOnSingleCandidate(DataSource.class)</span><br><span class="hljs-meta">@EnableConfigurationProperties(MybatisProperties.class)</span><br><span class="hljs-meta">@AutoConfigureAfter(&#123; DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisAutoConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(MybatisAutoConfiguration.class);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MybatisProperties properties;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Interceptor[] interceptors;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandler[] typeHandlers;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LanguageDriver[] languageDrivers;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DatabaseIdProvider databaseIdProvider;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ConfigurationCustomizer&gt; configurationCustomizers;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MybatisAutoConfiguration</span><span class="hljs-params">(MybatisProperties properties, ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br><span class="hljs-params">      ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider, ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br><span class="hljs-params">      ResourceLoader resourceLoader, ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br><span class="hljs-params">      ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider)</span> &#123;<br>    <span class="hljs-built_in">this</span>.properties = properties;<br>    <span class="hljs-built_in">this</span>.interceptors = interceptorsProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.typeHandlers = typeHandlersProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.languageDrivers = languageDriversProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;<br>    <span class="hljs-built_in">this</span>.databaseIdProvider = databaseIdProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.configurationCustomizers = configurationCustomizersProvider.getIfAvailable();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>    checkConfigFileExists();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkConfigFileExists</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.resourceLoader.getResource(<span class="hljs-built_in">this</span>.properties.getConfigLocation());<br>      Assert.state(resource.exists(),<br>          <span class="hljs-string">&quot;Cannot find config location: &quot;</span> + resource + <span class="hljs-string">&quot; (please add config file or check your Mybatis configuration)&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">sqlSessionFactory</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">SqlSessionFactoryBean</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBean</span>();<br>    factory.setDataSource(dataSource);<br>    factory.setVfs(SpringBootVFS.class);<br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      factory.setConfigLocation(<span class="hljs-built_in">this</span>.resourceLoader.getResource(<span class="hljs-built_in">this</span>.properties.getConfigLocation()));<br>    &#125;<br>    applyConfiguration(factory);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.getConfigurationProperties() != <span class="hljs-literal">null</span>) &#123;<br>      factory.setConfigurationProperties(<span class="hljs-built_in">this</span>.properties.getConfigurationProperties());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.interceptors)) &#123;<br>      factory.setPlugins(<span class="hljs-built_in">this</span>.interceptors);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.databaseIdProvider != <span class="hljs-literal">null</span>) &#123;<br>      factory.setDatabaseIdProvider(<span class="hljs-built_in">this</span>.databaseIdProvider);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasLength(<span class="hljs-built_in">this</span>.properties.getTypeAliasesPackage())) &#123;<br>      factory.setTypeAliasesPackage(<span class="hljs-built_in">this</span>.properties.getTypeAliasesPackage());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.getTypeAliasesSuperType() != <span class="hljs-literal">null</span>) &#123;<br>      factory.setTypeAliasesSuperType(<span class="hljs-built_in">this</span>.properties.getTypeAliasesSuperType());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasLength(<span class="hljs-built_in">this</span>.properties.getTypeHandlersPackage())) &#123;<br>      factory.setTypeHandlersPackage(<span class="hljs-built_in">this</span>.properties.getTypeHandlersPackage());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.typeHandlers)) &#123;<br>      factory.setTypeHandlers(<span class="hljs-built_in">this</span>.typeHandlers);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.properties.resolveMapperLocations())) &#123;<br>      factory.setMapperLocations(<span class="hljs-built_in">this</span>.properties.resolveMapperLocations());<br>    &#125;<br>    Set&lt;String&gt; factoryPropertyNames = Stream<br>        .of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>(SqlSessionFactoryBean.class).getPropertyDescriptors()).map(PropertyDescriptor::getName)<br>        .collect(Collectors.toSet());<br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LanguageDriver</span>&gt; defaultLanguageDriver = <span class="hljs-built_in">this</span>.properties.getDefaultScriptingLanguageDriver();<br>    <span class="hljs-keyword">if</span> (factoryPropertyNames.contains(<span class="hljs-string">&quot;scriptingLanguageDrivers&quot;</span>) &amp;&amp; !ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.languageDrivers)) &#123;<br>      <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>      factory.setScriptingLanguageDrivers(<span class="hljs-built_in">this</span>.languageDrivers);<br>      <span class="hljs-keyword">if</span> (defaultLanguageDriver == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.languageDrivers.length == <span class="hljs-number">1</span>) &#123;<br>        defaultLanguageDriver = <span class="hljs-built_in">this</span>.languageDrivers[<span class="hljs-number">0</span>].getClass();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (factoryPropertyNames.contains(<span class="hljs-string">&quot;defaultScriptingLanguageDriver&quot;</span>)) &#123;<br>      <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>      factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> factory.getObject();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyConfiguration</span><span class="hljs-params">(SqlSessionFactoryBean factory)</span> &#123;<br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.properties.getConfiguration();<br>    <span class="hljs-keyword">if</span> (configuration == <span class="hljs-literal">null</span> &amp;&amp; !StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      configuration = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (configuration != <span class="hljs-literal">null</span> &amp;&amp; !CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.configurationCustomizers)) &#123;<br>      <span class="hljs-keyword">for</span> (ConfigurationCustomizer customizer : <span class="hljs-built_in">this</span>.configurationCustomizers) &#123;<br>        customizer.customize(configuration);<br>      &#125;<br>    &#125;<br>    factory.setConfiguration(configuration);<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean</span><br>  <span class="hljs-keyword">public</span> SqlSessionTemplate <span class="hljs-title function_">sqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory)</span> &#123;<br>    <span class="hljs-type">ExecutorType</span> <span class="hljs-variable">executorType</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.properties.getExecutorType();<br>    <span class="hljs-keyword">if</span> (executorType != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sqlSessionFactory, executorType);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sqlSessionFactory);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * This will just scan the same base package as Spring Boot does. If you want more power, you can explicitly use</span><br><span class="hljs-comment">   * &#123;<span class="hljs-doctag">@link</span> org.mybatis.spring.annotation.MapperScan&#125; but this will get typed mappers working correctly, out-of-the-box,</span><br><span class="hljs-comment">   * similar to using Spring Data JPA repositories.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfiguredMapperScannerRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryAware</span>, ImportBeanDefinitionRegistrar &#123;<br><br>    <span class="hljs-keyword">private</span> BeanFactory beanFactory;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br><br>      <span class="hljs-keyword">if</span> (!AutoConfigurationPackages.has(<span class="hljs-built_in">this</span>.beanFactory)) &#123;<br>        logger.debug(<span class="hljs-string">&quot;Could not determine auto-configuration package, automatic mapper scanning disabled.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br><br>      logger.debug(<span class="hljs-string">&quot;Searching for mappers annotated with @Mapper&quot;</span>);<br><br>      List&lt;String&gt; packages = AutoConfigurationPackages.get(<span class="hljs-built_in">this</span>.beanFactory);<br>      <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>        packages.forEach(pkg -&gt; logger.debug(<span class="hljs-string">&quot;Using auto-configuration base package &#x27;&#123;&#125;&#x27;&quot;</span>, pkg));<br>      &#125;<br><br>      <span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;processPropertyPlaceHolders&quot;</span>, <span class="hljs-literal">true</span>);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;annotationClass&quot;</span>, Mapper.class);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;basePackage&quot;</span>, StringUtils.collectionToCommaDelimitedString(packages));<br>      <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">beanWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>(MapperScannerConfigurer.class);<br>      Stream.of(beanWrapper.getPropertyDescriptors())<br>          <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>          .filter(x -&gt; x.getName().equals(<span class="hljs-string">&quot;lazyInitialization&quot;</span>)).findAny()<br>          .ifPresent(x -&gt; builder.addPropertyValue(<span class="hljs-string">&quot;lazyInitialization&quot;</span>, <span class="hljs-string">&quot;$&#123;mybatis.lazy-initialization:false&#125;&quot;</span>));<br>      registry.registerBeanDefinition(MapperScannerConfigurer.class.getName(), builder.getBeanDefinition());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanFactory</span><span class="hljs-params">(BeanFactory beanFactory)</span> &#123;<br>      <span class="hljs-built_in">this</span>.beanFactory = beanFactory;<br>    &#125;<br><br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * If mapper registering configuration or mapper scanning configuration not present, this configuration allow to scan</span><br><span class="hljs-comment">   * mappers based on the same component-scanning path as Spring Boot itself.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@org</span>.springframework.context.annotation.Configuration<br>  <span class="hljs-meta">@Import(AutoConfiguredMapperScannerRegistrar.class)</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean(&#123; MapperFactoryBean.class, MapperScannerConfigurer.class &#125;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerRegistrarNotFoundConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>      logger.debug(<br>          <span class="hljs-string">&quot;Not found configuration for registering mapper bean using @MapperScan, MapperFactoryBean and MapperScannerConfigurer.&quot;</span>);<br>    &#125;<br><br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>首先看一下MybatisAutoConfiguration类上的几个注解：</p><ul><li><p>@org.springframework.context.annotation.Configuration：该注解表明该类是一个配置类，在系统启动时自动解析加载，生成Bean对象放入容器中</p><ul><li>属性值1：value：注入容器中的Bean名称（不赋值默认小驼峰类名称）</li><li>属性值2：proxyBeanMethods：是否单例（默认true）</li></ul></li><li><p>@ConditionalOnClass({ SqlSessionFactory.class, SqlSessionFactoryBean.class })：类条件判断，当有SqlSessionFactory类和SqlSessionFactoryBean类，两个类同时存在时加载</p></li><li><p>@ConditionalOnSingleCandidate(DataSource.class)：单例条件判断，只有容器中只有一个类型的DataSource的Bean定义时才加载</p></li><li><p>@EnableConfigurationProperties(MybatisProperties.class)：加载mybatis属性值</p></li><li><p>@AutoConfigureAfter({ DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class })：先完成两个配置类加载后再加载，先后顺序加载判断</p></li></ul><p>根据条件注解判断加载Bean：</p><ul><li>sqlSessionFactory：session工场</li><li>sqlSessionTemplate：session模板方法，session安全处理和事务管理</li><li>mapperScannerRegistrarNotFoundConfiguration：没有MapperFactoryBean和MapperScannerConfigurer两个Bean时加载，同时引入AutoConfiguredMapperSannerRegistrar注册类。<ul><li><strong>当判断@ConditionalOnMissingBean条件类是否满足，满足才会执行@Import注解引入的注册类，否则不会执行引入注册类</strong></li><li><strong>如果没有使用@MapperScan注解和手动配置过MapperFactoryBean、MapperScannerConfigurer配置，会自动扫描启动类所在包路径</strong></li><li>mapperScannerRegistrarNotFoundConfiguration配置中引入了AutoConfiguredMapperScannerRegistrar注册器，该类实现了ImportBeanDefinitionRegistrar接口，在容器启动时会执行registerBeanDefinitions方法</li><li>这个注册器中会注入MapperScannerConfigurer的BeanDifinition进行注册</li></ul></li></ul><h3 id="2、MapperScannerConfigurer-扫描mapper配置类"><a href="#2、MapperScannerConfigurer-扫描mapper配置类" class="headerlink" title="2、MapperScannerConfigurer 扫描mapper配置类"></a>2、MapperScannerConfigurer 扫描mapper配置类</h3><p>MapperScannerConfigurer类实现了BeanDefinitionRegistryPostProcessor接口，而BeanDefinitionRegistryPostProcessor接口继承了BeanFactoryPostProcess接口，在启动的时候，会自动执行postProcessBeanDefinitionRegistry方法；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.processPropertyPlaceHolders) &#123;<br>    processPropertyPlaceHolders();<br>  &#125;<br><br>  <span class="hljs-type">ClassPathMapperScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);<br>  scanner.setAddToConfig(<span class="hljs-built_in">this</span>.addToConfig);<br>  scanner.setAnnotationClass(<span class="hljs-built_in">this</span>.annotationClass);<br>  scanner.setMarkerInterface(<span class="hljs-built_in">this</span>.markerInterface);<br>  scanner.setSqlSessionFactory(<span class="hljs-built_in">this</span>.sqlSessionFactory);<br>  scanner.setSqlSessionTemplate(<span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>  scanner.setSqlSessionFactoryBeanName(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName);<br>  scanner.setSqlSessionTemplateBeanName(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName);<br>  scanner.setResourceLoader(<span class="hljs-built_in">this</span>.applicationContext);<br>  scanner.setBeanNameGenerator(<span class="hljs-built_in">this</span>.nameGenerator);<br>  scanner.setMapperFactoryBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br>  <span class="hljs-keyword">if</span> (StringUtils.hasText(lazyInitialization)) &#123;<br>    scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));<br>  &#125;<br>  scanner.registerFilters();<br>  <span class="hljs-comment">// 扫描mapper接口方法</span><br>  scanner.scan(<br>      StringUtils.tokenizeToStringArray(<span class="hljs-built_in">this</span>.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));<br>&#125;<br></code></pre></td></tr></table></figure><p>执行扫描的方法是ClassPathMapperScanner#doScan方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>  <span class="hljs-comment">// 执行的是父类ClassPathBeanDefinitionScanner类中的扫描方法</span><br>  Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-built_in">super</span>.doScan(basePackages);<br><br>  <span class="hljs-keyword">if</span> (beanDefinitions.isEmpty()) &#123;<br>    LOGGER.warn(() -&gt; <span class="hljs-string">&quot;No MyBatis mapper was found in &#x27;&quot;</span> + Arrays.toString(basePackages)<br>        + <span class="hljs-string">&quot;&#x27; package. Please check your configuration.&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 将mapper接口方法全都变成MapperFactoryBean工厂对象</span><br>    processBeanDefinitions(beanDefinitions);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> beanDefinitions;<br>&#125;<br></code></pre></td></tr></table></figure><p>扫描指定目录下的所有mapper接口后，执行bean定义信息处理器方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MapperFactoryBean</span>&gt; mapperFactoryBeanClass = MapperFactoryBean.class;<br><br><span class="hljs-comment">// ===================&gt; 执行bean定义信息处理器 &lt;====================</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinitions</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> &#123;<br>  GenericBeanDefinition definition;<br>  <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;<br>    definition = (GenericBeanDefinition) holder.getBeanDefinition();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">beanClassName</span> <span class="hljs-operator">=</span> definition.getBeanClassName();<br>    LOGGER.debug(() -&gt; <span class="hljs-string">&quot;Creating MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + beanClassName<br>        + <span class="hljs-string">&quot;&#x27; mapperInterface&quot;</span>);<br><br>    <span class="hljs-comment">// the mapper interface is the original class of the bean</span><br>    <span class="hljs-comment">// but, the actual class of the bean is MapperFactoryBean</span><br>    definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName); <span class="hljs-comment">// issue #59</span><br>    <br>    <span class="hljs-comment">// ================&gt; 将扫描出来的mapper定义信息设置成mapperFactoryBean &lt;==================</span><br>    definition.setBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br><br>    definition.getPropertyValues().add(<span class="hljs-string">&quot;addToConfig&quot;</span>, <span class="hljs-built_in">this</span>.addToConfig);<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">explicitFactoryUsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName)) &#123;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName));<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionFactory != <span class="hljs-literal">null</span>) &#123;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionFactory);<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName)) &#123;<br>      <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>        LOGGER.warn(<br>            () -&gt; <span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>      &#125;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName));<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionTemplate != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>        LOGGER.warn(<br>            () -&gt; <span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>      &#125;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!explicitFactoryUsed) &#123;<br>      LOGGER.debug(() -&gt; <span class="hljs-string">&quot;Enabling autowire by type for MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>      definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);<br>    &#125;<br>    definition.setLazyInit(lazyInitialization);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在AbstractBeanFactory#doGetBean方法中，获取到mapper接口对应的mapperFactoryBean工厂对象后，根据工厂对象创建mapperProxy代理对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br>    <span class="hljs-comment">// 根据工厂对象获取对象</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure><p>业务方法正式调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StudentService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StudentDao studentDao;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">queryById</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student1</span> <span class="hljs-operator">=</span> studentDao.queryById(id);<br>        studentDao.updateById(String.valueOf(id), <span class="hljs-string">&quot;张三222&quot;</span>);<br>        <span class="hljs-keyword">return</span> student1;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151230617.png" alt="image-20250531151230617"></p><p>注入的bean对象是代理对象，执行的时候，会进入到MapperProxy代理类中的invoke方法中，然后进入到MapperMethod类中。</p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151601515.png" alt="image-20250531151601515"></p><p><img src="/2025/05/24/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151739625.png" alt="image-20250531151739625"></p>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>源码解析</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
