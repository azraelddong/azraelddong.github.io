<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>seata</title>
    <link href="/2026/01/20/%E6%A1%86%E6%9E%B6/seata/seata/"/>
    <url>/2026/01/20/%E6%A1%86%E6%9E%B6/seata/seata/</url>
    
    <content type="html"><![CDATA[<h1 id="Seataæ¡†æ¶å­¦ä¹ "><a href="#Seataæ¡†æ¶å­¦ä¹ " class="headerlink" title="Seataæ¡†æ¶å­¦ä¹ "></a>Seataæ¡†æ¶å­¦ä¹ </h1><h2 id="Seataæ¨¡å¼åˆ†ç±»"><a href="#Seataæ¨¡å¼åˆ†ç±»" class="headerlink" title="Seataæ¨¡å¼åˆ†ç±»"></a>Seataæ¨¡å¼åˆ†ç±»</h2><ul><li>ATæ¨¡å¼</li><li>TCCæ¨¡å¼</li><li><del>Sagaæ¨¡å¼ï¼ˆä¸å¸¸ç”¨ï¼‰</del></li><li><del>XAæ¨¡å¼ï¼ˆä¸å¸¸ç”¨ï¼‰</del></li></ul><h2 id="Seataæ¶æ„å›¾"><a href="#Seataæ¶æ„å›¾" class="headerlink" title="Seataæ¶æ„å›¾"></a>Seataæ¶æ„å›¾</h2><p>æ¥æºseataå®˜ç½‘ï¼š<a href="https://seata.apache.org/">https://seata.apache.org</a></p><p>seataä¸»è¦ç”±TMï¼ˆTransaction Managerï¼‰ï¼ŒRMï¼ˆResource Managerï¼‰å’ŒTCï¼ˆTransaction Coordinatorï¼‰ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ç»„æˆã€‚</p><p><img src="/2026/01/20/%E6%A1%86%E6%9E%B6/seata/seata/image-20260120162408588.png" alt="image-20260120162408588"></p><h2 id="ATæ¨¡å¼"><a href="#ATæ¨¡å¼" class="headerlink" title="ATæ¨¡å¼"></a>ATæ¨¡å¼</h2><p>ATæ¨¡å¼éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨æ–¹æ³•ä¸ŠåŠ ä¸Š@GlobalTransactionalæ³¨è§£å³å¯ï¼Œä¸»è¦é€šè¿‡<code>XID</code>å…¨å±€äº‹åŠ¡idæ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ã€‚ä¸‹é¢ç»“åˆæºç è¿›è¡Œè®²è§£ï¼›</p><h3 id="GlobalTransactionalScannerç±»"><a href="#GlobalTransactionalScannerç±»" class="headerlink" title="GlobalTransactionalScannerç±»"></a>GlobalTransactionalScannerç±»</h3><p><u><strong>è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæ‰§è¡ŒwrapIfNecessaryæ–¹æ³•ï¼Œæ‰«ææ–¹æ³•ä¸ŠåŠ äº†@GlobalTransactionalæ³¨è§£çš„è¯ï¼Œå°±åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œå½“æ‰§è¡Œåˆ°è¢«ä»£ç†ç±»çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä»£ç†ç±»ä¸­çš„GlobalTransactionalInterceptorHandlerç±»ä¸­doInvokeæ–¹æ³•ã€‚</strong></u></p><h3 id="TransactionalTemplateç±»"><a href="#TransactionalTemplateç±»" class="headerlink" title="TransactionalTemplateç±»"></a>TransactionalTemplateç±»</h3><p>äº‹åŠ¡æ¨¡æ¿ç±»ä¸»è¦ä½œç”¨æ˜¯å¼€å¯äº‹åŠ¡ã€æ‰§è¡Œä¸šåŠ¡æ–¹æ³•ã€äº‹åŠ¡æäº¤&#x2F;å›æ»šã€‚</p><h4 id="beginTransactionæ–¹æ³•"><a href="#beginTransactionæ–¹æ³•" class="headerlink" title="beginTransactionæ–¹æ³•"></a>beginTransactionæ–¹æ³•</h4><p>å¦‚æœäº‹åŠ¡çš„è§’è‰²æ˜¯Launcherï¼Œé‚£ä¹ˆå°±å‘TCå‘èµ·å¼€å¯äº‹åŠ¡è¯·æ±‚ï¼ŒTCæ¥æ”¶åˆ°è¯·æ±‚åï¼Œåˆ›å»ºå…¨å±€äº‹åŠ¡XIDå”¯ä¸€æ ‡è¯†ï¼Œå¦‚æœäº‹åŠ¡çš„è§’è‰²ä¸æ˜¯Launcherï¼Œé‚£ä¹ˆå°±ä»€ä¹ˆä¹Ÿä¸åšã€‚</p><h4 id="businessæ–¹æ³•æ‰§è¡Œ"><a href="#businessæ–¹æ³•æ‰§è¡Œ" class="headerlink" title="businessæ–¹æ³•æ‰§è¡Œ"></a>businessæ–¹æ³•æ‰§è¡Œ</h4><p>åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ï¼Œseataé€šè¿‡è‡ªåŠ¨é…ç½®å¯¹datasourceæ•°æ®æºè¿›è¡Œäº†ä»£ç†ã€‚å½“æ‰§è¡Œçš„ä¸šåŠ¡æ–¹æ³•åŒ…å«jdbcæ•°æ®åº“æ“ä½œçš„æ—¶å€™ï¼Œä¼šå…ˆæ‰§è¡Œæ•°æ®æºä»£ç†ç±»è¿›è¡Œå¢å¼ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConditionalOnBean(DataSource.class)</span><br><span class="hljs-meta">@ConditionalOnExpression(</span><br><span class="hljs-meta">        &quot;$&#123;seata.enabled:true&#125; &amp;&amp; $&#123;seata.enableAutoDataSourceProxy:true&#125; &amp;&amp; $&#123;seata.enable-auto-data-source-proxy:true&#125;&quot;)</span><br><span class="hljs-meta">@AutoConfigureOrder(Ordered.LOWEST_PRECEDENCE)</span><br><span class="hljs-meta">@AutoConfigureAfter(</span><br><span class="hljs-meta">        value = &#123;SeataCoreAutoConfiguration.class&#125;,</span><br><span class="hljs-meta">        name = &quot;org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeataDataSourceAutoConfiguration</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The bean seataAutoDataSourceProxyCreator.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean(BEAN_NAME_SEATA_AUTO_DATA_SOURCE_PROXY_CREATOR)</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean(SeataAutoDataSourceProxyCreator.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SeataAutoDataSourceProxyCreator <span class="hljs-title function_">seataAutoDataSourceProxyCreator</span><span class="hljs-params">(SeataProperties seataProperties)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeataAutoDataSourceProxyCreator</span>(<br>                seataProperties.isUseJdkProxy(),<br>                seataProperties.getExcludesForAutoProxying(),<br>                seataProperties.getDataSourceProxyMode());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€é˜¶æ®µæäº¤ï¼š</p><p>åœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œè¯­å¥çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œåˆ° <strong><u>ConnectionProxy</u></strong> ä»£ç†ç±»çš„æŠ½è±¡çˆ¶ç±»**<u>AbstractConnectionProxy#prepareStatement()</u><strong>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›</strong><u>PreparedStatementProxy</u>**ä»£ç†ç±»ï¼Œè¿™æ ·åœ¨æ‰§è¡Œsqlè¯­å¥å‰ï¼Œä¼šå¯¹PreparedStatmentè¿›è¡Œå¢å¼ºï¼Œä¼šåœ¨æ‰§è¡Œä¸šåŠ¡SQLè¯­å¥å‰ååŠ ä¸Šé•œåƒå‰åçš„SQLè¯­å¥ï¼Œå¹¶å°†é•œåƒå‰åçš„è¯­å¥æ„é€ å¯¹åº”çš„undo_logè¡¨çš„æ’å…¥è¯­å¥å’Œæ„é€ LockKeyï¼Œåœ¨commitçš„æ—¶å€™ï¼Œè¿›è¡Œundo_logè¯­å¥æ’å…¥ã€‚</p><p><strong><u>æäº¤æœ¬åœ°äº‹åŠ¡ä¹‹å‰ï¼Œéœ€è¦å…ˆå‘TCæ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œè·å–åˆ°å…¨å±€é”ï¼ˆå¦‚æœä½¿ç”¨DBå­˜å‚¨çš„è¯ï¼Œå‘lock_tableè¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼‰ï¼Œç„¶åæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œæ’å…¥undo_logå›æ»šæ—¥å¿—è¡¨è®°å½•ï¼Œç„¶åå°†æœ¬åœ°äº‹åŠ¡æäº¤çš„ç»“æœä¸ŠæŠ¥ç»™TCã€‚</u></strong></p><p>äºŒé˜¶æ®µæäº¤</p><p><u><strong>æ”¶åˆ°TCçš„åˆ†æ”¯æäº¤è¯·æ±‚ï¼Œå°†è¯·æ±‚æ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—ä¸­ï¼Œå¼‚æ­¥åˆ é™¤undo_logï¼Œlock_tableç›¸å…³è¡¨ä¸­æ•°æ®ã€‚</strong></u></p><p>äºŒé˜¶æ®µå›æ»š</p><p><u><strong>æ”¶åˆ°TCçš„åˆ†æ”¯å›æ»šï¼Œå¼€å¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ ¹æ®XIDè·å–åˆ°undo_logçš„æ•°æ®ï¼Œæ ¹æ®undo_logè¡¨ä¸­çš„é•œåƒè®°å½•ï¼Œç”Ÿæˆé•œåƒå‰çš„SQLè¯­å¥å¹¶æ‰§è¡Œï¼Œç„¶åæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå°†äº‹åŠ¡æäº¤çŠ¶æ€ä¸ŠæŠ¥ç»™TCã€‚</strong></u></p><h2 id="TCCæ¨¡å¼"><a href="#TCCæ¨¡å¼" class="headerlink" title="TCCæ¨¡å¼"></a>TCCæ¨¡å¼</h2><p>é¦–å…ˆè¿˜æ˜¯å¼€å¯å…¨å±€äº‹åŠ¡å¹¶åˆ›å»ºå…¨å±€äº‹åŠ¡XIDï¼Œåœ¨å¯åŠ¨æ—¶å€™æ‰«ææ˜¯å¦æœ‰@TwoPhaseBusinessActionæ³¨è§£ä¿®é¥°ï¼Œæœ‰çš„è¯ï¼Œå°±å‘TCæ³¨å†ŒRMåˆ†æ”¯äº‹åŠ¡ï¼Œæ‰§è¡Œåˆ†æ”¯prepareæ–¹æ³•ï¼Œ<u><strong>å…¨å±€äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼ŒTCä¼šé€šçŸ¥å¯¹åº”çš„XIDä¸‹çš„æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡è¿›è¡Œåˆ†æ”¯æäº¤æ–¹æ³•&#x2F;å›é€€æ–¹æ³•</strong></u>ã€‚</p><h3 id="TccActionInterceptorHandlerå¤„ç†å™¨"><a href="#TccActionInterceptorHandlerå¤„ç†å™¨" class="headerlink" title="TccActionInterceptorHandlerå¤„ç†å™¨"></a>TccActionInterceptorHandlerå¤„ç†å™¨</h3><p>åœ¨æ‰§è¡ŒTCCæ¨¡å¼çš„æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œ<u><strong>TccActionInterceptorHandler#doInvoke</strong></u>æ–¹æ³•ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>seata</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GaussDB</title>
    <link href="/2026/01/13/%E8%BF%90%E7%BB%B4/GaussDB/"/>
    <url>/2026/01/13/%E8%BF%90%E7%BB%B4/GaussDB/</url>
    
    <content type="html"><![CDATA[<h1 id="GaussDBè€ƒè¯•"><a href="#GaussDBè€ƒè¯•" class="headerlink" title="GaussDBè€ƒè¯•"></a>GaussDBè€ƒè¯•</h1><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><h3 id="è¡¨ç›¸å…³"><a href="#è¡¨ç›¸å…³" class="headerlink" title="è¡¨ç›¸å…³"></a>è¡¨ç›¸å…³</h3><p>åˆ›å»ºè¡¨ï¼šcreate table t1 (a integer, b nchar(30), c float4, d blob);</p><p>ä¿®æ”¹è¡¨åï¼šalter table t1 rename to t2;</p><p>æ’å…¥æ•°æ®ï¼šinsert into t2 values(1, â€˜1â€™, 1.1, null);</p><p>å¢åŠ åˆ—ï¼šalter table t2 add e(nchar(30));</p><p>åˆ é™¤åˆ—ï¼šalter table t2 drop e;</p><p>å¢åŠ çº¦æŸï¼šalter table t2 add <strong>constraint</strong> unique_index unique(a);</p><p>åˆ é™¤è¡¨ï¼šdrop table if exists t2;</p><h3 id="è§†å›¾"><a href="#è§†å›¾" class="headerlink" title="è§†å›¾"></a>è§†å›¾</h3><p>åˆ›å»ºè§†å›¾ï¼šcreate view v_1 as select * from t1;</p><p>ä¿®æ”¹è§†å›¾åç§°ï¼šalter view rename to v_2;</p><p>åˆ é™¤è§†å›¾ï¼šdrop view v_2;</p><h3 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h3><p>åˆ›å»ºç´¢å¼•ï¼š<strong>create index idx_index on t2(a);</strong></p><p>é‡å‘½åç´¢å¼•ï¼šalter index idx_index rename to idx_index2;</p><p>åˆ é™¤ç´¢å¼•ï¼šdrop index idx_index2;</p><h3 id="éƒ¨ç½²å‘½ä»¤"><a href="#éƒ¨ç½²å‘½ä»¤" class="headerlink" title="éƒ¨ç½²å‘½ä»¤"></a>éƒ¨ç½²å‘½ä»¤</h3><p>è¿æ¥æ•°æ®åº“å‘½ä»¤ï¼šgsql -h ä¸»èŠ‚ç‚¹ipåœ°å€ -p 8000 -d postgres -U ç”¨æˆ·å  -W å¯†ç  -r</p><p>åˆ›å»ºç”¨æˆ·å¹¶èµ‹äºˆSYSADMINè§’è‰²æƒé™ï¼šcreate user hccdp sysadmin <strong>identified by</strong> â€˜å¯†ç â€™</p><p>å¦‚æœä¸å°å¿ƒæ²¡æœ‰èµ‹äºˆSYSADMINè§’è‰²ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ</p><p>1.create user test identified by â€˜xxxxâ€™;</p><p>2.alter user test sysadmin; (é‡æ–°ç»™ç”¨æˆ·testèµ‹äºˆsysadminè§’è‰²)</p><p>æ’¤æ¶ˆtestç”¨æˆ·sysadminè§’è‰²ï¼šalter user test with nosysadmin;</p><p>åˆ›å»ºä¸€ä¸ªtpcdsæ¨¡å¼ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªè¡¨reason?</p><p>create schema tpcds;</p><p>create table reason(r_reasion_id integer not null, r_reasion_name char(6), r_reason_desc varchar(200));</p><p>è¿™ä¸ªä½¿ç”¨testç™»é™†æ•°æ®åº“ï¼šgsql -d postgres -h xxx -p 8000 -U test -W xxxx -r</p><p>æŸ¥è¯¢dpcdsæ¨¡å¼ä¸‹è¡¨reasonï¼Œå¤±è´¥ï¼ŒæŠ¥æ²¡æœ‰æƒé™ï¼Ÿ</p><p><img src="/2026/01/13/%E8%BF%90%E7%BB%B4/GaussDB/image-20260116152630090.png" alt="image-20260116152630090"></p><p><strong>è¿™ä¸ªæ—¶å€™éœ€è¦å°†tpcdsæ¨¡å¼å’Œè¡¨çš„æ‰€æœ‰æƒé™èµ‹äºˆtestç”¨æˆ·ï¼Ÿ</strong></p><p><strong>grant usage on schema tpcds to test;</strong></p><p><strong>grant all privileges on tpcds.reason to test;</strong></p><p><strong>å°†æ•°æ®åº“postgresè¿æ¥æƒé™èµ‹äºˆtestï¼Œå¹¶å°†åˆ›å»ºschemaçš„æƒé™èµ‹äºˆtestï¼Œå¹¶ä¸”å…è®¸testå¯ä»¥ç»™å…¶å®ƒç”¨æˆ·èµ‹äºˆæƒé™ï¼Ÿï¼Ÿ</strong></p><p><strong>grant create,connect on database postgres to test with grant option;</strong> </p>]]></content>
    
    
    
    <tags>
      
      <tag>GaussDB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginxé…ç½®å­åŸŸå</title>
    <link href="/2025/12/18/%E8%BF%90%E7%BB%B4/nginx%E9%85%8D%E7%BD%AE%E5%AD%90%E5%9F%9F%E5%90%8D/"/>
    <url>/2025/12/18/%E8%BF%90%E7%BB%B4/nginx%E9%85%8D%E7%BD%AE%E5%AD%90%E5%9F%9F%E5%90%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginxé…ç½®å­åŸŸå"><a href="#Nginxé…ç½®å­åŸŸå" class="headerlink" title="Nginxé…ç½®å­åŸŸå"></a>Nginxé…ç½®å­åŸŸå</h1><p>åœ¨nginxé…ç½®ç›®å½•conf.dä¸‹ï¼Œé…ç½®äº†å­åŸŸåé…ç½®</p><p>1.cdzb_8888.conf</p><p>è®¿é—®æ ¹è·¯å¾„ï¼š<a href="http://bolai.cdzb.caddyddong.com:8888ï¼Œå¹¶åŒ¹é…åˆ°">http://bolai.cdzb.caddyddong.com:8888ï¼Œå¹¶åŒ¹é…åˆ°</a> &#x2F;reportä¸ºå¼€å¤´çš„è¯·æ±‚ï¼Œå°±ä¼šèµ°ä¸‹é¢çš„é…ç½®</p><p>åŒ¹é…ä¼˜å…ˆçº§ï¼šç²¾ç¡®åŒ¹é… &gt; ä»¥xxxå¼€å¤´åŒ¹é…</p><p>è®¿é—®ç¤ºä¾‹ï¼š<a href="http://bolai.cdzb.caddyddong.com:8888/report/xxxxxx">http://bolai.cdzb.caddyddong.com:8888/report/xxxxxx</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">server &#123;<br>    listen       8888;// è®¿é—®ç«¯å£<br>    server_name  bolai.cdzb.caddyddong.com;// å­åŸŸå<br><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br>    <span class="hljs-comment"># éšè—ç‰ˆæœ¬å·</span><br>    server_tokens off;<br>    location / &#123;<br>       <span class="hljs-built_in">return</span> 403 <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>    <span class="hljs-comment"># æŸæ¥è®¾å¤‡å›è°ƒåœ°å€</span><br>    location ^~/report &#123;<br>        add_header    Cache-Control  max-age=600;<br>        proxy_pass http://127.0.0.1:6004/cdzb-bolai/accept-msg/report;<br>   &#125;<br>    <span class="hljs-comment">#error_page  404              /404.html;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>2.cdzb_80.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŸæ¥server</span><br>server &#123;<br>    listen       80;<br>    server_name  bolai.cdzb.caddyddong.com;<br><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br>    <span class="hljs-comment"># éšè—ç‰ˆæœ¬å·</span><br>    server_tokens off;<br>    location / &#123;<br>       <span class="hljs-built_in">return</span> 403 <span class="hljs-string">&quot;&quot;</span>;<span class="hljs-comment"># æ ¹è·¯å¾„åŠæœªåŒ¹é…è·¯å¾„è¿”å›403ç¦æ­¢è®¿é—®</span><br>    &#125;<br>    <span class="hljs-comment">#error_page  404              /404.html;</span><br>&#125;<br><br><br><span class="hljs-comment">#ç½‘å…³server</span><br>server &#123;<br>    listen       80;<br>    server_name  gateway.cdzb.caddyddong.com;<br>    server_tokens off;<br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br>    <span class="hljs-comment"># location / &#123;</span><br>    <span class="hljs-comment">#     return   307 https://$server_name/;</span><br>    <span class="hljs-comment"># &#125;   </span><br><br>    <span class="hljs-comment"># location ^~/cdzb-web &#123;</span><br>    <span class="hljs-comment">#     return   307 https://$server_name/cdzb-web;</span><br>    <span class="hljs-comment"># &#125;</span><br><br>    location / &#123;<br>       proxy_pass http://127.0.0.1:6001; <span class="hljs-comment"># å°†è¯·æ±‚åå‘ä»£ç†åˆ°æœ¬åœ°6001ç«¯å£ï¼ˆç½‘å…³æœåŠ¡ï¼‰</span><br>       <span class="hljs-comment">#rewrite ^(.*) https://$server_name$1 permanent;</span><br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment"># å¾®ä¿¡æœåŠ¡server</span><br>server &#123;<br>    listen       80;<br>    server_name  wechat.cdzb.caddyddong.com;<br>    server_tokens off;<br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br><br>    location /cdzb-wechat/wechat/callback &#123;<br>        proxy_pass http://127.0.0.1:6002/cdzb-wechat/wechat/callback;<span class="hljs-comment"># å¾®ä¿¡å›è°ƒå‡½æ•°</span><br>    &#125;<br><br>    <span class="hljs-comment">#error_page  404              /404.html;</span><br>&#125;<br><br><br><span class="hljs-comment"># app é¡µé¢</span><br>server &#123;<br>    listen       80;<br>    server_name  portal.cdzb.caddyddong.com;<br><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br>    <span class="hljs-comment"># éšè—ç‰ˆæœ¬å·</span><br>    server_tokens off;<br>    location / &#123;<br>        <span class="hljs-built_in">return</span>   307 https://<span class="hljs-variable">$server_name</span>/cdzb-web/;<span class="hljs-comment"># ä¸´æ—¶è·³è½¬åˆ°https://portal.cdzb.caddyddong.com/cdzb-web/ï¼Œä½¿ç”¨httpsè®¿é—®</span><br>    &#125;<br><br>    <span class="hljs-comment">#error_page  404              /404.html;</span><br>&#125;<br><br><br><span class="hljs-comment"># adminé¡µé¢</span><br>server &#123;<br>    listen       80;<br>    server_name  admin.cdzb.caddyddong.com;<br><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br>    <span class="hljs-comment"># éšè—ç‰ˆæœ¬å·</span><br>    server_tokens off;<br>    <span class="hljs-comment"># rewrite ^(.*)$ https://$&#123;server_name&#125;$1 permanent;</span><br>    location / &#123;<br>        <span class="hljs-built_in">return</span>   307 https://<span class="hljs-variable">$server_name</span>/cdzb-admin/; <span class="hljs-comment"># ä¸´æ—¶è·³è½¬åˆ°https://admin.cdzb.caddyddong.com/cdzb-admin/ï¼Œä½¿ç”¨httpsè®¿é—®</span><br>    &#125;<br><br>    <span class="hljs-comment">#error_page  404              /404.html;</span><br>&#125;<br><br><span class="hljs-comment"># ç”µè¡¨æœåŠ¡</span><br>server &#123;<br>    listen       80;<br>    server_name  ammeter.cdzb.caddyddong.com;<br>    server_tokens off;<br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br><br>    location /cdzb-meter/subscribe/report &#123;<br>    <span class="hljs-comment"># å½“æ¥æ”¶åˆ°http://ammeter.cdzb.caddyddong.com/cdzb-meter/subscribe/reportè¯·æ±‚çš„æ—¶å€™ï¼Œè·³è½¬åˆ°http://127.0.0.1:6009/cdzb-meter/subscribe/reportè¯·æ±‚è·¯å¾„</span><br>        proxy_pass http://127.0.0.1:6009/cdzb-meter/subscribe/report;<br>    &#125;<br><br><br>    <span class="hljs-comment">#error_page  404              /404.html;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>3.cdzb_443.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç½‘å…³</span><br>server &#123;<br>    listen              443 ssl;<span class="hljs-comment"># ç›‘å¬443ç«¯å£ï¼Œå¹¶å¯ç”¨ssl</span><br>    server_name   gateway.cdzb.caddyddong.com;<span class="hljs-comment">#å­åŸŸå</span><br>    ssl_certificate     /data/www/ssl/gateway/cert.pem;<span class="hljs-comment"># sslè¯ä¹¦åœ°å€</span><br>    ssl_certificate_key /data/www/ssl/gateway/key.pem;<span class="hljs-comment"># sslç§é’¥åœ°å€</span><br>    ssl_session_cache   shared:SSL:1m;<span class="hljs-comment"># å…±äº«sslä¼šè¯ç¼“å­˜</span><br>    ssl_session_timeout 10m;<span class="hljs-comment"># sslä¼šè¯è¶…è¿‡10åˆ†é’Ÿ</span><br>        ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  <span class="hljs-comment">#ä½¿ç”¨æ­¤åŠ å¯†å¥—ä»¶ã€‚</span><br>        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;   <span class="hljs-comment">#ä½¿ç”¨è¯¥åè®®è¿›è¡Œé…ç½®ã€‚</span><br>        ssl_prefer_server_ciphers on;   <span class="hljs-comment"># ä¼˜å…ˆåŠ è½½é…ç½®çš„åŠ å¯†å¥—ä»¶</span><br>    server_tokens off;<span class="hljs-comment"># å…³é—­ç‰ˆæœ¬å·æ˜¾ç¤º</span><br>    <span class="hljs-comment">#proxy_set_header Host                          $host;</span><br>    proxy_set_header X-Real-IP                  <span class="hljs-variable">$remote_addr</span>;<span class="hljs-comment"># å‘ä»£ç†æœåŠ¡ä¼ é€’çœŸå®åœ°å€</span><br><br>    client_max_body_size 200m;<span class="hljs-comment"># è¯·æ±‚ä½“æœ€å¤§å€¼200m</span><br>    client_header_timeout 1m;<span class="hljs-comment"># è¯·æ±‚å¤´è¶…æ—¶1åˆ†é’Ÿ</span><br>    client_body_timeout 1m;<span class="hljs-comment"># è¯·æ±‚ä½“è¶…æ—¶1åˆ†é’Ÿ</span><br>    proxy_connect_timeout 6000s;<span class="hljs-comment"># ä»£ç†è¿æ¥è¶…è¿‡6000s</span><br>    proxy_read_timeout 1m;<span class="hljs-comment"># ä»£ç†è¯»å–è¶…è¿‡1åˆ†é’Ÿ</span><br>    proxy_send_timeout 1m;<span class="hljs-comment"># ä»£ç†å‘é€è¶…è¿‡1åˆ†é’Ÿ</span><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br>    location / &#123;<br>       proxy_pass http://127.0.0.1:6001;<span class="hljs-comment"># è½¬å‘åœ°å€</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment"># å¾®ä¿¡æˆæƒserver</span><br>server &#123;<br>    listen              443 ssl;<br>    server_name  wechat.cdzb.caddyddong.com;<br>    ssl_certificate     /data/www/ssl/wechat/cert.pem;<br>    ssl_certificate_key /data/www/ssl/wechat/key.pem;<br>    ssl_session_cache   shared:SSL:1m;<br>    ssl_session_timeout 10m;<br>        ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  <span class="hljs-comment">#ä½¿ç”¨æ­¤åŠ å¯†å¥—ä»¶ã€‚</span><br>        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;   <span class="hljs-comment">#ä½¿ç”¨è¯¥åè®®è¿›è¡Œé…ç½®ã€‚</span><br>        ssl_prefer_server_ciphers on;   <br>    server_tokens off;<br><br>    proxy_set_header Host                          <span class="hljs-variable">$host</span>;<br>    proxy_set_header X-Real-IP                  <span class="hljs-variable">$remote_addr</span>;<br><br>    client_max_body_size 200m;<br>    client_header_timeout 1m;<br>    client_body_timeout 1m;<br>    proxy_connect_timeout 6000s;<br>    proxy_read_timeout 1m;<br>    proxy_send_timeout 1m;<br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br>    <br>    <span class="hljs-comment">#å¾®ä¿¡å›è°ƒé…ç½®</span><br>    location /cdzb-wechat/wechat/callback &#123;<br>        proxy_pass http://127.0.0.1:6002/cdzb-wechat/wechat/callback;<br>    &#125;<br><br>    <span class="hljs-comment">#å¾®ä¿¡æ ¡éªŒæˆæƒå›è°ƒæ–‡ä»¶åœ°å€,å‹¿æ›´æ”¹</span><br>    <span class="hljs-comment"># location / &#123;</span><br>    <span class="hljs-comment">#     root   /usr/share/nginx/html;</span><br>    <span class="hljs-comment">#     index  index.html index.htm;</span><br>    <span class="hljs-comment"># &#125;</span><br><br>    <span class="hljs-comment">#å¾®ä¿¡å……å€¼æ”¯ä»˜å›è°ƒé…ç½®</span><br>    location /cdzb-wechat/wechat/wechat-amount-charged/pay/callback &#123;<br>            proxy_pass http://127.0.0.1:6002/cdzb-wechat/wechat/wechat-amount-charged/pay/callback;<br>    &#125;<br><br>        <span class="hljs-comment">#å¾®ä¿¡è®¢å•æ”¯ä»˜å›è°ƒé…ç½®</span><br>        location /cdzb-wechat/wechat/wechat-recharged-order/pay/callback &#123;<br>            proxy_pass http://127.0.0.1:6002/cdzb-wechat/wechat/wechat-recharged-order/pay/callback;<br>    &#125;                                <br><br>        <span class="hljs-comment">#å¾®ä¿¡è®¢å•é€€æ¬¾å›è°ƒé…ç½®</span><br>        location /cdzb-wechat/wechat/wechat-recharged-order/refund/callback &#123;<br>            proxy_pass http://127.0.0.1:6002/cdzb-wechat/wechat/wechat-recharged-order/refund/callback;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment"># æ‰‹æœºç«¯é¡µé¢</span><br>server &#123;<br>    listen              443 ssl;<br>    server_name  portal.cdzb.caddyddong.com;<br>    ssl_certificate     /data/www/ssl/portal/cert.pem;<br>    ssl_certificate_key /data/www/ssl/portal/key.pem;<br>    ssl_session_cache   shared:SSL:1m;<br>    ssl_session_timeout 10m;<br>        ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  <span class="hljs-comment">#ä½¿ç”¨æ­¤åŠ å¯†å¥—ä»¶ã€‚</span><br>        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;   <span class="hljs-comment">#ä½¿ç”¨è¯¥åè®®è¿›è¡Œé…ç½®ã€‚</span><br>        ssl_prefer_server_ciphers on;   <br>    server_tokens off;<br><br>    proxy_set_header Host                          <span class="hljs-variable">$host</span>;<br>    proxy_set_header X-Real-IP                  <span class="hljs-variable">$remote_addr</span>;<br><br>    client_max_body_size 200m;<br>    client_header_timeout 1m;<br>    client_body_timeout 1m;<br>    proxy_connect_timeout 6000s;<br>    proxy_read_timeout 1m;<br>    proxy_send_timeout 1m;<br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br><br><br>    <span class="hljs-comment">#å¾®ä¿¡æ ¡éªŒæˆæƒå›è°ƒæ–‡ä»¶åœ°å€,å‹¿æ›´æ”¹</span><br>    location / &#123;<br>        <span class="hljs-built_in">return</span>   307 https://<span class="hljs-variable">$server_name</span>/cdzb-web/;<span class="hljs-comment"># ä¸´æ—¶é‡å®šå‘åˆ°https://$server_name/cdzb-web/åœ°å€</span><br>    &#125;<br><br>    <span class="hljs-comment">#webapp é¡µé¢</span><br>    location ^~/cdzb-web &#123;<br>        add_header    Cache-Control  max-age=600;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_filename</span> ~* .*\.(htm|html)$)<span class="hljs-comment"># å¦‚æœè¯·æ±‚æ–‡ä»¶æ˜¯.html/.htmæ–‡ä»¶ï¼Œç¦æ­¢ç¼“å­˜</span><br>        &#123;<br>            add_header Cache-Control no-store;<br>            add_header Cache-Control no-cache;<br>        &#125;<br>        root /data/www/;<span class="hljs-comment">#  é™æ€æ–‡ä»¶æ ¹ç›®å½•ä¸º/data/www/</span><br>        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /cdzb-web/index.html; <span class="hljs-comment"># å°è¯•è®¿é—®æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¦åˆ™è¿”å›/index.htmlï¼ˆæ”¯æŒSPAè·¯ç”±ï¼‰</span><br>    &#125;<br><br>    location ^~/cdzb-images/ &#123;<br>        proxy_buffering off;<br>        proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>        proxy_pass http://192.168.0.177:9000;<br>    &#125;<br><br>    <span class="hljs-comment"># location ^~/cdzb-file/ &#123;</span><br>    <span class="hljs-comment">#     proxy_buffering off;</span><br>    <span class="hljs-comment">#     proxy_set_header Host $http_host;</span><br>    <span class="hljs-comment">#     proxy_pass http://127.0.0.1:6006;</span><br>    <span class="hljs-comment"># &#125;</span><br><br>    <span class="hljs-comment">#æµ‹è¯•ä½¿ç”¨</span><br>    location /img/ &#123;<br>        <span class="hljs-built_in">alias</span> /data/www/img/;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment"># æŸæ¥æœåŠ¡</span><br>server &#123;<br>    listen              443 ssl;<br>    server_name  bolai.cdzb.caddyddong.com;<br>    ssl_certificate     /data/www/ssl/bolai/cert.pem;<br>    ssl_certificate_key /data/www/ssl/bolai/key.pem;<br>    ssl_session_cache   shared:SSL:1m;<br>    ssl_session_timeout 10m;<br>        ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  <span class="hljs-comment">#ä½¿ç”¨æ­¤åŠ å¯†å¥—ä»¶ã€‚</span><br>        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;   <span class="hljs-comment">#ä½¿ç”¨è¯¥åè®®è¿›è¡Œé…ç½®ã€‚</span><br>        ssl_prefer_server_ciphers on;   <br>    server_tokens off;<br><br>    proxy_set_header Host                          <span class="hljs-variable">$host</span>;<br>    proxy_set_header X-Real-IP                  <span class="hljs-variable">$remote_addr</span>;<br><br>    client_max_body_size 200m;<br>    client_header_timeout 1m;<br>    client_body_timeout 1m;<br>    proxy_connect_timeout 6000s;<br>    proxy_read_timeout 1m;<br>    proxy_send_timeout 1m;<br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br>    <span class="hljs-comment"># æŸæ¥è®¾å¤‡å›è°ƒåœ°å€</span><br>    location ^~/cdzb-bolai/accept-msg/report &#123;<br>        add_header    Cache-Control  max-age=600;<br>        proxy_pass http://127.0.0.1:6004/cdzb-bolai/accept-msg/report;<br>   &#125;<br>&#125;<br><br><span class="hljs-comment"># åå°ç®¡ç†é¡µé¢</span><br>server &#123;<br>    listen              443 ssl;<br>    server_name  admin.cdzb.caddyddong.com;<br>    ssl_certificate     /data/www/ssl/admin/cert.pem;<br>    ssl_certificate_key /data/www/ssl/admin/key.pem;<br>    ssl_session_cache   shared:SSL:1m;<br>    ssl_session_timeout 10m;<br>        ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  <span class="hljs-comment">#ä½¿ç”¨æ­¤åŠ å¯†å¥—ä»¶ã€‚</span><br>        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;   <span class="hljs-comment">#ä½¿ç”¨è¯¥åè®®è¿›è¡Œé…ç½®ã€‚</span><br>        ssl_prefer_server_ciphers on;   <br>    server_tokens off;<br><br>    proxy_set_header Host                          <span class="hljs-variable">$host</span>;<br>    proxy_set_header X-Real-IP                  <span class="hljs-variable">$remote_addr</span>;<br><br>    client_max_body_size 200m;<br>    client_header_timeout 1m;<br>    client_body_timeout 1m;<br>    proxy_connect_timeout 6000s;<br>    proxy_read_timeout 1m;<br>    proxy_send_timeout 1m;<br><span class="hljs-comment">#    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="hljs-comment">#    location / &#123;</span><br><span class="hljs-comment">#        return   307 https://$server_name/cdzb-admin/;</span><br><span class="hljs-comment">#    &#125;</span><br>    location / &#123;<br>       proxy_pass http://127.0.0.1:6001;<br>    &#125;<br>    <br>    <span class="hljs-comment">#admin é¡µé¢</span><br>    location ^~/cdzb-admin &#123;<br>        add_header    Cache-Control  max-age=600;<br>        root /data/www/;<br>        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /cdzb-admin/index.html;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>nginxå­åŸŸå</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dockeråˆ›å»ºå®¹å™¨å‘½ä»¤</title>
    <link href="/2025/12/05/%E8%BF%90%E7%BB%B4/docker%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2025/12/05/%E8%BF%90%E7%BB%B4/docker%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="dockeråˆ›å»ºå®¹å™¨å¸¸ç”¨å‘½ä»¤"><a href="#dockeråˆ›å»ºå®¹å™¨å¸¸ç”¨å‘½ä»¤" class="headerlink" title="dockeråˆ›å»ºå®¹å™¨å¸¸ç”¨å‘½ä»¤"></a>dockeråˆ›å»ºå®¹å™¨å¸¸ç”¨å‘½ä»¤</h1><ul><li>åˆ›å»ºmysqlå‘½ä»¤ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -p 3306:3306 --name mysql \<br>-v /Users/apple/Documents/docker/mysql8.4.7/log:/var/log/mysql \<br>-v /Users/apple/Documents/docker/mysql8.4.7/data:/var/lib/mysql \<br>-v /Users/apple/Documents/docker/mysql8.4.7/conf:/etc/mysql/conf.d \<br>-v /Users/apple/Documents/docker/mysql8.4.7/mysql-files:/var/lib/mysql-files \<br>-e MYSQL_ROOT_PASSWORD=123456 \<br>-d mysql:8.4.7 \<br>--character-set-server=utf8mb4 \<br>--collation-server=utf8mb4_unicode_ci \<br></code></pre></td></tr></table></figure><ul><li><p>åˆ›å»ºrediså‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -p 6379:6379 --name redis \<br>-v /Users/apple/Documents/docker/redis7.4.7/data:/data \<br>-v /Users/apple/Documents/docker/redis7.4.7/conf/redis.conf:/etc/redis/redis.conf \<br>-d redis:7.4.7 \<br>redis-server /etc/redis/redis.conf<br></code></pre></td></tr></table></figure></li><li><p>åˆ›å»ºminioå‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run  -p 9000:9000 -p 9001:9001 \<br>--name minio \<br>-d \<br>-e &quot;MINIO_ROOT_USER=minio&quot; \<br>-e &quot;MINIO_ROOT_PASSWORD=dong123456&quot; \<br>-v /Users/apple/Documents/docker/minio/data:/data \<br>minio/minio:latest \<br>server /data --console-address &quot;:9001&quot; -address &quot;:9000&quot;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MCPå­¦ä¹ </title>
    <link href="/2025/11/12/AGI/MCP/MCP%E5%AD%A6%E4%B9%A0/"/>
    <url>/2025/11/12/AGI/MCP/MCP%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<h1 id="MCPå­¦ä¹ "><a href="#MCPå­¦ä¹ " class="headerlink" title="MCPå­¦ä¹ "></a>MCPå­¦ä¹ </h1><h2 id="MCPæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#MCPæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MCPæ˜¯ä»€ä¹ˆï¼Ÿ"></a>MCPæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>MCPå…¨ç§°ï¼šmodel context protocolæ¨¡å‹ä¸Šä¸‹æ–‡åè®®</p><p>å¤§ç™½è¯è§£é‡Šï¼š</p><p>agentåœ¨å¸®ä½ åšäº‹æƒ…çš„æ—¶å€™ï¼Œæ¯”å¦‚æƒ³è¦è·å–ä»Šå¤©çš„å¤©æ°”æƒ…å†µï¼Œé‚£ä¹ˆå°±éœ€è¦è·å–åˆ°æœ€æ–°çš„è·å–å¤©æ°”apiæ¥å£ã€‚è€ŒMCPå°±åƒä¸€ä¸ªUSBæ’æ§½ï¼Œå¯ä»¥è¿æ¥åˆ°ä¸åŒçš„æ•°æ®æ¥æºã€‚</p><p><img src="/2025/11/12/AGI/MCP/MCP%E5%AD%A6%E4%B9%A0/image-20251112171723098.png" alt="image-20251112171723098"></p><h3 id="MCP-Server-Client"><a href="#MCP-Server-Client" class="headerlink" title="MCP Server&#x2F;Client"></a>MCP Server&#x2F;Client</h3><p>è¿™å¼ å›¾æ¯”è¾ƒå½¢è±¡çš„è¯´æ˜MCP Serverå’ŒMCP Clientï¼š</p><p><img src="/2025/11/12/AGI/MCP/MCP%E5%AD%A6%E4%B9%A0/image-20251112172416300.png" alt="image-20251112172416300"></p>]]></content>
    
    
    
    <tags>
      
      <tag>MCP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="/2025/10/28/%E6%A1%86%E6%9E%B6/%E4%BA%8B%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    <url>/2025/10/28/%E6%A1%86%E6%9E%B6/%E4%BA%8B%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡"></a>åˆ†å¸ƒå¼äº‹åŠ¡</h1>]]></content>
    
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼äº‹åŠ¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çªå‡»æ£€æŸ¥</title>
    <link href="/2025/10/27/%E9%9D%A2%E8%AF%95/%E7%AA%81%E5%87%BB%E6%A3%80%E6%9F%A5/"/>
    <url>/2025/10/27/%E9%9D%A2%E8%AF%95/%E7%AA%81%E5%87%BB%E6%A3%80%E6%9F%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="çªå‡»æ£€æŸ¥"><a href="#çªå‡»æ£€æŸ¥" class="headerlink" title="çªå‡»æ£€æŸ¥"></a>çªå‡»æ£€æŸ¥</h1><h2 id="MySql"><a href="#MySql" class="headerlink" title="MySql"></a>MySql</h2><h3 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h3><h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><p>QAï¼šå¹¶å‘æ“ä½œä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><p>e.gï¼š</p><p>è„è¯»ï¼šè¯»åˆ°è¿˜æ²¡æäº¤çš„æ•°æ®</p><p>ä¸å¯é‡å¤è¯»ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡è¯»å–çš„åŒä¸€æ•°æ®ï¼Œæ•°æ®å‡ºç°ä¸ä¸€è‡´æƒ…å†µ</p><p>å¹»è¯»ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡è¯»å–çš„è®°å½•æ•°é‡ä¸ä¸€è‡´</p><p>QAï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿ</p><p>e.gï¼š</p><p>è¯»æœªæäº¤ï¼šä¼šæœ‰è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜</p><p>è¯»å·²æäº¤ï¼šä¼šæœ‰ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜</p><p>å¯é‡å¤è¯»ï¼šä¼šå‡ºç°å¹»è¯»é—®é¢˜</p><p>ä¸²è¡ŒåŒ–ï¼šæ— äº‹åŠ¡é—®é¢˜</p><p>QAï¼šMySqlé»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ã€å¯é‡å¤è¯»ã€‘çº§åˆ«ï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•è§£å†³å¹»è¯»é—®é¢˜çš„ï¼Ÿ</p><p>e.g</p><ul><li>é’ˆå¯¹ã€å¿«ç…§è¯»ã€‘ï¼Œä½¿ç”¨äº†MVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æ¥è§£å†³å¹»è¯»é—®é¢˜</li><li>é’ˆå¯¹ã€å½“å‰è¯»ã€‘ï¼Œä½¿ç”¨äº†ğŸ”’next-key-lock(è®°å½•é”+é—´éš™é”)æ¥è§£å†³å¹»è¯»é—®é¢˜</li></ul><p>QAï¼šè¯»è§†å›¾æ˜¯ä¸ªå•¥ï¼Ÿ</p><p><img src="/2025/10/27/%E9%9D%A2%E8%AF%95/%E7%AA%81%E5%87%BB%E6%A3%80%E6%9F%A5/image-20251028090220516.png" alt="image-20251028090220516"></p><p>è¯»è§†å›¾ä¸­æœ‰å››ä¸ªé‡è¦å­—æ®µï¼š</p><ul><li>creator_trx_idï¼šåˆ›å»ºReadViewçš„äº‹åŠ¡id</li><li>m_idsï¼šã€æ´»è·ƒäº‹åŠ¡ã€‘ä¸­çš„äº‹åŠ¡idåˆ—è¡¨ï¼›æ´»è·ƒçš„äº‹åŠ¡è¡¨ç¤ºå¼€å¯äº†äº‹åŠ¡ï¼Œè¿˜æ²¡æœ‰æäº¤çš„äº‹åŠ¡</li><li>min_trx_idï¼šã€æ´»è·ƒäº‹åŠ¡ã€‘åˆ—è¡¨ä¸­æœ€å°çš„äº‹åŠ¡id</li><li>max_trx_idï¼šå¾…åˆ†é…çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡id</li></ul><p>è¿˜æœ‰åœ¨<code>èšç°‡ç´¢å¼•</code>è®°å½•ä¸­çš„ä¸¤ä¸ªéšè—å­—æ®µï¼š</p><p><img src="/2025/10/27/%E9%9D%A2%E8%AF%95/%E7%AA%81%E5%87%BB%E6%A3%80%E6%9F%A5/image-20251028090736311.png" alt="image-20251028090736311"></p><ul><li>trx_idï¼šäº‹åŠ¡id</li><li>roll_pointerï¼šå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘æ—§ç‰ˆè®°å½•</li></ul><p>åˆ›å»ºReadViewåï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><p><img src="/2025/10/27/%E9%9D%A2%E8%AF%95/%E7%AA%81%E5%87%BB%E6%A3%80%E6%9F%A5/image-20251028090931623.png" alt="image-20251028090931623"></p><ul><li><p>å¦‚æœ<code>å½“å‰äº‹åŠ¡idå°äºmin_trx_id</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯åœ¨åˆ›å»ºReadViewä¹‹å‰å°±å·²ç»å­˜åœ¨çš„äº‹åŠ¡ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡æ˜¯<code>å¯è§çš„</code>ã€‚</p></li><li><p>å¦‚æœ<code>å½“å‰äº‹åŠ¡idå¤§äºç­‰äºmax_trx_id</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯åœ¨åˆ›å»ºReadViewä¹‹åæ‰åˆ›å»ºçš„äº‹åŠ¡ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡æ˜¯<code>ä¸å¯è§çš„</code>ã€‚</p></li><li><p>å¦‚æœ<code>å½“å‰äº‹åŠ¡idåœ¨min_trx_idå’Œmax_trx_idä¹‹é—´</code>ï¼Œé‚£ä¹ˆå°±åˆ¤æ–­å½“å‰äº‹åŠ¡idæ˜¯å¦åœ¨ã€æ´»è·ƒäº‹åŠ¡ã€‘åˆ—è¡¨ä¸­</p><ul><li>å½“å‰äº‹åŠ¡idåœ¨ã€æ´»è·ƒäº‹åŠ¡ã€‘åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºè¯¥ç‰ˆæœ¬ä¾ç„¶æ´»è·ƒå¹¶ä¸”æœªæäº¤ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬å¯¹å½“å‰äº‹åŠ¡æ˜¯<code>ä¸å¯è§çš„</code>ã€‚</li><li>å½“å‰äº‹åŠ¡idä¸åœ¨ã€æ´»è·ƒäº‹åŠ¡ã€‘åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºè¯¥æ´»è·ƒäº‹åŠ¡å·²ç»æäº¤äº†ï¼Œæ‰€ä»¥è¿™ä¸ªç‰ˆæœ¬å¯¹å½“å‰æ˜¯<code>å¯è§çš„</code>ã€‚</li></ul></li></ul><h3 id="é”"><a href="#é”" class="headerlink" title="é”"></a>é”</h3><p>é”åˆ†ä¸ºè¡¨çº§é”å’Œè¡Œçº§é”ã€‚</p><p>è¡¨çº§é”ï¼šè¡¨é”ã€æ„å‘é”ã€è‡ªå¢é”</p><blockquote><p> ä¸ºä»€ä¹ˆè¦æœ‰æ„å‘é”ï¼Ÿ</p><p>æ„å‘é”æ˜¯ä¸ºäº†å¿«é€Ÿåˆ¤æ–­è¡¨é‡Œæ˜¯å¦æœ‰è®°å½•è¢«åŠ é”ï¼Œå¦‚æœæ²¡æœ‰ã€æ„å‘é”ã€‘ï¼Œé‚£ä¹ˆå†åŠ ã€æ„å‘æ’å®ƒé”ã€‘çš„æ—¶å€™ï¼Œå°±éœ€è¦éå†è¡¨ä¸­æ‰€æœ‰è®°å½•ï¼Œåˆ¤è¯»è®°å½•æ˜¯å¦å­˜åœ¨ç‹¬å é”ï¼Œæ•ˆç‡å¾ˆä½ã€‚</p></blockquote><p>è¡Œçº§é”ï¼šrecord_lockï¼Œgrap_lockï¼Œnext_key_lock</p><h3 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h3><p>åˆ†ç±»ï¼šredo_logï¼Œundo_logï¼Œbing_log</p><p>redo_logï¼šç”¨äºæ•°æ®æŒä¹…åŒ–ä¿å­˜</p><blockquote><p>ä¸ºä»€ä¹ˆéœ€è¦redo_log?</p><p>e.gï¼šé˜²æ­¢æ–­ç”µå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼ï¼ï¼innodbå¼•æ“ä¼šå°†å†…å­˜æ•°æ®æ ‡è®°ä¸ºè„é¡µï¼Œç„¶åå†™å…¥redo_logæ–‡ä»¶ï¼Œä¸ä¼šç«‹å³åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œå°±ç›´æ¥ç»“æŸäº†ï¼Œç”±åå°çº¿ç¨‹å®šæœŸå°†ç¼“å­˜æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­ã€‚</p></blockquote><blockquote><p>redo_logæ…¢äº†æ€ä¹ˆåŠï¼Ÿ</p><p>redo_logæ—¥å¿—ä¸¤ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶æœ‰1Gçš„å­˜å‚¨å®¹é‡ï¼Œå½“redo_log_1æ–‡ä»¶å†™æ»¡åï¼Œä¼šå‘redo_log_2æ–‡ä»¶ä¸­å†™å…¥ï¼Œå½“redo_log_2æ–‡ä»¶ä¹Ÿå†™æ»¡åï¼Œä¼šå¾ªç¯é‡å†™åˆ°redo_log_1æ–‡ä»¶ä¸­è¿›è¡Œè¦†ç›–é‡å†™æ“ä½œã€‚</p></blockquote><p>undo_logï¼šç”¨äºå›æ»šæ“ä½œ</p><blockquote><p>ä¸ºä»€ä¹ˆéœ€è¦undo_log?</p><p>e.gï¼šä¸ºäº†äº‹åŠ¡å›æ»šï¼Œå°†æ•°æ®æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼Œä¿è¯åŸå­æ€§ï¼ï¼ï¼è¿˜æœ‰ä¸€ä¸ªä½œç”¨æ˜¯å¯ä»¥é€šè¿‡ReadView+undo_logå½¢æˆMVCCå¹¶å‘ç‰ˆæœ¬æ§åˆ¶ã€‚</p></blockquote><p>bin_logï¼šæ—¥å¿—åŒæ­¥æ“ä½œ</p><blockquote><p>ä¸ºä»€ä¹ˆä¼šæœ‰bin_logæ—¥å¿—æ–‡ä»¶ï¼Ÿ</p><p>mysqlä¼šåœ¨æ•°æ®æ“ä½œå®Œæˆåï¼Œåœ¨serverç«¯ç”Ÿæˆä¸€ä¸ªbin_logçš„æ—¥å¿—æ–‡ä»¶ï¼Œè€Œredo_logå’Œundo_logéƒ½æ˜¯åœ¨å¼•æ“å±‚ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ï¼Œbin_logæ–‡ä»¶ä¸­è®°å½•äº†æ•°æ®åº“è¡¨å’Œæ•°æ®å˜åŒ–çš„æ—¥å¿—ã€‚ä½†æ˜¯bin_logæœ‰ä¸ªé—®é¢˜å°±æ˜¯æ²¡æœ‰<code>å¥”æºƒæ¢å¤</code>èƒ½åŠ›ï¼Œæ‰€ä»¥å¼•å…¥äº†redo_log!!!</p></blockquote><p>ğŸŒˆ ä¸ºä»€ä¹ˆè¦éœ€è¦ä¸¤é˜¶æ®µæäº¤ï¼ï¼ï¼ï¼ï¼Ÿï¼Ÿ</p><p>å› ä¸ºè¦ä¿è¯redo_logå’Œbin_logåŒæ—¶å†™å…¥æˆåŠŸï¼ï¼ï¼</p><p>redo_logå†™å…¥åˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µï¼Œprepareé˜¶æ®µredo_logçš„çŠ¶æ€æ˜¯å‡†å¤‡çŠ¶æ€ï¼Œåœ¨commité˜¶æ®µï¼Œbin_logå†™å…¥æˆåŠŸåï¼Œå†å°†redo_logçš„çŠ¶æ€æ”¹æˆcommitçŠ¶æ€</p><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="æ•°æ®ç±»å‹"><a href="#æ•°æ®ç±»å‹" class="headerlink" title="æ•°æ®ç±»å‹"></a>æ•°æ®ç±»å‹</h3><h3 id="æŒä¹…åŒ–"><a href="#æŒä¹…åŒ–" class="headerlink" title="æŒä¹…åŒ–"></a>æŒä¹…åŒ–</h3><h4 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h4><p><code>AOFæ˜¯å­˜å‚¨çš„å‘½ä»¤è¯­å¥ã€‚</code></p><p>aofæä¾›äº†ä¸‰ç§å†™å›ç­–ç•¥ï¼š</p><ul><li>Alwaysï¼šæ€»æ˜¯å†™å›ï¼Œæ„æ€å°±æ˜¯æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ›´æ–°åˆ é™¤å‘½ä»¤ï¼Œéƒ½ä¼šä¿å­˜åˆ°aofæ–‡ä»¶ä¸­</li><li>EverySecï¼šæ¯ç§’å†™å›ï¼Œæ„æ€æ˜¯æ¯æ¬¡å†™å‘½ä»¤æ‰§è¡Œæ‰§è¡Œå®Œä¹‹åï¼Œå…ˆå°†å‘½ä»¤å†™å…¥åˆ°aofç¼“å†²åŒºä¸­ï¼Œæ¯éš”1ç§’å°†ç¼“å†²åŒºçš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ä¸­</li><li>Noï¼šä¸ç”±redisæ¥æ§åˆ¶å†™å›ç£ç›˜çš„æ—¶æœºï¼Œè½¬äº¤ç»™æ“ä½œç³»ç»Ÿæ¥æ§åˆ¶å†™å›çš„æ—¶æœºã€‚</li></ul><p>QA. ä»€ä¹ˆæ˜¯AOFçš„é‡å†™æœºåˆ¶ï¼Ÿ</p><p>e.gï¼šé¿å…aofçš„æ–‡ä»¶å¤ªå¤§ï¼Œæä¾›äº†redisçš„é‡å†™æœºåˆ¶ï¼Œå°†ä¹‹å‰é‡å¤æ€§çš„è¯­å¥å‘½ä»¤è¿›è¡Œ<code>å‹ç¼©</code>ï¼Œä»è€Œä½¿å¾—aofæ–‡ä»¶å˜å°ã€‚aofé‡å†™çš„æ—¶å€™ï¼Œä¼šæ–°å¢ä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½å¾€è¿™ä¸ªæ–°çš„æ–‡ä»¶ä¸­è¿½åŠ ï¼Œå½“é‡å†™æˆåŠŸåï¼Œè¿™ä¸ªæ–°çš„aofæ–‡ä»¶ä¼šæ›¿æ¢åŸæ¥çš„aofæ–‡ä»¶ï¼Œå¦‚æœé‡å†™å¤±è´¥äº†ï¼Œç›´æ¥åˆ é™¤è¿™ä¸ªæ–°çš„aofæ–‡ä»¶å³å¯ï¼Œä¸ä¼šé€ æˆæ•°æ®æ±¡æŸ“é—®é¢˜ã€‚</p><h4 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h4><p><code>RDBå­˜å‚¨çš„æ•°æ®å¿«ç…§ã€‚</code></p><h3 id="é«˜å¯ç”¨"><a href="#é«˜å¯ç”¨" class="headerlink" title="é«˜å¯ç”¨"></a>é«˜å¯ç”¨</h3><ul><li>rediså•èŠ‚ç‚¹éƒ¨ç½²</li><li>redisé«˜å¯ç”¨æ¶æ„</li><li>redis-sentinelå“¨å…µæ¨¡å¼æ¶æ„</li><li>redis-clusteré›†ç¾¤æ¶æ„<ul><li>é€šè¿‡<code>Gossipä¼ æ’­åè®®</code>ï¼Œå°†æœ¬èŠ‚ç‚¹å­˜å‚¨çš„ä¿¡æ¯ä¼ æ’­å‡ºå»ï¼Œç›´åˆ°æ‰€æœ‰çš„èŠ‚ç‚¹æ•°æ®ä¸€è‡´ã€‚</li><li>redis-clusteré›†ç¾¤ä¸€å…±åˆ†äº†<code>16384ä¸ªæ§½</code>ï¼Œå‡åŒ€çš„åˆ†å¸ƒåœ¨å¤šä¸ªä¸»èŠ‚ç‚¹ä¸Šã€‚</li><li>é€šè¿‡è®¡ç®—keyçš„hashå€¼ï¼Œç„¶åå†å¯¹16384ä¸ªæ§½å–æ¨¡ï¼Œå¾—åˆ°å…·ä½“çš„æ§½ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰åœ¨å½“å‰èŠ‚ç‚¹ï¼Œé€šè¿‡<code>MOVEDé‡å®šå‘</code>åˆ°å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ§½æ­£åœ¨è½¬ç§»ï¼Œåˆ™é€šè¿‡<code>ACKé‡å®šå‘</code>åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šã€‚</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>çªå‡»æ£€æŸ¥</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bc_linuxå®‰è£…åŒ…å‘½ä»¤</title>
    <link href="/2025/10/16/%E8%BF%90%E7%BB%B4/bc-linux%E5%AE%89%E8%A3%85%E5%8C%85%E5%91%BD%E4%BB%A4/"/>
    <url>/2025/10/16/%E8%BF%90%E7%BB%B4/bc-linux%E5%AE%89%E8%A3%85%E5%8C%85%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="BC-Linuxå®‰è£…åŒ…å‘½ä»¤è¯­å¥"><a href="#BC-Linuxå®‰è£…åŒ…å‘½ä»¤è¯­å¥" class="headerlink" title="BC_Linuxå®‰è£…åŒ…å‘½ä»¤è¯­å¥"></a>BC_Linuxå®‰è£…åŒ…å‘½ä»¤è¯­å¥</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">rpm -Uvh *.rpm --nodeps --force<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
    </categories>
    
    
    <tags>
      
      <tag>bc_linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶</title>
    <link href="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/"/>
    <url>/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/</url>
    
    <content type="html"><![CDATA[<h1 id="æ‰‹å†™åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶"><a href="#æ‰‹å†™åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶" class="headerlink" title="æ‰‹å†™åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶"></a>æ‰‹å†™åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶</h1><h2 id="å„ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶"><a href="#å„ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶" class="headerlink" title="å„ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶"></a>å„ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶</h2><h3 id="RabbitMQåŸç†"><a href="#RabbitMQåŸç†" class="headerlink" title="RabbitMQåŸç†"></a>RabbitMQåŸç†</h3><p>rabbitmqæ¶ˆæ¯å‘é€å¤§æ¦‚é“¾è·¯æ‰€ç¤ºï¼š</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014224845284.png" alt="image-20251014224845284"></p><h4 id="rabbitmqåˆ†å‘çš„å‡ ç§æ¨¡å¼"><a href="#rabbitmqåˆ†å‘çš„å‡ ç§æ¨¡å¼" class="headerlink" title="rabbitmqåˆ†å‘çš„å‡ ç§æ¨¡å¼"></a>rabbitmqåˆ†å‘çš„å‡ ç§æ¨¡å¼</h4><ul><li><p>Fanoutç±»å‹</p><p>å¯ä»¥ç†è§£ä¸ºå¹¿æ’­æ¨¡å¼ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014225416900.png" alt="image-20251014225416900"></p></li><li><p>Directç±»å‹</p><p>æ ¹æ®RoutingKeyè·¯ç”±åˆ°å¯¹åº”æŒ‡å®šçš„é˜Ÿåˆ—ä¸Š</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014225541218.png" alt="image-20251014225541218"></p></li><li><p>Topicç±»å‹</p><p>æ ¹æ®é€šé…ç¬¦åŒ¹é…åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸Š</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014225638381.png" alt="image-20251014225638381"></p></li></ul><h4 id="é”™è¯¯æ¶ˆæ¯"><a href="#é”™è¯¯æ¶ˆæ¯" class="headerlink" title="é”™è¯¯æ¶ˆæ¯"></a>é”™è¯¯æ¶ˆæ¯</h4><p>æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥ï¼Œä¼šè¢«æŠ•é€’åˆ°<code>æ­»ä¿¡é˜Ÿåˆ—</code>ä¸­ï¼Œè¿‡ä¸€æ®µæ—¶é—´å†è¿›è¡Œæ¶ˆè´¹ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014230210708.png" alt="image-20251014230210708"></p><h4 id="é¡ºåºæ¶ˆè´¹è®¾è®¡"><a href="#é¡ºåºæ¶ˆè´¹è®¾è®¡" class="headerlink" title="é¡ºåºæ¶ˆè´¹è®¾è®¡"></a>é¡ºåºæ¶ˆè´¹è®¾è®¡</h4><p>ä½¿ç”¨å•é˜Ÿåˆ—ï¼Œå¤šè¿›ç¨‹æ¶ˆè´¹ï¼Œæ˜¯æ— æ³•ä¿è¯å¤„ç†é¡ºåºçš„ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014230322699.png" alt="image-20251014230322699"></p><p>ä½¿ç”¨å•é˜Ÿåˆ—ï¼Œå¤šæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä¹Ÿæ˜¯æ— æ³•ä¿è¯é¡ºåºçš„ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014230636978.png" alt="image-20251014230636978"></p><blockquote><p>é¡ºåºæ‰§è¡Œåº”ç”¨åœºæ™¯ï¼š</p><p>mysqlä¸­binlogåŒæ­¥ï¼Œä½¿ç”¨canelåŒæ­¥biglogæ—¥å¿—ç”Ÿæˆä¸€ä¸ªåŒæ­¥æ¶ˆæ¯ï¼Œåˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä¸€å®šè¦ä¿è¯æ¶ˆæ¯çš„æœ‰åºæ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œä¸€å®šè¦ä½¿ç”¨å•é˜Ÿåˆ—ã€å•æ¶ˆè´¹è€…ã€å•çº¿ç¨‹æ–¹å¼ã€‚</p></blockquote><h3 id="RocketMQåŸç†"><a href="#RocketMQåŸç†" class="headerlink" title="RocketMQåŸç†"></a>RocketMQåŸç†</h3><h4 id="RocketMQçš„ç»„æˆéƒ¨åˆ†"><a href="#RocketMQçš„ç»„æˆéƒ¨åˆ†" class="headerlink" title="RocketMQçš„ç»„æˆéƒ¨åˆ†"></a>RocketMQçš„ç»„æˆéƒ¨åˆ†</h4><ul><li>Broker</li><li>NameServerï¼ˆæ³¨å†Œä¸­å¿ƒï¼‰</li></ul><p>å®¢æˆ·ç«¯å’ŒNameServerå»ºç«‹é•¿è¿æ¥ï¼Œç„¶åè·å–åˆ°ä¸»çš„brokerçš„åœ°å€ï¼Œç„¶åå†å»è®¿é—®Brokerè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ã€‚ï¼ˆä¸€å®šæ˜¯å…ˆåˆ°<code>NameServer</code>è·å–åˆ°brokeråœ°å€ï¼Œç„¶åå†å’Œbrokerè¿›è¡Œé•¿è¿æ¥ï¼‰</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014231540088.png" alt="image-20251014231540088"></p><h4 id="RocketMQå‘é€é“¾è·¯"><a href="#RocketMQå‘é€é“¾è·¯" class="headerlink" title="RocketMQå‘é€é“¾è·¯"></a>RocketMQå‘é€é“¾è·¯</h4><p>æ¶ˆæ¯ä¼šå…ˆå‘é€åˆ°brokerç«¯è¿›è¡Œå­˜å‚¨ï¼Œç„¶åè§¦å‘ä¸€ä¸ªdispatchçš„åŠ¨ä½œï¼Œå°†æ¶ˆæ¯çš„<code>ç´¢å¼•</code>å‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚æ¯ä¸ªæ¶ˆè´¹è€…å’Œå…·ä½“çš„ä¸€æ¡é˜Ÿåˆ—è¿›è¡Œç»‘å®šï¼Œç„¶åè¿›è¡Œæ‹‰å–dispatchè¿‡æ¥çš„æ¶ˆæ¯ã€‚ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸­ï¼Œåªä¼šæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…è·å–åˆ°æ¶ˆæ¯ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251014232059616.png" alt="image-20251014232059616"></p><ul><li>RocketMQçš„æ¶ˆæ¯å­˜æ”¾å†CommitLogé‡Œé¢ï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­å­˜å‚¨çš„æ˜¯æ¶ˆæ¯çš„<code>ç´¢å¼•</code>ã€‚</li><li>RocketMQçš„ä¸€æ¡é˜Ÿåˆ—ï¼Œä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…å ç”¨ï¼Œä¸èƒ½è¢«å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶è®¿é—®ã€‚</li><li>æ¶ˆè´¹è€…æ‹‰å–åˆ°æ¶ˆæ¯çš„<code>ç´¢å¼•</code>æ¶ˆæ¯åï¼Œä¼šåˆ°CommitLogä¸­è·å–åˆ°çœŸæ­£çš„æ¶ˆæ¯ï¼Œæå‡äº†è®¿é—®æ•ˆç‡ã€‚</li></ul><h4 id="RocketMQæ¶ˆè´¹ç»„çš„æ¦‚å¿µ"><a href="#RocketMQæ¶ˆè´¹ç»„çš„æ¦‚å¿µ" class="headerlink" title="RocketMQæ¶ˆè´¹ç»„çš„æ¦‚å¿µ"></a>RocketMQæ¶ˆè´¹ç»„çš„æ¦‚å¿µ</h4><p>åŒä¸€ä¸ªtopicä¸‹ä¼šæœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸åŒçš„ç»„ï¼ŒåŒä¸€ä¸ªç»„ä¸­çš„æ¶ˆè´¹è€…æ˜¯äº’æ–¥çš„ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015053618161.png" alt="image-20251015053618161"></p><h4 id="æ¶ˆæ¯å›æº¯åŠŸèƒ½"><a href="#æ¶ˆæ¯å›æº¯åŠŸèƒ½" class="headerlink" title="æ¶ˆæ¯å›æº¯åŠŸèƒ½"></a>æ¶ˆæ¯å›æº¯åŠŸèƒ½</h4><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015053840913.png" alt="image-20251015053840913"></p><h4 id="äº‹åŠ¡æ¶ˆæ¯"><a href="#äº‹åŠ¡æ¶ˆæ¯" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯"></a>äº‹åŠ¡æ¶ˆæ¯</h4><p>ä¸»è¦è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ä¸‹çš„ä¸šåŠ¡åœºæ™¯ï¼Œé‡‡ç”¨çš„æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p><p>RocketMQé‡‡ç”¨äº†2PCæ€æƒ³æ¥å®ç°äº‹åŠ¡æ¶ˆæ¯ï¼ŒåŒæ—¶æœ‰ä¸ªè¡¥å¿æœºåˆ¶ã€‚</p><h4 id="RocketMQé«˜æ€§èƒ½åŸç†"><a href="#RocketMQé«˜æ€§èƒ½åŸç†" class="headerlink" title="RocketMQé«˜æ€§èƒ½åŸç†"></a>RocketMQé«˜æ€§èƒ½åŸç†</h4><ul><li><p>ä½¿ç”¨äº†MMAPæŠ€æœ¯<a href="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/" title="é›¶æ‹·è´">é›¶æ‹·è´</a>ï¼Œå°†ç£ç›˜ç©ºé—´æ˜ å°„åˆ°å†…å­˜åŒºåŸŸï¼Œæ‰€æœ‰çš„å†™æ“ä½œéƒ½æ˜¯å†™å…¥åˆ°æ˜ å°„çš„å†…å­˜åŒºåŸŸã€‚</p></li><li><p>é¢„æ˜ å°„+å†…å­˜é”å®šæŠ€æœ¯ï¼ˆæ“ä½œç³»ç»Ÿapiï¼‰</p></li></ul><h3 id="KafkaåŸç†"><a href="#KafkaåŸç†" class="headerlink" title="KafkaåŸç†"></a>KafkaåŸç†</h3><p>æ—©æœŸçš„kafkaéœ€è¦å’Œzookeeperç»„åˆä½¿ç”¨ï¼Œzookeeperä¸»è¦è´Ÿè´£å…·ä½“çš„brokeræœºå™¨ä¿¡æ¯ã€‚</p><ul><li>brokerå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæŠŠåœ°å€æ³¨å†Œåˆ°zkä¸Šï¼Œä¹Ÿå°±æ˜¯&#x2F;kafka&#x2F;broker&#x2F;idsç›®å½•ä¸­</li><li>ç„¶åå¤šä¸ªbrokeræŠ¢å zkçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåœ¨&#x2F;kafka&#x2F;controllerç›®å½•ä¸­ï¼ŒæŠ¢åˆ°è¯¥èŠ‚ç‚¹çš„brokerå°±æ˜¯controllerè§’è‰²ï¼Œä¸»è¦è´Ÿè´£topicã€åˆ†åŒºçš„ç®¡ç†ã€‚è€ŒæŠ¢åˆ°controllerèŠ‚ç‚¹çš„brokerä¸Šä¼šä¿å­˜æœ€å…¨çš„brokeræ•°æ®ä¿¡æ¯ï¼Œå…¶å®ƒçš„brokerèŠ‚ç‚¹éœ€è¦å¾€è¿™å°æœºå™¨ä¸ŠæŠ¥è‡ªå·±èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</li></ul><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015055151666.png" alt="image-20251015055151666"></p><p>åæœŸé‡‡ç”¨äº†è‡ªç ”çš„Controller Quorumæ›¿æ¢äº†ä¹‹å‰zkçš„è§’è‰²ï¼ŒController Quorumé‡‡ç”¨äº†<code>kraftç®—æ³•</code>æ¥ä¿è¯é›†ç¾¤ä¸€è‡´æ€§çš„ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015061219185.png" alt="image-20251015061219185"></p><p>kafkaæ˜¯åŸºäºå¤šä¸ªä¸»é¢˜ï¼Œå¤šä¸ªpartitionæ¨¡å—ç®¡ç†çš„ï¼Œå¯ä»¥è®©å¤šæ ¸cpuçš„è®¡ç®—å……åˆ†å‘æŒ¥ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015060210515.png" alt="image-20251015060210515"></p><p>åœ¨kafkaé›†ç¾¤æ¶æ„ä¸­ï¼Œä¸åŒçš„partitionæ–‡ä»¶ä¼šè¢«åˆ†æ•£åˆ°ä¸åŒçš„brokerä¸Šå­˜å‚¨ï¼Œè¿™æ ·å°±å¯ä»¥è®©ä¸åŒçš„æœºå™¨è´Ÿè´£ä¸åŒçš„partitionå†™å…¥ï¼Œæå‡æ€§èƒ½ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015060343882.png" alt="image-20251015060343882"></p><h4 id="kafkaå­˜å‚¨ç»“æ„"><a href="#kafkaå­˜å‚¨ç»“æ„" class="headerlink" title="kafkaå­˜å‚¨ç»“æ„"></a>kafkaå­˜å‚¨ç»“æ„</h4><p>kafkaé‡Œé¢çš„æ¶ˆæ¯å­˜å‚¨å®é™…ä¸Šæ˜¯å­˜åœ¨ä¸€ä¸ªä¸ªä¸åŒçš„segmentä¸­çš„ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015060513719.png" alt="image-20251015060513719"></p><ul><li>.logæ–‡ä»¶</li></ul><p>â€‹å®é™…çš„æ•°æ®å­˜å‚¨æ–‡ä»¶ï¼Œé¡ºåºå†™å…¥</p><ul><li>.indexæ–‡ä»¶</li></ul><p>â€‹ç´¢å¼•æ–‡ä»¶ï¼Œå­˜å‚¨äº†.logçš„åœ°å€ä¿¡æ¯</p><ul><li>.timestampæ–‡ä»¶</li></ul><p>â€‹è®°å½•å“ªäº›æ¶ˆæ¯åœ¨7å¤©å†…ï¼Œè¶…è¿‡7å¤©ï¼Œä¸€èˆ¬ä¼šè¢«åˆ é™¤</p><h4 id="kafkaé«˜æ€§èƒ½åŸç†"><a href="#kafkaé«˜æ€§èƒ½åŸç†" class="headerlink" title="kafkaé«˜æ€§èƒ½åŸç†"></a>kafkaé«˜æ€§èƒ½åŸç†</h4><ul><li>å†™å…¥ä½¿ç”¨äº†mmapæŠ€æœ¯ï¼Œå†…å­˜æ˜ å°„æŠ€æœ¯</li><li>æ‹‰å–æ•°æ®ä½¿ç”¨äº†sendfileæŠ€æœ¯ï¼ˆ<a href="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/" title="é›¶æ‹·è´">é›¶æ‹·è´</a>ï¼‰</li></ul><h3 id="ç‰¹æ€§å¯¹æ¯”"><a href="#ç‰¹æ€§å¯¹æ¯”" class="headerlink" title="ç‰¹æ€§å¯¹æ¯”"></a>ç‰¹æ€§å¯¹æ¯”</h3><table><thead><tr><th align="center"></th><th align="left">RabbitMQ</th><th align="left">RocketMQ</th><th align="left">Kafka</th></tr></thead><tbody><tr><td align="center">è¯­è¨€</td><td align="left">erlang</td><td align="left">java</td><td align="left">scala&#x2F;java</td></tr><tr><td align="center">æ€§èƒ½</td><td align="left">ä¸€èˆ¬</td><td align="left">å¼º</td><td align="left">éå¸¸å¼º</td></tr><tr><td align="center">æ¶ˆæ¯å­˜å‚¨</td><td align="left">æŒ‰ç…§topicå­˜å‚¨ï¼Œæ¶ˆæ¯å¤åˆ¶åˆ°å¤šä¸ªé˜Ÿåˆ—ä¸­</td><td align="left">æ‰€æœ‰topicæ¶ˆæ¯ç»Ÿä¸€å­˜åœ¨commitlogä¸­</td><td align="left">æŒ‰topicç²’åº¦åˆ†æ•£åœ¨ä¸åŒçš„partitionä¸­ï¼Œåº•å±‚ä»¥segmentçš„.logæ–‡ä»¶è¿›è¡Œå®é™…æ•°æ®å­˜å‚¨</td></tr><tr><td align="center">è¿ç»´éš¾åº¦</td><td align="left">ç®€å•</td><td align="left">ç®€å•</td><td align="left">é«˜</td></tr><tr><td align="center">é€‚åº”åœºæ™¯</td><td align="left">å¯é æ€§è¦æ±‚é«˜çš„åœºæ™¯</td><td align="left">- æ”¯æŒäº‹åŠ¡<br>- æ”¯æŒå»¶è¿Ÿæ¶ˆæ¯<br>- å®æ—¶è®¡ç®—ï¼Œç§’æ€æ´»åŠ¨</td><td align="left">- å®æ—¶è®¡ç®—ï¼Œå¤§æ•°æ®åˆ†æ<br>- æ—¥å¿—é‡‡é›†<br></td></tr><tr><td align="center">å¤±è´¥é‡è¯•</td><td align="left">æ”¯æŒ</td><td align="left">æ”¯æŒ</td><td align="left">éœ€è¦æ‰‹åŠ¨å®ç°</td></tr><tr><td align="center">æ€§èƒ½</td><td align="left">30mb&#x2F;s</td><td align="left">650mb&#x2F;s</td><td align="left">650mb&#x2F;sï¼Ÿï¼Ÿï¼Ÿ</td></tr></tbody></table><h2 id="æ‰‹å†™MQ"><a href="#æ‰‹å†™MQ" class="headerlink" title="æ‰‹å†™MQ"></a>æ‰‹å†™MQ</h2><h3 id="å‰æè§„åˆ’"><a href="#å‰æè§„åˆ’" class="headerlink" title="å‰æè§„åˆ’"></a>å‰æè§„åˆ’</h3><h4 id="æ–‡ä»¶å¦‚ä½•å­˜å‚¨ï¼Ÿ"><a href="#æ–‡ä»¶å¦‚ä½•å­˜å‚¨ï¼Ÿ" class="headerlink" title="æ–‡ä»¶å¦‚ä½•å­˜å‚¨ï¼Ÿ"></a>æ–‡ä»¶å¦‚ä½•å­˜å‚¨ï¼Ÿ</h4><p>å•æ–‡ä»¶ vs å¤šæ–‡ä»¶</p><p>brokerä¸­ä½¿ç”¨é˜Ÿåˆ—æ¥ç»´æŠ¤<code>offset</code></p><p>æœ‰3ä¸ªoffsetå­—æ®µæ¥æ ‡è¯†æ¶ˆæ¯æ¶ˆè´¹åˆ°å“ªäº†</p><ul><li>lastOffsetï¼šæœ€ä¹…åç§»é‡</li><li>currentOffsetï¼šå½“å‰åç§»é‡</li><li>lastestOffsetï¼šæœ€æ–°åç§»é‡</li></ul><h4 id="ä¸ºä»€ä¹ˆéœ€è¦æ³¨å†Œä¸­å¿ƒï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ³¨å†Œä¸­å¿ƒï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ³¨å†Œä¸­å¿ƒï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦æ³¨å†Œä¸­å¿ƒï¼Ÿ</h4><ul><li>brokeråœ°å€ä¼šå‘ç”Ÿå˜åŒ–</li></ul><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015111034953.png" alt="image-20251015111034953"></p><p>å¼•å…¥æ³¨å†Œä¸­å¿ƒç»´æŠ¤brokerèŠ‚ç‚¹ä¿¡æ¯ï¼Œå½“æœ‰å¤šä¸ªbrokerèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥ä»æ³¨å†Œä¸­å¿ƒè·å–åˆ°brokerèŠ‚ç‚¹åˆ—è¡¨ã€‚</p><p>brokerèŠ‚ç‚¹åœ°å€å˜æ›´é€šè¿‡æ³¨å†Œä¸­å¿ƒæ¨é€ç»™å®¢æˆ·ç«¯ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015111103975.png" alt="image-20251015111103975"></p><p>å®æ—¶å˜æ›´é€šçŸ¥</p><ul><li>brokerå®šæ—¶ä¸ŠæŠ¥å¿ƒè·³</li><li>å®¢æˆ·ç«¯ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–brokeråœ°å€</li><li>åç»­å®¢æˆ·ç«¯é€šè¿‡é•¿è¿æ¥ï¼Œç›‘å¬æ³¨å†Œä¸­å¿ƒä¸Šbrokeråœ°å€çš„å˜åŒ–ï¼ŒåŠæ—¶æ›´æ–°å®¢æˆ·ç«¯ä¸Šbrokeråœ°å€</li></ul><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015111407962.png" alt="image-20251015111407962"></p><h4 id="brokerç®¡ç†"><a href="#brokerç®¡ç†" class="headerlink" title="brokerç®¡ç†"></a>brokerç®¡ç†</h4><ul><li>brokerä¸­offsetçš„ç®¡ç†ã€æŸ¥çœ‹å’Œä¿®æ”¹</li><li>é€‰ä¸¾</li><li>ç›‘æ§</li></ul><h4 id="å¤šèŠ‚ç‚¹å­˜å‚¨æ¶æ„åº”è¯¥æ€ä¹ˆè®¾è®¡ï¼Ÿ"><a href="#å¤šèŠ‚ç‚¹å­˜å‚¨æ¶æ„åº”è¯¥æ€ä¹ˆè®¾è®¡ï¼Ÿ" class="headerlink" title="å¤šèŠ‚ç‚¹å­˜å‚¨æ¶æ„åº”è¯¥æ€ä¹ˆè®¾è®¡ï¼Ÿ"></a>å¤šèŠ‚ç‚¹å­˜å‚¨æ¶æ„åº”è¯¥æ€ä¹ˆè®¾è®¡ï¼Ÿ</h4><ul><li>ä¸»èŠ‚ç‚¹æ‰¿æ‹…å†™æ“ä½œ</li><li>ä»èŠ‚ç‚¹åŒæ­¥æ•°æ®ï¼Œæ‰¿æ‹…è¯»æ“ä½œ</li></ul><p>æ¶ˆæ¯æŒä¹…åŒ–</p><ul><li>å¼‚æ­¥åˆ·ç›˜ï¼ˆæ€§èƒ½é«˜ï¼Œä½†æ˜¯æœ‰ä¸¢å¤±é£é™©ï¼‰</li><li>å¼ºåˆ¶åˆ·ç›˜ï¼ˆ<code>fsyncå‡½æ•°</code>ï¼Œæ€§èƒ½å·®ï¼Œä½†æ˜¯æ•°æ®å‡†ç¡®ï¼Œä¸ä¼šä¸¢å¤±ï¼‰</li></ul><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015112435632.png" alt="image-20251015112435632"></p><p>ä¸»ä»å¤åˆ¶å®ç°ç»†èŠ‚</p><p>ackå’Œsend msgé¡ºåºåº”è¯¥æ˜¯æ€æ · ï¼Ÿ</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015113011276.png" alt="image-20251015113011276"></p><p>ğŸ‘†ğŸ»ä¸Šé¢çš„æ–¹å¼ä¼šå¯¼è‡´æ€§èƒ½éå¸¸å·®ï¼Œåº”è¯¥ä¸»èŠ‚ç‚¹è¦è½ç›˜ï¼Œå¹¶ä¸”å°†æ•°æ®åŒæ­¥ç»™ä»èŠ‚ç‚¹åï¼Œæ‰è¿”å›ackç»™å®¢æˆ·ç«¯ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015113320892.png" alt="image-20251015113320892"></p><p>ğŸ‘†ğŸ»ä¸Šé¢çš„æ–¹å¼ï¼Œwrite dbçº¿ç¨‹ååé‡ä¸é«˜ï¼Œå¢åŠ ä¸»èŠ‚ç‚¹æŸè€—ï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹è¿›è¡Œæ•°æ®åŒæ­¥ï¼Ÿ</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015113622069.png" alt="image-20251015113622069"></p><p>ğŸ‘†ğŸ»ä¸Šé¢çš„æ–¹å¼å¢åŠ ä¸€ä¸ªsyncå¼‚æ­¥çº¿ç¨‹è¿›è¡Œæ•°æ®åŒæ­¥ç»™slaveã€‚</p><p>ç»§ç»­ä¼˜åŒ–ï¼š</p><p>å¢åŠ ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥ä¸€æ¬¡åŒæ­¥ä¸€ä¸ªï¼Œæˆ–è€…åŒæ­¥å¤šä¸ªï¼Œæ‰¹é‡åŒæ­¥ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015113927276.png" alt="image-20251015113927276"></p><h4 id="æ¶ˆæ¯é‡è¯•æœºåˆ¶å¦‚ä½•å®ç°ï¼Ÿ"><a href="#æ¶ˆæ¯é‡è¯•æœºåˆ¶å¦‚ä½•å®ç°ï¼Ÿ" class="headerlink" title="æ¶ˆæ¯é‡è¯•æœºåˆ¶å¦‚ä½•å®ç°ï¼Ÿ"></a>æ¶ˆæ¯é‡è¯•æœºåˆ¶å¦‚ä½•å®ç°ï¼Ÿ</h4><p>æ¶ˆæ¯æ²¡æœ‰åŠæ—¶è¿”å›ackç»™brokerï¼Œbrokerè¦é‡æ–°æŠ•é€’ã€‚</p><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015115225557.png" alt="image-20251015115225557"></p><blockquote><p>kafkaæ²¡æœ‰é‡è¯•+æ­»ä¿¡é˜Ÿåˆ—çš„æ–¹å¼ï¼Œå¦‚ä½•æ¶ˆè´¹å¤±è´¥ï¼Œä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œä¼šé€ æˆæ¶ˆæ¯å †ç§¯é—®é¢˜ï¼ï¼ï¼</p></blockquote><h4 id="å»¶è¿Ÿæ¶ˆæ¯æœºåˆ¶"><a href="#å»¶è¿Ÿæ¶ˆæ¯æœºåˆ¶" class="headerlink" title="å»¶è¿Ÿæ¶ˆæ¯æœºåˆ¶"></a>å»¶è¿Ÿæ¶ˆæ¯æœºåˆ¶</h4><ul><li>è®¢å•è‡ªåŠ¨å–æ¶ˆ</li><li>å……ç”µæ¡©æ–­ç”µæ“ä½œ</li><li>redisç¼“å­˜çš„å»¶è¿ŸåŒåˆ </li></ul><p>å®ç°æ–¹æ¡ˆï¼š</p><p>åŸºäºMQæ–¹å¼å’Œå®šæ—¶ä»»åŠ¡ã€‚</p><p>mqåº•å±‚ä½¿ç”¨çš„<code>æ—¶é—´è½®</code>æ–¹å¼æ¥å®ç°å»¶è¿Ÿé˜Ÿåˆ—ã€‚</p><h4 id="äº‹åŠ¡æ¶ˆæ¯å®ç°æ–¹å¼"><a href="#äº‹åŠ¡æ¶ˆæ¯å®ç°æ–¹å¼" class="headerlink" title="äº‹åŠ¡æ¶ˆæ¯å®ç°æ–¹å¼"></a>äº‹åŠ¡æ¶ˆæ¯å®ç°æ–¹å¼</h4><p>è§£å†³æ‰‹æ®µï¼š</p><ul><li>å¼ºä¸€è‡´æ€§ï¼ˆ2PCã€3PCï¼‰</li><li>TCC</li><li>æœ€ç»ˆä¸€è‡´æ€§</li></ul><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251015140306389.png" alt="image-20251015140306389"></p><ul><li>brokerç«¯å®šæ—¶æ£€æµ‹å®¢æˆ·ç«¯äº‹åŠ¡çŠ¶æ€</li><li>åˆ©ç”¨æ—¶é—´è½®ç»„ä»¶ï¼Œéš”ä¸€æ®µæ—¶é—´å»æ£€æµ‹æœ¬åœ°äº‹åŠ¡çŠ¶æ€</li><li>å®¢æˆ·ç«¯éœ€è¦æœ‰ä¸€å¼ æœ¬åœ°äº‹åŠ¡è¡¨è®°å½•äº‹åŠ¡çŠ¶æ€</li><li>åŠæäº¤å’Œå…¨æäº¤</li></ul><h4 id="å†…å­˜æ˜ å°„è‡ªæ‰©å®¹æœºåˆ¶"><a href="#å†…å­˜æ˜ å°„è‡ªæ‰©å®¹æœºåˆ¶" class="headerlink" title="å†…å­˜æ˜ å°„è‡ªæ‰©å®¹æœºåˆ¶"></a>å†…å­˜æ˜ å°„è‡ªæ‰©å®¹æœºåˆ¶</h4><p>æ˜ å°„çš„å†…å­˜ç©ºé—´æ»¡äº†æ€ä¹ˆåŠï¼Ÿï¼Ÿ</p><h3 id="æŒä¹…åŒ–"><a href="#æŒä¹…åŒ–" class="headerlink" title="æŒä¹…åŒ–"></a>æŒä¹…åŒ–</h3><ul><li>å†™å…¥commitLogæ–‡ä»¶</li><li>å°†æ¶ˆæ¯åˆ†å‘åˆ°é˜Ÿåˆ—ä¸­</li></ul><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251016155356397.png" alt="image-20251016155356397"></p><p>å°†æ¶ˆæ¯åˆ†æˆä¸»è¦çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>æ¶ˆæ¯ä½“</li><li>æ¶ˆæ¯å¤§å°ï¼ˆæ–¹ä¾¿mmapè¯»å–ï¼‰</li></ul><p><img src="/2025/10/14/%E7%BB%84%E4%BB%B6/mq/mq/image-20251016155713539.png" alt="image-20251016155713539"></p>]]></content>
    
    
    <categories>
      
      <category>mq</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mq</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>openfeignåŸç†è§£æ</title>
    <link href="/2025/09/05/%E6%A1%86%E6%9E%B6/openfeign/openfeign%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/"/>
    <url>/2025/09/05/%E6%A1%86%E6%9E%B6/openfeign/openfeign%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="OpenFeignæºç è§£æ"><a href="#OpenFeignæºç è§£æ" class="headerlink" title="OpenFeignæºç è§£æ"></a>OpenFeignæºç è§£æ</h1><h2 id="å¦‚ä½•ä½¿ç”¨OpenFeign"><a href="#å¦‚ä½•ä½¿ç”¨OpenFeign" class="headerlink" title="å¦‚ä½•ä½¿ç”¨OpenFeign"></a>å¦‚ä½•ä½¿ç”¨OpenFeign</h2><p>1ã€å¼•å…¥ä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>2ã€åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ @EnableFeignClientsæ³¨è§£</p><p>3ã€ç¼–å†™Feignæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;xxx&quot;, contextId = &quot;ProjectFeign&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProjectFeign</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>4ã€ä¾èµ–æ³¨å…¥ä½¿ç”¨</p><h2 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h2><h3 id="EnableFeignClientsæ³¨è§£"><a href="#EnableFeignClientsæ³¨è§£" class="headerlink" title="EnableFeignClientsæ³¨è§£"></a>EnableFeignClientsæ³¨è§£</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(FeignClientsRegistrar.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableFeignClients &#123;<br><br>String[] value() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>String[] basePackages() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>Class&lt;?&gt;[] basePackageClasses() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>Class&lt;?&gt;[] defaultConfiguration() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>Class&lt;?&gt;[] clients() <span class="hljs-keyword">default</span> &#123;&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæ‰«æ@EnableFeignClientsæ³¨è§£ï¼ŒåŠ è½½FeignClientsRegistrarç±»ï¼ŒFeignClientsRegistrarç±»å®ç°äº†BeanDefinitionRegistraræ¥å£ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒregisterBeanDefinitionsæ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;<br>registerDefaultConfiguration(metadata, registry);<br>    <span class="hljs-comment">// ğŸŒˆæ³¨å†Œfeignclient</span><br>registerFeignClients(metadata, registry);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="FeignClientsRegistrar-registerFeignClients"><a href="#FeignClientsRegistrar-registerFeignClients" class="headerlink" title="FeignClientsRegistrar.registerFeignClients"></a>FeignClientsRegistrar.registerFeignClients</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFeignClients</span><span class="hljs-params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;<br>LinkedHashSet&lt;BeanDefinition&gt; candidateComponents = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br><span class="hljs-comment">// è·å–@EnableFeignClientsæ³¨è§£çš„å…ƒæ•°æ®</span><br>   Map&lt;String, Object&gt; attrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName());<br><span class="hljs-keyword">final</span> Class&lt;?&gt;[] clients = attrs == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : (Class&lt;?&gt;[]) attrs.get(<span class="hljs-string">&quot;clients&quot;</span>);<br><span class="hljs-keyword">if</span> (clients == <span class="hljs-literal">null</span> || clients.length == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-type">ClassPathScanningCandidateComponentProvider</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> getScanner();<br>scanner.setResourceLoader(<span class="hljs-built_in">this</span>.resourceLoader);<br>scanner.addIncludeFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeFilter</span>(FeignClient.class));<br>Set&lt;String&gt; basePackages = getBasePackages(metadata);<br><span class="hljs-keyword">for</span> (String basePackage : basePackages) &#123;<br>candidateComponents.addAll(scanner.findCandidateComponents(basePackage));<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz : clients) &#123;<br>candidateComponents.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedGenericBeanDefinition</span>(clazz));<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">for</span> (BeanDefinition candidateComponent : candidateComponents) &#123;<br><span class="hljs-keyword">if</span> (candidateComponent <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition beanDefinition) &#123;<br><span class="hljs-comment">// verify annotated class is an interface</span><br><span class="hljs-type">AnnotationMetadata</span> <span class="hljs-variable">annotationMetadata</span> <span class="hljs-operator">=</span> beanDefinition.getMetadata();<br>Assert.isTrue(annotationMetadata.isInterface(), <span class="hljs-string">&quot;@FeignClient can only be specified on an interface&quot;</span>);<br><br>Map&lt;String, Object&gt; attributes = annotationMetadata<br>.getAnnotationAttributes(FeignClient.class.getCanonicalName());<br><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> getClientName(attributes);<br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> annotationMetadata.getClassName();<br>registerClientConfiguration(registry, name, className, attributes.get(<span class="hljs-string">&quot;configuration&quot;</span>));<br><br>registerFeignClient(registry, annotationMetadata, attributes);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="FeignClient-Beançš„æ³¨å†Œ"><a href="#FeignClient-Beançš„æ³¨å†Œ" class="headerlink" title="FeignClient Beançš„æ³¨å†Œ"></a>FeignClient Beançš„æ³¨å†Œ</h4><p>è¿™ä¸ªæ–¹æ³•æ˜¯å°†FeignClientæ¥å£æ³¨å†Œåˆ°å®¹å™¨ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">eagerlyRegisterFeignClientBeanDefinition</span><span class="hljs-params">(String className, Map&lt;String, Object&gt; attributes,</span><br><span class="hljs-params">BeanDefinitionRegistry registry)</span> &#123;<br>validate(attributes);<br>   <span class="hljs-comment">// å®šä¹‰äº†BeanDefinitionçš„Classç±»å‹æ˜¯FeignCLientFactoryBeanå·¥å‚å¯¹è±¡</span><br><span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">definition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(FeignClientFactoryBean.class);<br>definition.addPropertyValue(<span class="hljs-string">&quot;url&quot;</span>, getUrl(<span class="hljs-literal">null</span>, attributes));<br>definition.addPropertyValue(<span class="hljs-string">&quot;path&quot;</span>, getPath(<span class="hljs-literal">null</span>, attributes));<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> getName(attributes);<br>definition.addPropertyValue(<span class="hljs-string">&quot;name&quot;</span>, name);<br><span class="hljs-type">String</span> <span class="hljs-variable">contextId</span> <span class="hljs-operator">=</span> getContextId(<span class="hljs-literal">null</span>, attributes);<br>definition.addPropertyValue(<span class="hljs-string">&quot;contextId&quot;</span>, contextId);<br>definition.addPropertyValue(<span class="hljs-string">&quot;type&quot;</span>, className);<br>definition.addPropertyValue(<span class="hljs-string">&quot;dismiss404&quot;</span>, Boolean.parseBoolean(String.valueOf(attributes.get(<span class="hljs-string">&quot;dismiss404&quot;</span>))));<br><span class="hljs-type">Object</span> <span class="hljs-variable">fallback</span> <span class="hljs-operator">=</span> attributes.get(<span class="hljs-string">&quot;fallback&quot;</span>);<br><span class="hljs-keyword">if</span> (fallback != <span class="hljs-literal">null</span>) &#123;<br>definition.addPropertyValue(<span class="hljs-string">&quot;fallback&quot;</span>,<br>(fallback <span class="hljs-keyword">instanceof</span> Class ? fallback : ClassUtils.resolveClassName(fallback.toString(), <span class="hljs-literal">null</span>)));<br>&#125;<br><span class="hljs-type">Object</span> <span class="hljs-variable">fallbackFactory</span> <span class="hljs-operator">=</span> attributes.get(<span class="hljs-string">&quot;fallbackFactory&quot;</span>);<br><span class="hljs-keyword">if</span> (fallbackFactory != <span class="hljs-literal">null</span>) &#123;<br>definition.addPropertyValue(<span class="hljs-string">&quot;fallbackFactory&quot;</span>, fallbackFactory <span class="hljs-keyword">instanceof</span> Class ? fallbackFactory<br>: ClassUtils.resolveClassName(fallbackFactory.toString(), <span class="hljs-literal">null</span>));<br>&#125;<br>definition.addPropertyValue(<span class="hljs-string">&quot;fallbackFactory&quot;</span>, attributes.get(<span class="hljs-string">&quot;fallbackFactory&quot;</span>));<br>definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);<br>definition.addPropertyValue(<span class="hljs-string">&quot;refreshableClient&quot;</span>, isClientRefreshEnabled());<br>String[] qualifiers = getQualifiers(attributes);<br><span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(qualifiers)) &#123;<br>qualifiers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; contextId + <span class="hljs-string">&quot;FeignClient&quot;</span> &#125;;<br>&#125;<br><span class="hljs-comment">// This is done so that there&#x27;s a way to retrieve qualifiers while generating AOT</span><br><span class="hljs-comment">// code</span><br>definition.addPropertyValue(<span class="hljs-string">&quot;qualifiers&quot;</span>, qualifiers);<br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> definition.getBeanDefinition();<br>beanDefinition.setAttribute(FactoryBean.OBJECT_TYPE_ATTRIBUTE, className);<br><span class="hljs-comment">// has a default, won&#x27;t be null</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">primary</span> <span class="hljs-operator">=</span> (Boolean) attributes.get(<span class="hljs-string">&quot;primary&quot;</span>);<br>beanDefinition.setPrimary(primary);<br><span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(beanDefinition, className, qualifiers);<br>BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);<br>registerRefreshableBeanDefinition(registry, contextId, Request.Options.class, OptionsFactoryBean.class);<br>registerRefreshableBeanDefinition(registry, contextId, RefreshableUrl.class, RefreshableUrlFactoryBean.class);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="AbstractBeanFactory-doGetBean"><a href="#AbstractBeanFactory-doGetBean" class="headerlink" title="AbstractBeanFactory#doGetBean"></a>AbstractBeanFactory#doGetBean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br>beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œç”Ÿæˆçš„æ˜¯FeignClientFactoryBeanå·¥å‚å¯¹è±¡ï¼Œ</p>]]></content>
    
    
    <categories>
      
      <category>springboot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>openfeign</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s</title>
    <link href="/2025/08/18/%E8%BF%90%E7%BB%B4/k8s/"/>
    <url>/2025/08/18/%E8%BF%90%E7%BB%B4/k8s/</url>
    
    <content type="html"><![CDATA[<h1 id="k8så­¦ä¹ "><a href="#k8så­¦ä¹ " class="headerlink" title="k8så­¦ä¹ "></a>k8så­¦ä¹ </h1><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id="åŸºç¡€å‘½ä»¤"><a href="#åŸºç¡€å‘½ä»¤" class="headerlink" title="åŸºç¡€å‘½ä»¤"></a>åŸºç¡€å‘½ä»¤</h3><ul><li>docker pull æ‹‰å–é•œåƒ</li><li>docker search æœç´¢é•œåƒ</li><li>docker save -o  xxx.tar.gz  xxx æ ¹æ®xxxé•œåƒæ‰“åŒ…æˆxxx.tar.gzé•œåƒå‹ç¼©æ–‡ä»¶</li><li>docker load -i xxx.tar.gz  åŠ è½½xxx.tar.gzé•œåƒå‹ç¼©æ–‡ä»¶</li><li>docker rmi åˆ é™¤é•œåƒ</li></ul><h3 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h3><p>1ã€é…ç½®é™æ€ip</p><p>2ã€å…³é—­é˜²ç«å¢™&#x2F;iptables</p><p>systemctl stop firewalld &amp;&amp; systemctl disabled firewalld</p><p>å…³é—­iptables&#x2F;ç¦ç”¨iptablesï¼š</p><p>systemctl stop iptables &amp;&amp; systemctl disabled iptables</p><p>æ¸…ç©ºiptablesè§„åˆ™ï¼š</p><p>iptables  -F </p><p>è®¾ç½®ä¸»æœºåï¼š</p><p>hostnamectl set-hostname  lixd &amp;&amp; bash</p><p>å…³é—­selinux</p><p>setenforce 0</p><p>æ°¸ä¹…å…³é—­ï¼š</p><p>vim &#x2F;etc&#x2F;selinux&#x2F;config</p><p>è®¾ç½®SELINUX&#x3D;diabledé…ç½®ï¼Œè®¾ç½®åï¼Œé‡å¯æœåŠ¡å™¨ï¼ˆrebootï¼‰</p><p>è¾“å…¥getenforceå‘½ä»¤åï¼Œæ˜¾ç¤ºDisabledæ­£å¸¸</p><p>æ—¶é—´åŒæ­¥ï¼šntpdate</p><h3 id="Containerdå’ŒDocker"><a href="#Containerdå’ŒDocker" class="headerlink" title="Containerdå’ŒDocker"></a>Containerdå’ŒDocker</h3><p>DockeråŒ…å«Containerdï¼Œcontainerdä¸“æ³¨è¿è¡Œæ—¶çš„å®¹å™¨ç®¡ç†ï¼Œè€ŒDockerå‡ºæ¥ç®¡ç†å®¹å™¨å¤–ï¼Œè¿˜å¯ä»¥<strong>æ„å»ºå®¹å™¨ã€‚</strong></p><p>k8såœ¨1.24ç‰ˆæœ¬ä¹‹åï¼Œå¼ƒç”¨dockerã€‚</p><p>è°ƒç”¨é“¾ï¼š</p><p>Dockerä½œä¸ºk8så®¹å™¨è¿è¡Œï¼š</p><p>Kubelet â€“&gt; docker shimâ€“&gt; dockerâ€“&gt; containerd</p><p>Containerdä½œä¸ºk8så®¹å™¨è¿è¡Œï¼š</p><p>kubelet -&gt; CRI -&gt; containerd</p><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>1ã€CMD</p><p>ç±»ä¼¼RUNæŒ‡ä»¤ï¼Œä¸åŒçš„æ˜¯ï¼ŒCMDæ˜¯åœ¨docker run æ—¶è¿è¡Œï¼Œè€ŒRUNæ˜¯åœ¨docker buildæ„å»ºé•œåƒæ—¶æ‰§è¡Œ</p><p><strong>CMD[â€œexecutableâ€ï¼Œâ€œparam1â€ï¼Œâ€œparam2â€]ï¼ˆexec æ¨¡å¼ï¼‰</strong> </p><p><strong>CMD command ï¼ˆshell æ¨¡å¼ï¼‰</strong> </p><p><strong>CMD [â€œparam1â€,â€param2â€](ä½œä¸º ENTRYPOINT æŒ‡ä»¤çš„é»˜è®¤å‚æ•°)</strong></p><p>2ã€EXPOSE</p><p>æš´éœ²ç«¯å£ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ª</p><p><strong>EXPOSE &lt;ç«¯å£ 1&gt; [&lt;ç«¯å£ 2&gt;â€¦]</strong></p><p>3ã€FROM</p><p>åŸºç¡€é•œåƒï¼Œå¿…é¡»æ˜¯å¯ä»¥ä¸‹è½½ä¸‹æ¥çš„ï¼Œå®šåˆ¶çš„é•œåƒéƒ½æ˜¯åŸºäºFROMé•œåƒçš„</p><p>4ã€MAINTAINER</p><p>ä½œè€…ä¿¡æ¯</p><p>5ã€RUN</p><p>é•œåƒåœ¨æ„å»ºè¿‡ç¨‹ä¸­è¦è¿è¡Œçš„å‘½ä»¤</p><p><strong>RUN <command> (shell æ¨¡å¼ï¼Œè¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ï¼Œéœ€è¦è®°ä½)</strong></p><p><strong>RUN [â€œexecutableâ€ï¼Œâ€œparam1â€ï¼Œâ€œparam2â€](exec æ¨¡å¼)</strong></p><h2 id="ğŸŒˆK8S"><a href="#ğŸŒˆK8S" class="headerlink" title="ğŸŒˆK8S"></a>ğŸŒˆK8S</h2><p>ç»„ä»¶ï¼š</p><p>kubectlï¼šå‘½ä»¤è¡Œç®¡ç†å·¥å…·ï¼Œå¯ä»¥å¯¹èµ„æºå¢åˆ æ”¹æŸ¥ï¼Œæ“ä½œpod</p><p>masterï¼š</p><ul><li>api serverï¼š  è®¤è¯æˆæƒç­–ç•¥ï¼Œç»Ÿä¸€å…¥å£ï¼Œ</li><li>controller managerï¼šæ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œendpointç«¯ç‚¹ï¼Œç®¡ç†podå‰¯æœ¬ï¼Œä½¿èµ„æºè¾¾åˆ°è‡ªå·±é¢„æœŸçš„æœŸæœ›å€¼è¿è¡Œ</li><li>scheduleï¼šè°ƒåº¦å™¨</li><li>etcdï¼škvæ•°æ®åº“ï¼Œå­˜å‚¨k8sé›†ç¾¤çŠ¶æ€ä¿¡æ¯ï¼Œè¿˜æœ‰ç½‘ç»œä¿¡æ¯</li></ul><p>workï¼š</p><ul><li>kubelet</li><li>kube-proxyï¼šserviceè´Ÿè½½å‡è¡¡ä»£ç†ï¼Œç”Ÿæˆiptablesè§„åˆ™ï¼Œipvs</li><li>coredns</li><li>calicoï¼šç½‘ç»œæ’ä»¶ï¼Œè·¨èŠ‚ç‚¹è®¿é—®ï¼Œç½‘ç»œç­–ç•¥</li></ul><p>kubelet</p><p>podï¼šæœ€å°å•å…ƒ</p><h3 id="å­˜å‚¨"><a href="#å­˜å‚¨" class="headerlink" title="å­˜å‚¨"></a>å­˜å‚¨</h3><ul><li>empty dir</li><li>hostPath</li><li>NFSï¼šå•èŠ‚ç‚¹æ•…éšœé—®é¢˜ï¼Œä¸æ˜¯åˆ†å¸ƒå¼å­˜å‚¨çš„</li><li>PV&#x2F;PVC<ul><li>PVæ˜¯ä¸€ä¸ªå­˜å‚¨å—</li><li>PVCæ˜¯å­˜å‚¨è¯·æ±‚ï¼Œä¸PVç»‘å®š</li><li>å›æ”¶ç­–ç•¥ï¼šRetainã€Recycleï¼ˆä¸æ¨èï¼‰ã€Delete</li></ul></li></ul><h3 id="Pods"><a href="#Pods" class="headerlink" title="Pods"></a>Pods</h3><h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl get namespace<br>kubectl get ns<br><br>kubectl descripte ns å‘½åç©ºé—´åç§°<br><br>kubectl create ns å‘½åç©ºé—´åç§°<br>kubectl delete ns å‘½åç©ºé—´åç§°<br></code></pre></td></tr></table></figure><p>å¥åº·æ¢æµ‹ï¼š</p><ul><li>å­˜æ´»æ¢æµ‹ï¼šç›‘æµ‹podæ˜¯å¦å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ¢æµ‹å¤±è´¥ï¼Œé‡å¯å®¹å™¨</li><li>å°±ç»ªæ¢æµ‹ï¼šç›‘æµ‹podæ˜¯å¦å·²ç»å‡†å¤‡å¥½æ¥å—æµé‡ï¼Œæ¢æµ‹å¤±è´¥ï¼Œä¸å°†æµé‡è½¬å‘åˆ°è¯¥å®¹å™¨</li><li>å¯åŠ¨æ¢æµ‹ï¼šç›‘æµ‹podæ˜¯å¦å¯åŠ¨æˆåŠŸï¼Œä¸å­˜æ´»æ¢æµ‹ä¸åŒçš„æ˜¯ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚å½“æ¢æµ‹å¤±è´¥ï¼Œå°†è‡ªåŠ¨é‡å¯å®¹å™¨</li></ul><h3 id="ä¸ºä»€ä¹ˆè¦æœ‰å››å±‚ä»£ç†ï¼Ÿï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰å››å±‚ä»£ç†ï¼Ÿï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰å››å±‚ä»£ç†ï¼Ÿï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦æœ‰å››å±‚ä»£ç†ï¼Ÿï¼Ÿ</h3><p>1ã€Podæ¯æ¬¡åˆ é™¤æ–°å¢åï¼Œipæ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œä½¿ç”¨serviceå››å±‚ä»£ç†ï¼Œè¿™æ ·ï¼Œipä¸ç®¡æ€ä¹ˆå˜åŒ–ï¼Œéƒ½ä¸ä¼šå½±å“æœåŠ¡è®¿é—®ã€‚</p><p>2ã€Podçš„ipåœ¨k8sé›†ç¾¤ä¹‹å¤–ï¼Œæ˜¯æ— æ³•è®¿é—®çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨serviceä»£ç†ï¼Œæ‰å¯ä»¥åœ¨k8sé›†ç¾¤ä¹‹å¤–æ‰èƒ½è®¿é—®ã€‚</p><p><strong>Kube-proxyï¼šåœ¨åˆ›å»ºserviceçš„æ—¶å€™ï¼Œä¼šæŠŠå¯¹åº”çš„servcieå’Œå¯¹åº”çš„Podçš„ipä¿å­˜åˆ°iptablesæˆ–è€…ipvsè§„åˆ™é‡Œã€‚</strong></p><p>Corednsï¼šå°†åŸŸåè§£ææˆip</p><p>ServiceåŸç†ï¼š</p><p>k8såˆ›å»ºserviceçš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šåˆ›å»ºä¸serviceåŒåçš„entpointå¯¹è±¡ï¼Œå½“podåœ°å€å‘ç”Ÿå˜åŒ–ï¼Œentpointä¹Ÿä¼šéšä¹‹å˜åŒ–ï¼Œserviceæ¥æ”¶è¯·æ±‚åï¼Œå°±ä¼šé€šè¿‡entpointï¼Œè½¬å‘åˆ°å¯¹åº”çš„podå®¹å™¨ï¼Œ</p><p>è‡³äºè½¬å‘åˆ°å…·ä½“å“ªä¸ªpodå®¹å™¨ï¼Œç”±è´Ÿè½½å‡è¡¡kube-proxyå†³å®šã€‚</p><p>serviceçš„åç§°ï¼š<strong>&lt;service.name&gt;.<namespace>.svc.cluster.local</namespace></strong></p><p>k8sä¸­æœ‰ä¸‰ä¸ªç½‘ç»œï¼š</p><ul><li>ç‰©ç†æœºip</li><li>podçš„ip</li><li>serviceçš„ip</li></ul><p><strong>NodePortã€ClusterPortå’ŒExternalNameçš„serviceçš„åŒºåˆ«ï¼Ÿ</strong></p><p>NodePortç±»å‹çš„serviceï¼Œæ˜ å°„çš„ç«¯å£åï¼Œå¯ä»¥åœ¨é›†ç¾¤å¤–è®¿é—®</p><p>ClusterPortç±»å‹çš„serviceï¼Œæ˜ å°„çš„ç«¯å£åï¼Œåªèƒ½åœ¨é›†ç¾¤å†…è®¿é—®</p><p>ExternalNameç±»å‹çš„serviceï¼Œå¯ä»¥è·¨å‘½ä»¤ç©ºé—´è®¿é—®ï¼Œç›¸å½“äºåšè½¯é“¾</p><h3 id="Istioæµé‡æ²»ç†"><a href="#Istioæµé‡æ²»ç†" class="headerlink" title="Istioæµé‡æ²»ç†"></a>Istioæµé‡æ²»ç†</h3><p>Istioæ˜¯ä»€ä¹ˆï¼Ÿ</p><p><strong>è¿æ¥ã€å®‰å…¨åŠ å›ºã€æ§åˆ¶å’Œè§‚å¯ŸæœåŠ¡çš„å¼€æ”¾å¹³å°ã€‚</strong></p><p> ğŸŒˆIstioçš„å››ä¸ªç‰¹æ€§ï¼š</p><p>1ã€è¿æ¥ï¼šæ™ºèƒ½æ§åˆ¶æœåŠ¡ä¹‹é—´çš„è°ƒç”¨æµé‡ï¼Œèƒ½å¤Ÿå®ç°ç°åº¦å‘å¸ƒï¼ŒA&#x2F;Bæµ‹è¯•å’Œè“ç»¿éƒ¨ç½²ç­‰åŠŸèƒ½</p><p>2ã€å®‰å…¨åŠ å›ºï¼šè‡ªåŠ¨ä¸ºæœåŠ¡é—´è°ƒç”¨æä¾›è®¤è¯ã€æˆæƒå’ŒåŠ å¯†</p><p>3ã€æ§åˆ¶ï¼šä¿è¯èµ„æºåœ¨æ¶ˆè´¹è€…ä¹‹é—´å…¬å¹³åˆ†é…</p><p>3ã€è§‚å¯Ÿï¼šæŸ¥çœ‹æœåŠ¡è¿è¡ŒæœŸé—´çš„å„ä¸ªå‚æ•°ï¼Œæ¯”å¦‚æ—¥å¿—ã€ç›‘æ§å’Œé“¾è·¯è°ƒç”¨ç­‰</p><p>4ã€å¸®åŠ©å¾®æœåŠ¡åˆ†å±‚è§£è€¦ï¼Œè§£è€¦åçš„proxyå±‚å¯ä»¥æ›´åŠ ä¸“æ³¨æä¾›åŸºç¡€æ¶æ„èƒ½åŠ›ï¼š</p><p>ï¼ˆ1ï¼‰æœåŠ¡å‘ç°</p><p>ï¼ˆ2ï¼‰è´Ÿè½½å‡è¡¡</p><p>ï¼ˆ3ï¼‰æ•…éšœæ¢å¤</p><p>ï¼ˆ4ï¼‰æœåŠ¡ç›‘æ§</p><p>ï¼ˆ5ï¼‰A&#x2F;Bæµ‹è¯•</p><p>ï¼ˆ6ï¼‰ç°åº¦å‘å¸ƒ</p><p>ï¼ˆ7ï¼‰é™æµé™é€Ÿ</p><p>ï¼ˆ8ï¼‰è®¿é—®æ§åˆ¶</p><p>ç°åº¦å‘å¸ƒ-é‡‘ä¸é›€å‘å¸ƒæµç¨‹å›¾ï¼š</p><p><img src="/2025/08/18/%E8%BF%90%E7%BB%B4/k8s/image-20250917224424999.png" alt="image-ç°åº¦å‘å¸ƒ"></p><h4 id="Istioæ ¸å¿ƒç‰¹æ€§"><a href="#Istioæ ¸å¿ƒç‰¹æ€§" class="headerlink" title="Istioæ ¸å¿ƒç‰¹æ€§"></a>Istioæ ¸å¿ƒç‰¹æ€§</h4><p>1ã€æµæ§ï¼šè¶…æ—¶é‡è¯•ã€A&#x2F;Bæµ‹è¯•ã€ç°åº¦å‘å¸ƒç­‰</p><p>2ã€å®‰å…¨ï¼šæƒé™æ§åˆ¶</p><p>3ã€å¯è§‚å¯Ÿï¼šç›‘æ§ã€æ•°æ®æ”¶é›†</p><h5 id="æ–­è·¯å™¨"><a href="#æ–­è·¯å™¨" class="headerlink" title="æ–­è·¯å™¨"></a>æ–­è·¯å™¨</h5><p>æœåŠ¡ç†”æ–­ï¼šè¾¾åˆ°ä¸€å®šæµé‡ä¹‹åï¼ŒæœåŠ¡ç›´æ¥ç†”æ–­ï¼Œä¸å†æä¾›æœåŠ¡</p><p>æœåŠ¡é™çº§ï¼šæé«˜ç”¨æˆ·ä½“éªŒï¼Œå½“æœ‰å¤§é‡æµé‡è¿‡æ¥çš„æ—¶å€™ï¼Œè¿”å›å‹å¥½é¡µé¢æˆ–è€…æç¤º</p><h5 id="Envoy"><a href="#Envoy" class="headerlink" title="Envoy"></a>Envoy</h5><p>C++å¼€å‘çš„ä»£ç†ï¼Œåè°ƒæœåŠ¡çš„å…¥ç«™å’Œå‡ºç«™æµé‡</p><p>Envoyå…·æœ‰çš„åŠŸèƒ½ï¼š</p><ul><li>æœåŠ¡å‘ç°</li><li>è´Ÿè½½å‡è¡¡</li><li>æ–­è·¯å™¨</li><li>ç°åº¦å‘å¸ƒ</li></ul><p><strong>Istioä¸Envoyçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿ</strong></p><p><img src="/2025/08/18/%E8%BF%90%E7%BB%B4/k8s/image-20250919234521060.png" alt="image-20250919234521060"></p><h5 id="Citadel"><a href="#Citadel" class="headerlink" title="Citadel"></a>Citadel</h5><p>è´Ÿè´£æœåŠ¡é—´å®‰å…¨é€šä¿¡ï¼ˆTLSï¼‰ï¼Œå……å½“CAæœºæ„çš„ä½œç”¨ï¼Œç”Ÿæˆè¯ä¹¦ä»¥å…è®¸æœåŠ¡é—´å®‰å…¨é€šä¿¡ã€‚</p><p><img src="/2025/08/18/%E8%BF%90%E7%BB%B4/k8s/image-20250919234706354.png" alt="image-20250919234706354"></p><h5 id="Galley"><a href="#Galley" class="headerlink" title="Galley"></a>Galley</h5><p>Galleyæä¾›é…ç½®ç®¡ç†çš„æœåŠ¡ã€‚å®ç°åŸç†æ˜¯é€šè¿‡K8Sæä¾›çš„ValidatingWebhookå¯¹é…ç½®è¿›è¡ŒéªŒè¯ã€‚</p><h5 id="Ingressgateway"><a href="#Ingressgateway" class="headerlink" title="Ingressgateway"></a>Ingressgateway</h5><p><img src="/2025/08/18/%E8%BF%90%E7%BB%B4/k8s/image-20250919235106942.png" alt="image-20250919235106942"></p>]]></content>
    
    
    <categories>
      
      <category>k8s</category>
      
    </categories>
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Reactorå’ŒProactor</title>
    <link href="/2025/08/15/%E6%A1%86%E6%9E%B6/netty/Reactor%E5%92%8CProactor/"/>
    <url>/2025/08/15/%E6%A1%86%E6%9E%B6/netty/Reactor%E5%92%8CProactor/</url>
    
    <content type="html"><![CDATA[<h1 id="Reactorå’ŒProactorç½‘ç»œæ¨¡å‹"><a href="#Reactorå’ŒProactorç½‘ç»œæ¨¡å‹" class="headerlink" title="Reactorå’ŒProactorç½‘ç»œæ¨¡å‹"></a>Reactorå’ŒProactorç½‘ç»œæ¨¡å‹</h1><h2 id="Reactor-åŒæ­¥éé˜»å¡æ¨¡å‹"><a href="#Reactor-åŒæ­¥éé˜»å¡æ¨¡å‹" class="headerlink" title="Reactor åŒæ­¥éé˜»å¡æ¨¡å‹"></a>Reactor åŒæ­¥éé˜»å¡æ¨¡å‹</h2><h3 id="å•Reactor-å•è¿›ç¨‹-å•çº¿ç¨‹"><a href="#å•Reactor-å•è¿›ç¨‹-å•çº¿ç¨‹" class="headerlink" title="å•Reactor å•è¿›ç¨‹&#x2F;å•çº¿ç¨‹"></a>å•Reactor å•è¿›ç¨‹&#x2F;å•çº¿ç¨‹</h3><p><img src="/2025/08/15/%E6%A1%86%E6%9E%B6/netty/Reactor%E5%92%8CProactor/1.png" alt="å•Reactorå•è¿›ç¨‹&#x2F;å•çº¿ç¨‹å›¾"></p><p>æœ‰3ä¸ªå¯¹è±¡ï¼š</p><ul><li>Reactorï¼šç›‘å¬è¿æ¥è¯·æ±‚å’Œåˆ†å‘äº‹ä»¶</li><li>Acceptorï¼šå»ºç«‹è¿æ¥</li><li>Handlerï¼šè¯»å†™æ“ä½œ</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•åˆ©ç”¨å¤šæ ¸CPUæ€§èƒ½</li><li>å½“Handlerå¤„ç†çš„æ—¶å€™ï¼Œæ•´ä¸ªè¿›ç¨‹æ˜¯æ²¡åŠæ³•å¤„ç†å…¶å®ƒè¯·æ±‚çš„ï¼Œä¼šé€ æˆå“åº”å»¶è¿Ÿ</li></ul><p>æ‰€ä»¥å•Reactor å•è¿›ç¨‹&#x2F;å•çº¿ç¨‹çš„æ–¹æ¡ˆåªé€‚åˆhandlerå¤„ç†ç‰¹å¿«çš„åº”ç”¨åœºæ™¯ã€‚</p><h3 id="å•Reactor-å¤šçº¿ç¨‹-å¤šè¿›ç¨‹"><a href="#å•Reactor-å¤šçº¿ç¨‹-å¤šè¿›ç¨‹" class="headerlink" title="å•Reactor å¤šçº¿ç¨‹&#x2F;å¤šè¿›ç¨‹"></a>å•Reactor å¤šçº¿ç¨‹&#x2F;å¤šè¿›ç¨‹</h3><p><img src="/2025/08/15/%E6%A1%86%E6%9E%B6/netty/Reactor%E5%92%8CProactor/3.png" alt="å•Reactor å¤šçº¿ç¨‹&#x2F;å¤šè¿›ç¨‹å›¾"></p><p>å¼•å…¥æ¥å¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸CPUï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰çº¿ç¨‹ç«äº‰èµ„æºçš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å­çº¿ç¨‹å¤„ç†å®Œåç»“æœå‘é€ç»™Handlerçš„æ—¶å€™ï¼Œéœ€è¦åŠ é”ï¼Œå› ä¸ºæ¶‰åŠå…±äº«æ•°æ®çš„é—®é¢˜ã€‚</p><h3 id="å¤šReactor-å¤šè¿›ç¨‹-å¤šçº¿ç¨‹"><a href="#å¤šReactor-å¤šè¿›ç¨‹-å¤šçº¿ç¨‹" class="headerlink" title="å¤šReactor å¤šè¿›ç¨‹&#x2F;å¤šçº¿ç¨‹"></a>å¤šReactor å¤šè¿›ç¨‹&#x2F;å¤šçº¿ç¨‹</h3><p><img src="/2025/08/15/%E6%A1%86%E6%9E%B6/netty/Reactor%E5%92%8CProactor/4.png" alt="å¤šReactor å¤šè¿›ç¨‹&#x2F;å¤šçº¿ç¨‹å›¾"></p><p>ä¼˜åŠ¿ï¼š</p><ul><li>ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹åˆ†å·¥æ˜ç¡®ï¼Œä¸»çº¿ç¨‹è´Ÿè´£æ–°è¿æ¥ï¼Œå­çº¿ç¨‹è´Ÿè´£åç»­çš„å¤„ç†</li><li>ä¸»çº¿ç¨‹åªéœ€è¦å°†æ–°è¿æ¥åˆ†å‘ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— é¡»è¿”å›æ•°æ®ï¼Œç›´æ¥å°±å¯ä»¥å°†å­çº¿ç¨‹çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</li></ul><p>å¤§åé¼é¼çš„Nettyå’ŒMemcacheéƒ½æ˜¯ä½¿ç”¨æ¥å¤šRector å¤šçº¿ç¨‹çš„æ–¹å¼æ¥å®ç°çš„ï¼ŒNginxä½¿ç”¨çš„æ˜¯å¤šRector å¤šè¿›ç¨‹çš„æ–¹å¼ã€‚</p><h2 id="Proactor-å¼‚æ­¥éé˜»å¡æ¨¡å‹"><a href="#Proactor-å¼‚æ­¥éé˜»å¡æ¨¡å‹" class="headerlink" title="Proactor å¼‚æ­¥éé˜»å¡æ¨¡å‹"></a>Proactor å¼‚æ­¥éé˜»å¡æ¨¡å‹</h2><p>Proactoré‡‡ç”¨çš„æ˜¯å¼‚æ­¥I&#x2F;Oæ¨¡å¼ï¼Œæ‰€ä»¥å«å¼‚æ­¥éé˜»å¡æ¨¡å‹</p><p>Proactorå’ŒReactorçš„åŒºåˆ«ï¼š</p><ul><li>ReactoråŒæ­¥éé˜»å¡ï¼Œæ„ŸçŸ¥çš„æ˜¯<strong>å°±ç»ªå¯è¯»å†™äº‹ä»¶</strong>ï¼Œæ¯æ¬¡æ„ŸçŸ¥åˆ°æœ‰äº‹ä»¶çš„æ—¶å€™ï¼Œéœ€è¦åº”ç”¨ç¨‹åºä¸»åŠ¨çš„è°ƒç”¨readå‡½æ•°æ¥è¯»å–ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨ç¨‹åºä¸»åŠ¨å°†socketç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºç¼“å­˜ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œè¯»å®Œä¹‹åæ‰èƒ½å¤„ç†æ•°æ®ã€‚</li><li>Proactorå¼‚æ­¥éé˜»å¡ï¼Œæ„ŸçŸ¥çš„æ˜¯<strong>å·²å®Œæˆäº‹ä»¶</strong>ï¼Œåœ¨å‘èµ·å¼‚æ­¥è¯»å†™è¯·æ±‚çš„æ—¶å€™ï¼Œç³»ç»Ÿå†…æ ¸ä¼šè‡ªåŠ¨çš„å¤„ç†å¥½æ•°æ®ï¼Œè¿™é‡Œçš„è¯»å†™å·¥ä½œå…¨éƒ¨ç”±ç³»ç»Ÿå†…æ ¸æ¥å®Œæˆï¼Œå¹¶ä¸éœ€è¦åƒReactorä¸€æ ·ï¼Œåº”ç”¨ç¨‹åºä¸»åŠ¨è°ƒç”¨read&#x2F;writeæ¥è¯»å†™æ•°æ®ï¼Œç³»ç»Ÿå†…æ ¸å¤„ç†å¥½æ•°æ®åï¼Œä¼šä¸»åŠ¨é€šçŸ¥åº”ç”¨æ¥ç›´æ¥å¤„ç†æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å°†socketç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°åº”ç”¨ç¨‹åºç¼“å­˜ä¸­æ˜¯ç³»ç»Ÿå†…æ ¸è‡ªåŠ¨å®Œæˆçš„ã€‚</li></ul><p>æ³¨æ„ï¼š</p><p>å¯æƒœçš„æ˜¯ï¼Œåœ¨Linuxä¸­çš„å¼‚æ­¥I&#x2F;Oæ˜¯ä¸å®Œå–„çš„ï¼Œaioä¸æ˜¯çœŸæ­£çš„ç³»ç»Ÿå†…æ ¸çº§åˆ«æ”¯æŒçš„ï¼Œæ˜¯åœ¨ç”¨æˆ·ç©ºè§æ¨¡æ‹Ÿå‡ºæ¥çš„ã€‚å¹¶ä¸”åªæ”¯æŒæœ¬åœ°æ–‡ä»¶çš„aioå¼‚æ­¥æ“ä½œï¼Œä¸æ”¯æŒç½‘ç»œsocketï¼Œæ‰€ä»¥linuxçš„é«˜æ€§èƒ½ç½‘ç»œæ¨¡å¼éƒ½æ˜¯ä½¿ç”¨çš„Reactoræ¨¡å¼ã€‚</p><p>è€Œwindowsæœ‰ä¸€æ•´å¥—aioçš„socketå¼‚æ­¥ç¼–ç¨‹æ¥å£ï¼ˆ<strong>IOCP</strong>ï¼‰ï¼Œæ˜¯ç³»ç»Ÿå†…æ ¸çº§åˆ«å®ç°çš„å¼‚æ­¥IOï¼Œå› æ­¤åœ¨windowsä¸­å¯ä»¥ä½¿ç”¨Proactoræ¨¡å‹æ–¹æ¡ˆã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>I/Oå¤šè·¯å¤ç”¨</title>
    <link href="/2025/08/15/%E6%A1%86%E6%9E%B6/netty/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/"/>
    <url>/2025/08/15/%E6%A1%86%E6%9E%B6/netty/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="select-poll-epoll-å¤šè·¯å¤ç”¨"><a href="#select-poll-epoll-å¤šè·¯å¤ç”¨" class="headerlink" title="select&#x2F;poll&#x2F;epoll å¤šè·¯å¤ç”¨"></a>select&#x2F;poll&#x2F;epoll å¤šè·¯å¤ç”¨</h1><h2 id="select-poll"><a href="#select-poll" class="headerlink" title="select&#x2F;poll"></a>select&#x2F;poll</h2><h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><p>selectå®ç°å¤šè·¯å¤ç”¨çš„æ–¹å¼ï¼Œå°±æ˜¯å°†æ‰€æœ‰è¿æ¥çš„socketæ”¾å…¥åˆ°æ–‡ä»¶æè¿°ç¬¦é›†å’Œä¸­ï¼Œè°ƒç”¨selectå‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦é›†å’Œæ‹·è´åˆ°å†…æ ¸ä¸­ï¼Œé€šè¿‡éå†çš„æ–¹å¼æ¥åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚å½“æ£€æµ‹åˆ°æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šå°†socketæ ‡è®°æˆå¯è¯»æˆ–å¯å†™ï¼Œç„¶åå†å°†æ–‡ä»¶æè¿°ç¬¦é›†å’Œæ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œåœ¨ç”¨æˆ·æ€å†éå†æ¥åˆ¤æ–­å“ªäº›socketè¢«æ ‡è®°æˆå¯è¯»æˆ–å¯å†™ã€‚</p><p>è¿™ç§æ–¹å¼ä¼š<strong>2æ¬¡éå†æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ¬¡åœ¨å†…æ ¸æ€ï¼Œä¸€æ¬¡åœ¨ç”¨æˆ·æ€</strong>ã€‚</p><p><strong>selectä½¿ç”¨å›ºå®šé•¿åº¦çš„Bitsmapï¼Œè¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œæ‰€ä»¥<strong>ä¸ªæ•°æ˜¯æœ‰é™åˆ¶çš„</strong>ï¼Œåœ¨linuxä¸­ï¼Œé»˜è®¤é•¿åº¦æ˜¯1024.</p><h3 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h3><p>pollä¸å†ä½¿ç”¨Bitsmapæ¥è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ¨æ€æ•°ç»„ï¼Œé“¾è¡¨çš„æ–¹å¼æ¥ç»„ç»‡ï¼Œçªç ´çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°é™åˆ¶ï¼Œä½†æ˜¯è¿˜æ˜¯<strong>é™åˆ¶äºç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦çš„ã€‚</strong></p><p>æ‰€ä»¥ä¸ç®¡æ˜¯selectè¿˜æ˜¯pollï¼Œéƒ½æ˜¯é€šè¿‡2æ¬¡éå†æ¥åˆ¤æ–­çš„ï¼Œæ•ˆç‡éƒ½å¾ˆä½ã€‚</p><h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>epollåœ¨selectå’Œpollçš„åŸºç¡€ä¸Šï¼Œåšäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š</p><ul><li>epollåœ¨å†…æ ¸ä¸­ä½¿ç”¨æ¥<strong>çº¢é»‘æ ‘</strong>æ¥è·Ÿè¸ªæ‰€æœ‰å¾…æ£€æµ‹çš„æ–‡ä»¶æè¿°å­—ï¼ŒæŠŠéœ€è¦ç›‘æ§çš„socketåŠ å…¥åˆ°å†…æ ¸çš„çº¢é»‘æ ‘ä¸­ï¼Œæ‰€ä»¥select&#x2F;polléƒ½æ˜¯å°†å…¨éƒ¨çš„æ–‡ä»¶æè¿°ç¬¦éƒ½æ‹·è´åˆ°å†…æ ¸ä¸­ï¼Œè€Œepollåœ¨å†…æ ¸ä¸­ç»´æŠ¤æ¥çº¢é»‘æ ‘æ¥ä¿å­˜æ‰€æœ‰å¾…æ£€æµ‹çš„socketï¼Œæ‰€ä»¥åªéœ€è¦ä¼ å…¥ä¸€ä¸ªå¾…æ£€æµ‹çš„socketå°±å¯ä»¥ï¼Œå‡å°‘æ¥å†…æ ¸æ€å’Œç”¨æˆ·æ€ä¹‹é—´çš„æ•°æ®æ‹·è´ã€‚</li><li>epollä½¿ç”¨æ¥<strong>äº‹ä»¶é©±åŠ¨çš„æœºåˆ¶</strong>ï¼Œå†…æ ¸ä¸­ç»´æŠ¤æ¥ä¸€ä¸ª<strong>é“¾è¡¨æ¥è®°å½•å°±ç»ªäº‹ä»¶</strong>ï¼Œå½“æœ‰socketæœ‰äº‹ä»¶çš„æ—¶å€™ï¼Œå°±ä¼šåŠ å…¥åˆ°å°±ç»ªäº‹ä»¶é“¾è¡¨ä¸­ï¼Œå½“ç”¨æˆ·æ€è°ƒç”¨çš„æ—¶å€™ï¼Œåªä¼šè¿”å›å°±ç»ªäº‹ä»¶é“¾è¡¨ä¸­çš„æ•°æ®ï¼Œè€Œä¸æ˜¯è¿”å›æ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†å’Œ</li></ul>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é›¶æ‹·è´</title>
    <link href="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/"/>
    <url>/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/</url>
    
    <content type="html"><![CDATA[<h1 id="é›¶æ‹·è´"><a href="#é›¶æ‹·è´" class="headerlink" title="é›¶æ‹·è´"></a>é›¶æ‹·è´</h1><h2 id="DMAæ§åˆ¶å™¨"><a href="#DMAæ§åˆ¶å™¨" class="headerlink" title="DMAæ§åˆ¶å™¨"></a>DMAæ§åˆ¶å™¨</h2><p>DMAæ§åˆ¶å™¨çš„å‡ºç°å¯ä»¥è§£å†³åœ¨æ•°æ®è¿”å›ä¹‹å‰ï¼Œcpuä¸€ç›´å¤„äºç©ºç½®çŠ¶æ€ï¼Œéå¸¸æµªè´¹ç³»ç»Ÿèµ„æºã€‚</p><p>åœ¨æ²¡æœ‰DMAæ§åˆ¶å™¨ä¹‹å‰çš„æ—¶å€™ï¼Œ<strong>CPUéœ€è¦å…¨ç¨‹å‚ä¸æ‹·è´æ•°æ®çš„è¿‡ç¨‹ï¼Œè€Œä¸”CPUä¸èƒ½åšå…¶å®ƒçš„äº‹æƒ…</strong>ï¼ŒI&#x2F;Oçš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/1.png" alt="æ— DMAæ§åˆ¶å™¨å›¾å¼"></p><p>æœ‰DMAæ§åˆ¶å™¨ä¹‹åï¼Œ<strong>CPUä¸å†å‚ä¸ã€å°†æ•°æ®ä»ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºçš„è¿‡ç¨‹ï¼Œè¿™éƒ¨åˆ†çš„è¿‡ç¨‹éƒ½ç”±DMAæ§åˆ¶å™¨è´Ÿè´£ã€‘</strong>ï¼ŒI&#x2F;Oçš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/2.png" alt="æœ‰DMAæ§åˆ¶å™¨"></p><h2 id="ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“"><a href="#ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“" class="headerlink" title="ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“"></a>ä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“</h2><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/3.png" alt="ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“å›¾"></p><p><strong>ä¸€å…±å‘ç”Ÿäº†4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ4æ¬¡æ‹·è´</strong>ï¼Œæ— ç–‘ä¼šæµªè´¹CPUèµ„æºï¼Œé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>ä¼˜åŒ–æ–¹æ¡ˆï¼š<strong>å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ‹·è´æ¬¡æ•°</strong></p><h2 id="å¦‚ä½•å®ç°é›¶æ‹·è´"><a href="#å¦‚ä½•å®ç°é›¶æ‹·è´" class="headerlink" title="å¦‚ä½•å®ç°é›¶æ‹·è´"></a>å¦‚ä½•å®ç°é›¶æ‹·è´</h2><p>é›¶æ‹·è´æ–¹æ¡ˆæœ‰2ç§ï¼š</p><ul><li>mmap + write</li><li>sendfile</li></ul><h3 id="mmap-write"><a href="#mmap-write" class="headerlink" title="mmap + write"></a>mmap + write</h3><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/4.png" alt="mmap+writeå®ç°çš„é›¶æ‹·è´å›¾"></p><p>mmap+writeæ–¹æ¡ˆï¼Œ<strong>å‡å°‘äº†ä»å†…æ ¸æ€ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·æ€ç¼“å†²åŒºï¼Œç”¨æˆ·æ€ç¼“å†²åŒºæ‹·è´å†æ‹·è´åˆ°å†…æ ¸æ€ç¼“å†²åŒºçš„è¿‡ç¨‹ï¼Œç›´æ¥åœ¨å†…æ ¸æ€ä¸­æ‹·è´ï¼Œå‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œè¿˜æ˜¯4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ã€‚</p><h3 id="sendfileï¼ˆKafkaï¼‰"><a href="#sendfileï¼ˆKafkaï¼‰" class="headerlink" title="sendfileï¼ˆKafkaï¼‰"></a>sendfileï¼ˆKafkaï¼‰</h3><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/5.png" alt="sendfileé›¶æ‹·è´å›¾"></p><p>sendfileæ–¹æ¡ˆï¼Œ<strong>åªæœ‰2æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œ3æ¬¡æ‹·è´</strong>ï¼Œç›¸æ¯”mmap+writeæ–¹æ¡ˆï¼Œå°‘äº†2æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸éœ€è¦ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢äº†ã€‚</p><p>å¦‚æœç½‘å¡æ”¯æŒSG-DMAæŠ€æœ¯çš„è¯ï¼Œè¿˜èƒ½ç»§ç»­ä¼˜åŒ–ï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„é›¶æ‹·è´æ–¹æ¡ˆï¼š</p><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/6.png" alt="SG-DMAé›¶æ‹·è´å›¾"></p><p>ğŸŒˆ SG-DMAï¼ˆ<em>The Scatter-Gather Direct Memory Access</em>ï¼‰æ–¹æ¡ˆï¼Œåªæœ‰2æ¬¡ä¸Šçº¿æ–‡åˆ‡æ¢å’Œ2æ¬¡æ‹·è´ï¼Œå†…æ ¸æ€ç¼“å†²åŒºåªæ‹·è´æè¿°ç¬¦å’Œæ•°æ®é•¿åº¦ä¿¡æ¯åˆ°socketç¼“å†²åŒºä¸­ï¼ŒçœŸæ­£çš„æ•°æ®é€šè¿‡SG-DMAç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ä¸­ï¼Œå…¨ç¨‹æ²¡æœ‰CPUæ‹·è´è¿‡ç¨‹ï¼ŒCPUå…¨ç¨‹ä¸å‚ä¸ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯é€šè¿‡DMAæ§åˆ¶å™¨æ¥æ“ä½œçš„ã€‚</p><h2 id="å¤§æ–‡ä»¶å¦‚ä½•ä¼ è¾“"><a href="#å¤§æ–‡ä»¶å¦‚ä½•ä¼ è¾“" class="headerlink" title="å¤§æ–‡ä»¶å¦‚ä½•ä¼ è¾“"></a>å¤§æ–‡ä»¶å¦‚ä½•ä¼ è¾“</h2><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/1-5224127.png" alt="åŸå§‹æ‹·è´å›¾"></p><p><strong>å®¢æˆ·ç«¯åœ¨å‘èµ·è¯»è¯·æ±‚åï¼Œä¼šä¸€ç›´é˜»å¡ç­‰å¾…æ•°æ®è¿”å›</strong>ï¼Œå¦‚ä½•æ–‡ä»¶æ•°æ®ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œåœ¨å°†ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºæ•°æ®æ‹·è´åˆ°Pagecacheç¼“å†²åŒºä¸­çš„æ­¥éª¤å°±ä¼šæ¯”è¾ƒå¤šä½™ï¼Œå› ä¸ºPageCacheæ–‡ä»¶å¤ªå¤§äº†ï¼Œç›´æ¥å°†PageCacheç¼“å†²åŒºç»™å æ»¡äº†ï¼Œå†æ¬¡è®¿é—®çš„æ¦‚ç‡ä¼šæ¯”è¾ƒä½ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨<strong>å¼‚æ­¥I&#x2F;O</strong>æ¥è§£å†³ã€‚</p><p><img src="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/2-5224603.png" alt="å¼‚æ­¥IOå›¾"></p><p>æ‰€ä»¥ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ï¼Œå¤§æ–‡ä»¶ä¼ è¾“çš„æƒ…æ™¯ä¸‹ï¼Œæœ€å¥½çš„æ–¹æ¡ˆæ˜¯**ã€å¼‚æ­¥I&#x2F;O + ç›´æ¥I&#x2F;Oã€‘**æ¥ä»£æ›¿é›¶æ‹·è´æ–¹æ¡ˆã€‚</p><p>åœ¨nginxä¸­çš„é…ç½®æ–¹æ¡ˆï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /video/&#123;<br><span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;<br><span class="hljs-attribute">aio</span> <span class="hljs-literal">on</span>;<br>  <span class="hljs-attribute">directio</span> <span class="hljs-number">1024m</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æ–‡ä»¶å¤§äº1024mçš„æ—¶å€™ï¼Œä½¿ç”¨å¼‚æ­¥I&#x2F;O+ç›´æ¥I&#x2F;Oçš„æ–¹å¼æ›¿ä»£sendfileé›¶æ‹·è´ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›¶æ‹·è´</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NIOç¾¤èŠ</title>
    <link href="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/NIO%E7%BE%A4%E8%81%8A/"/>
    <url>/2025/08/14/%E6%A1%86%E6%9E%B6/netty/NIO%E7%BE%A4%E8%81%8A/</url>
    
    <content type="html"><![CDATA[<p><strong>ä½¿ç”¨NIOå®ç°ä¸€ä¸ªç®€æ˜“çš„ç¾¤èŠåŠŸèƒ½</strong></p><p>Serverç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio.chat;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.Channel;<br><span class="hljs-keyword">import</span> java.nio.channels.SelectionKey;<br><span class="hljs-keyword">import</span> java.nio.channels.Selector;<br><span class="hljs-keyword">import</span> java.nio.channels.ServerSocketChannel;<br><span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * èŠå¤©æœåŠ¡ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatServerMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ChatServerMain</span> <span class="hljs-variable">chatServer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatServerMain</span>();<br>        chatServer.listen();<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> Selector selector;<br>    <span class="hljs-keyword">private</span> ServerSocketChannel serverSocketChannel;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8899</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatServerMain</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            serverSocketChannel = ServerSocketChannel.open();<br>            serverSocketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>            serverSocketChannel.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(port));<br><br>            selector = Selector.open();<br><br>            serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT); <span class="hljs-comment">// è¿æ¥äº‹ä»¶</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç›‘å¬äº‹ä»¶</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listen</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-comment">// æ²¡æœ‰äº‹ä»¶é˜»å¡ä½</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> selector.select();<br>                <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// è¯´æ˜æœ‰äº‹ä»¶å‘ç”Ÿ</span><br>                    Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();<br>                    Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();<br>                    <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                        <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> iterator.next();<br>                        <span class="hljs-keyword">if</span> (next.isAcceptable()) &#123;  <span class="hljs-comment">// OP_ACCEPT</span><br>                            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> serverSocketChannel.accept();<br>                            socketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>                            socketChannel.register(selector, SelectionKey.OP_READ);<br><br>                            System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯ä¸Šçº¿ï¼Œaddress:&quot;</span> + socketChannel.getRemoteAddress());<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (next.isReadable()) &#123;    <span class="hljs-comment">// OP_READ</span><br>                            read(next);<br>                        &#125;<br><br>                        iterator.remove();<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                serverSocketChannel.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¯»å–æ¶ˆæ¯</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">read</span><span class="hljs-params">(SelectionKey key)</span> &#123;<br>        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel = (SocketChannel) key.channel();<br><br>            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">1024</span>);<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> channel.read(buffer);<br><br>            <span class="hljs-keyword">if</span> (read &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer.array());<br>                System.out.println(<span class="hljs-string">&quot;å‘é€çš„æ¶ˆæ¯ï¼š&quot;</span> + msg);<br><br>                <span class="hljs-comment">// è½¬å‘æ¶ˆæ¯</span><br>                sendOther(msg, channel);<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">if</span> (channel != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    System.out.println(channel.getRemoteAddress() + <span class="hljs-string">&quot; ç¦»çº¿äº†....&quot;</span>);<br>                    channel.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>                    ex.printStackTrace();<br>                &#125;<br>            &#125;<br>            key.cancel();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è½¬å‘æ¶ˆæ¯ï¼Œæ’é™¤è‡ªèº«</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOther</span><span class="hljs-params">(String msg, SocketChannel self)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Set&lt;SelectionKey&gt; keys = selector.keys();<br>        <span class="hljs-keyword">for</span> (SelectionKey key : keys) &#123;<br>            <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> key.channel();<br>            <span class="hljs-keyword">if</span> (channel <span class="hljs-keyword">instanceof</span> SocketChannel &amp;&amp; channel != self) &#123;<br>                <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">socketChannel</span> <span class="hljs-operator">=</span> (SocketChannel) channel;<br>                <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(msg.getBytes());<br><br>                socketChannel.write(buffer);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Clientç«¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio.chat;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.SelectionKey;<br><span class="hljs-keyword">import</span> java.nio.channels.Selector;<br><span class="hljs-keyword">import</span> java.nio.channels.SocketChannel;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * èŠå¤©å®¢æˆ·ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatClientMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ChatClientMain</span> <span class="hljs-variable">chatClientMain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatClientMain</span>();<br><br>        <span class="hljs-comment">// æ¯éš”3sè¯»å–ä¸€æ¬¡é€šé“ä¿¡æ¯</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                chatClientMain.receive();<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">3_000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;).start();<br><br>        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>        <span class="hljs-keyword">while</span> (scanner.hasNextLine()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> scanner.nextLine();<br>            chatClientMain.send(msg);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8899</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">private</span> SocketChannel socketChannel;<br>    <span class="hljs-keyword">private</span> Selector selector;<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatClientMain</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            socketChannel = SocketChannel.open(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(host, port));<br>            socketChannel.configureBlocking(<span class="hljs-literal">false</span>);<br>            selector = Selector.open();<br><br>            socketChannel.register(selector, SelectionKey.OP_READ);<br><br>            username = socketChannel.getLocalAddress().toString().substring(<span class="hljs-number">1</span>);<br>            System.out.println(username + <span class="hljs-string">&quot;is ok....&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String msg)</span> &#123;<br>        msg = username + <span class="hljs-string">&quot;è¯´ï¼š&quot;</span> + msg;<br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.wrap(msg.getBytes());<br>        <span class="hljs-keyword">try</span> &#123;<br>            socketChannel.write(buffer);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receive</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// æ²¡æœ‰äº‹ä»¶é˜»å¡ä½</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> selector.select();<br>            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();<br>                Iterator&lt;SelectionKey&gt; iterator = selectionKeys.iterator();<br>                <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                    <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> iterator.next();<br>                    <span class="hljs-keyword">if</span> (next.isReadable()) &#123;    <span class="hljs-comment">// OP_READ</span><br>                        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> (SocketChannel) next.channel();<br>                        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">1024</span>);<br>                        channel.read(buffer);<br>                        System.out.println(<span class="hljs-string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer.array()));<br>                    &#125;<br>                    iterator.remove();<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id><a href="#" class="headerlink" title></a></h4>]]></content>
    
    
    <categories>
      
      <category>NIO</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NIO</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nettyå­¦ä¹ </title>
    <link href="/2025/08/12/%E6%A1%86%E6%9E%B6/netty/netty/"/>
    <url>/2025/08/12/%E6%A1%86%E6%9E%B6/netty/netty/</url>
    
    <content type="html"><![CDATA[<h1 id="Nettyå­¦ä¹ "><a href="#Nettyå­¦ä¹ " class="headerlink" title="Nettyå­¦ä¹ "></a>Nettyå­¦ä¹ </h1><p>Nettyæ˜¯ä¸€ä¸ª<strong>å¼‚æ­¥çš„ï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨</strong>çš„ç½‘ç»œæ¡†æ¶ã€‚</p><p>ä¹¦ç±æ¨èï¼š</p><ul><li>netty in actionï¼ˆåå®æˆ˜ï¼‰</li><li>nettyæƒå¨æŒ‡å—ï¼ˆnetty5ç†è®ºï¼‰</li></ul><h2 id="BIOã€NIO"><a href="#BIOã€NIO" class="headerlink" title="BIOã€NIO"></a>BIOã€NIO</h2><h3 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h3><p>é˜»å¡IOå®ç°æœåŠ¡ç«¯ServerSocketæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é˜»å¡ioæœåŠ¡ç«¯</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockIoMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();<br><br>        <span class="hljs-comment">// æœåŠ¡ç«¯ServerSocketæœåŠ¡</span><br>        <span class="hljs-type">ServerSocket</span> <span class="hljs-variable">serverSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-number">7777</span>);<br><br>        System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨è¿æ¥.....&quot;</span>);<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> serverSocket.accept();<br><br>            System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯å·²è¿æ¥....&quot;</span>);<br><br>            executorService.execute(() -&gt; &#123;<br>                System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹idï¼š&quot;</span> + Thread.currentThread().getId() + <span class="hljs-string">&quot;ï¼Œçº¿ç¨‹åç§°ï¼š&quot;</span> + Thread.currentThread().getName());<br>                handler(socket);<br>            &#125;);<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¤„ç†å™¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handler</span><span class="hljs-params">(Socket socket)</span> &#123;<br>        <span class="hljs-keyword">try</span> (socket) &#123;<br>            <span class="hljs-comment">// è¯»å–</span><br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> socket.getInputStream();<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br><br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                System.out.println(<span class="hljs-string">&quot;å½“å‰çº¿ç¨‹idï¼š&quot;</span> + Thread.currentThread().getId() + <span class="hljs-string">&quot;ï¼Œçº¿ç¨‹åç§°ï¼š&quot;</span> + Thread.currentThread().getName());<br>                <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> is.read(bytes);<br>                <span class="hljs-comment">// ğŸŒˆç»“æŸè¿”å›-1</span><br>                <span class="hljs-keyword">if</span> (read == -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes, <span class="hljs-number">0</span>, read));<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä½¿ç”¨telnetè¿›è¡Œè¿æ¥</p><p><img src="/2025/08/12/%E6%A1%86%E6%9E%B6/netty/netty/image-20250812161413186.png" alt="image-telnetè¿æ¥æœåŠ¡ç«¯å‘½ä»¤"></p><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="/2025/08/12/%E6%A1%86%E6%9E%B6/netty/netty/image-20250812161457946.png" alt="image-ç»“æœ"></p><p>ç»“è®ºï¼š</p><p>æ¯æ¬¡æ–°çš„å®¢æˆ·ç«¯è¿æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯éƒ½ä¼šæ–°èµ·ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè¯»å†™å¤„ç†ï¼Œä¸¥é‡æµªè´¹æœåŠ¡å™¨èµ„æºå’Œå¢åŠ CPUç³»ç»Ÿå¼€é”€ï¼›è€Œä¸”è¿æ¥åï¼Œæ²¡æœ‰æ•°æ®è¯»å†™çš„æ—¶å€™ï¼Œä¼šé˜»å¡ä½ï¼Œè¿˜ä¸ä¼šé‡Šæ”¾æœåŠ¡ç«¯èµ„æºï¼Œé€ æˆç³»ç»Ÿèµ„æºæµªè´¹ï¼›</p><h3 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h3><p>NIOä¸­ä¸‰ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ï¼š</p><ul><li>Channelï¼šé€šé“</li><li>Bufferï¼šç¼“å†²åŒº</li><li>Selectorï¼šé€‰æ‹©å™¨</li></ul><p><strong>NIOè¿æ¥å…³ç³»ï¼šå®¢æˆ·ç«¯ &#x3D;&#x3D;&gt; bufferç¼“å†²åŒº &lt;&#x3D;&#x3D;&gt; Channelé€šé“ &#x3D;&#x3D;&gt; Selectoré€‰æ‹©å™¨</strong></p><ul><li>æ¯ä¸ªclientéƒ½å¯¹åº”ä¸€ä¸ªbufferç¼“å†²åŒº</li><li>bufferç¼“å†²å™¨å’Œchannelé€šé“åŒå‘è¿æ¥</li><li>channelé€šé“æ³¨å†Œåˆ°selectoré€‰æ‹©å™¨</li><li>selectoré€‰æ‹©å™¨é€‰æ‹©å“ªä¸ªé€šé“æ˜¯ç”±**äº‹ä»¶ï¼ˆEventï¼‰**æ¥å†³å®šçš„</li></ul><p>ç¼“å†²å™¨ï¼ˆBufferï¼‰è¯»å†™æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.nio.IntBuffer;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é€šé“è¯»å†™</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicNioMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">IntBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> IntBuffer.allocate(<span class="hljs-number">5</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; buffer.capacity(); i++) &#123;<br>            buffer.put(i * <span class="hljs-number">2</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// ğŸŒˆè¯»å†™è½¬æ¢å¿…è¦çš„ï¼ï¼ï¼</span><br>        buffer.flip();<br><br>        <span class="hljs-keyword">while</span> (buffer.hasRemaining()) &#123;<br>            System.out.println(buffer.get());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><p><img src="/2025/08/12/%E6%A1%86%E6%9E%B6/netty/netty/image-20250812171744045.png" alt="é€šé“è¯»å†™ç»“æœ"></p><h4 id="Bufferç¼“å†²åŒº"><a href="#Bufferç¼“å†²åŒº" class="headerlink" title="Bufferç¼“å†²åŒº"></a>Bufferç¼“å†²åŒº</h4><p>Bufferçˆ¶ç±»ä¸­æœ‰4ä¸ªé‡è¦çš„å­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">mark</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> limit;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;<br></code></pre></td></tr></table></figure><h4 id="Channelé€šé“"><a href="#Channelé€šé“" class="headerlink" title="Channelé€šé“"></a>Channelé€šé“</h4><p>1.æ–‡ä»¶è¯»å–ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileReadWriteNioMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a.txt&quot;</span>);<br><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/b.txt&quot;</span>);<br><br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">inChannel</span> <span class="hljs-operator">=</span> is.getChannel();<br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">outChannel</span> <span class="hljs-operator">=</span> os.getChannel();<br><br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">30</span>);<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br><br>            <span class="hljs-comment">// ğŸŒˆç‰¹åˆ«é‡è¦ï¼ï¼ï¼ï¼ä¸€å®šè¦å¤ä½ï¼Œä¸ç„¶ä¼šä¸€ç›´è¾“å‡º0</span><br>            buffer.clear();<br><br>            <span class="hljs-comment">// è¯»å–</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> inChannel.read(buffer);<br>            System.out.println(<span class="hljs-string">&quot;read = &quot;</span> + read);<br>            <span class="hljs-keyword">if</span> (read == -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// ç¼“å†²åŒºåè½¬</span><br>            buffer.flip();<br><br>            <span class="hljs-comment">// å†™å…¥</span><br>            outChannel.write(buffer);<br>        &#125;<br><br>        is.close();<br>        os.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong> å¾ªç¯è¯»å–æ–‡ä»¶ä¸­çš„æ•°æ®çš„æ—¶å€™ï¼Œæ¯æ¬¡å¿…é¡»è¦å¤ä½ä¸ç„¶ï¼Œä¼šæœ‰ä¸¥é‡çš„bug</p><p>æ­£å¸¸çš„æƒ…å†µï¼Œæ˜¯å¯ä»¥æ­£å¸¸ç»“æŸçš„ï¼›</p><p>ä½†æ˜¯å¦‚æœä¸å¤ä½çš„æƒ…å†µä¸‹ï¼Œä¼šæ­»å¾ªç¯æ‰“å°0ï¼Œç¨‹åºä¹Ÿç»“æŸä¸äº†ã€‚</p><p><img src="/2025/08/12/%E6%A1%86%E6%9E%B6/netty/netty/image-20250813115308065.png" alt="ä¸å¤ä½çš„ç»“æœå›¾"></p><p>2.å¯ä»¥ä½¿ç”¨transfromå’Œtranstoæ–¹æ³•è¿›è¡Œæ‹·è´æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileTransNioMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a2.txt&quot;</span>);<br><br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a.txt&quot;</span>);<br><br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">inChannel</span> <span class="hljs-operator">=</span> is.getChannel();<br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">outChannel</span> <span class="hljs-operator">=</span> os.getChannel();<br><br>        outChannel.transferFrom(inChannel, <span class="hljs-number">0</span>, inChannel.size());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>transferFrom(ReadableByteChannel channel, long position, long count)</p><p>transTo(long position, long count, WriteableByteChannel channel)</p><ul><li>Channel ï¼šæ¥æºé€šé“</li><li>positionï¼šèµ·å§‹ä½ç½®</li><li>countï¼šè¯»å–çš„ä¸ªæ•°</li></ul><p>3.MappedByteBufferï¼šå¯ä»¥ç›´æ¥åœ¨å †å¤–å†…å­˜ä¿®æ”¹å†…å®¹ï¼Œä¸éœ€è¦æ‹·è´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.netty.nio;<br><br><span class="hljs-keyword">import</span> java.io.RandomAccessFile;<br><span class="hljs-keyword">import</span> java.nio.MappedByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MappedByteBufferMain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">randomAccessFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(<span class="hljs-string">&quot;/Users/apple/Downloads/a.txt&quot;</span>, <span class="hljs-string">&quot;rw&quot;</span>);<br><br>        <span class="hljs-type">FileChannel</span> <span class="hljs-variable">fileChannel</span> <span class="hljs-operator">=</span> randomAccessFile.getChannel();<br><br>        <span class="hljs-type">MappedByteBuffer</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> fileChannel.map(FileChannel.MapMode.READ_WRITE, <span class="hljs-number">0</span>, fileChannel.size());<br><br>        <span class="hljs-comment">// ä¿®æ”¹ä¸‹æ ‡æ˜¯0çš„å­—èŠ‚</span><br>        map.put(<span class="hljs-number">0</span>, (<span class="hljs-type">byte</span>) <span class="hljs-string">&#x27;H&#x27;</span>);<br><br>        randomAccessFile.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="Selectoré€‰æ‹©å™¨"><a href="#Selectoré€‰æ‹©å™¨" class="headerlink" title="Selectoré€‰æ‹©å™¨"></a>Selectoré€‰æ‹©å™¨</h4><p>Selectorå¯ä»¥æ³¨å†Œå¤šä¸ªé€šé“ï¼Œé€šè¿‡äº‹ä»¶ï¼ˆeventï¼‰æ¥å†³å®šæ¥ä½¿ç”¨å“ªä¸ªé€šé“ã€‚</p><p>Selectorä¸­ä¿å­˜äº†SelectionKeyé›†å’Œï¼Œè€ŒSelectionKeyä¸­ä¿å­˜äº†ç›‘å¬çš„é€šé“ä¿¡æ¯å’Œç›‘å¬çš„ç±»å‹ï¼ˆOP_ACCEPTã€OP_CONNECTã€OP_READã€OP_WRITEï¼‰</p><p>å¸¸ç”¨çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Selector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> Selector.open();<span class="hljs-comment">// å¼€å¯selector</span><br><br><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> selector.select();<span class="hljs-comment">// é€‰æ‹©å™¨ç›‘å¬çš„é€šé“æœ‰äº‹ä»¶å‘ç”Ÿçš„ä¸ªæ•°ï¼Œæ²¡æœ‰äº‹ä»¶å°±ä¼šä¸€ç›´é˜»å¡ä½</span><br><br>Set&lt;SelectionKey&gt; selectionKeys = selector.selectedKeys();<span class="hljs-comment">// é€‰æ‹©å™¨ä¸­æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“å¯¹åº”çš„key</span><br><br>Set&lt;SelectionKey&gt; keys = selector.keys();<span class="hljs-comment">// é€‰æ‹©å™¨ä¸Šæ‰€æœ‰é€šé“å¯¹åº”çš„keysï¼Œä¸ç®¡æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿ</span><br><br><br></code></pre></td></tr></table></figure><p>NIOå®ç°çš„ç®€æ˜“ç¾¤èŠåŠŸèƒ½ï¼š<a href="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/NIO%E7%BE%A4%E8%81%8A/" title="NIOç¾¤èŠ">NIOç¾¤èŠ</a></p><h4 id="é›¶æ‹·è´"><a href="#é›¶æ‹·è´" class="headerlink" title="é›¶æ‹·è´"></a>é›¶æ‹·è´</h4><p>ä¸¤ç§é›¶æ‹·è´ï¼šmmapå’Œsendfile</p><p>å…·ä½“åŸç†è¯¦è§£ï¼š<a href="/2025/08/14/%E6%A1%86%E6%9E%B6/netty/%E9%9B%B6%E6%8B%B7%E8%B4%9D/" title="é›¶æ‹·è´">é›¶æ‹·è´</a></p><h2 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h2><p>ç»å…¸ä¸‰ä¸ªé—®é¢˜ï¼š</p><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒNettyæœåŠ¡ç«¯åº”è¯¥èµ·å¤šå°‘çº¿ç¨‹ï¼Ÿä½•æ—¶å¯åŠ¨ï¼Ÿ</li><li>Nettyå¦‚ä½•è§£å†³jdkçš„NIOä¸­ç©ºè½®è®­bugçš„ï¼Ÿ</li></ul><p>åˆ›å»ºæ–°çš„selectoræ›¿æ¢eventLoopäº‹ä»¶å¾ªç¯ä¸­çš„selector</p><ul><li>Nettyå¦‚ä½•ä¿è¯å¼‚æ­¥ä¸²è¡Œæ— é”çš„ï¼Ÿ</li></ul><p>åˆ¤æ–­å½“å‰çº¿ç¨‹å’Œåˆ›å»ºNioEventLoopçš„çº¿ç¨‹æ˜¯å¦ç›¸åŒï¼Œç›¸åŒåˆ™æ‰§è¡Œï¼Œä¸ç›¸åŒï¼Œå°±å°è£…æˆä»»åŠ¡æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚æ‰§è¡Œä»»åŠ¡handlerçš„Pipelineè°ƒç”¨é“¾æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¦‚æœä¸ä¸»åŠ¨è°ƒç”¨åˆ‡æ¢çº¿ç¨‹ï¼Œä¸€ç›´ä¼šç”±NioEventLoopçº¿ç¨‹æ‰§è¡Œï¼ŒæœŸé—´ä¸è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œè¿™ç§æ–¹å¼é¿å…äº†å¤šçº¿ç¨‹å¹¶å‘æ“ä½œå¯¼è‡´çš„é”ç«äº‰é—®é¢˜ã€‚</p><h3 id="NioEventLoop"><a href="#NioEventLoop" class="headerlink" title="NioEventLoop"></a>NioEventLoop</h3><p>äº‹ä»¶å¾ªç¯ï¼Œé‡Œé¢ç»‘å®šäº†ä¸€ä¸ªselectorå’Œä¸€ä¸ªtaskQueueä»»åŠ¡é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯çš„çº¿ç¨‹ï¼Œä¸æ–­ç›‘å¬NIOäº‹ä»¶çš„ç›‘å¬ã€‚</p><p>selectorå¯ä»¥ç»‘å®šå¤šä¸ªNioChannelé€šé“</p><h3 id="Pipelineé€šé“"><a href="#Pipelineé€šé“" class="headerlink" title="Pipelineé€šé“"></a>Pipelineé€šé“</h3><p>é‡Œé¢åŒ…å«äº†ç®¡é“ï¼ˆchannelï¼‰å’ŒchannelHandlerç®¡é“å¤„ç†å™¨çš„åŒå‘é“¾è¡¨</p>]]></content>
    
    
    <categories>
      
      <category>netty</category>
      
    </categories>
    
    
    <tags>
      
      <tag>netty</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>oracle-tools</title>
    <link href="/2025/07/22/%E8%BF%90%E7%BB%B4/oracle-tools/"/>
    <url>/2025/07/22/%E8%BF%90%E7%BB%B4/oracle-tools/</url>
    
    <content type="html"><![CDATA[<h1 id="oracleå°æŠ€å·§"><a href="#oracleå°æŠ€å·§" class="headerlink" title="oracleå°æŠ€å·§"></a>oracleå°æŠ€å·§</h1><p>åœ¨oracleä¸­ï¼Œæœ‰ä¸€äº›å‘½ä»¤æ‰§è¡Œæ•ˆç‡éå¸¸é«˜</p><ul><li>inset int â€¦.. select â€¦ from tableï¼šå°†æŸ¥è¯¢è¡¨çš„æ•°æ®ç›´æ¥æ’å…¥åˆ°å¯¹åº”è¡¨ä¸­</li></ul><p>å®æµ‹å¤‡ä»½åº“25wå·¦å³çš„æ•°æ®ï¼ˆåŒ…å«å¤§å­—æ®µï¼‰ï¼Œæ‰§è¡Œä¸Šé¢çš„å‘½ä»¤èŠ±è´¹ä¸åˆ°10sçš„æ—¶é—´ï¼Œå¯ä»¥æœ‰æ•ˆè¿›è¡Œè¡¨ä¹‹é—´çš„æ•°æ®å¤‡ä»½</p><ul><li>CREATE TABLE â€¦ AS SELECT â€¦ ï¼šåˆ›å»ºè¡¨å¹¶å¤‡ä»½æ•°æ®</li></ul><p>åˆ›å»ºè¡¨å’Œå­—æ®µåç§°æ¥å¤‡ä»½æŸ¥è¯¢çš„æ•°æ®åº“è¡¨æ•°æ®ï¼Œæ•ˆç‡æå‡éå¸¸é«˜</p><p>1.ç®€å•è¡¨å¤‡ä»½</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> employees_copy<br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> employees;<br></code></pre></td></tr></table></figure><p>2.å¤‡ä»½éƒ¨åˆ†æ•°æ®å¹¶ä½¿ç”¨å¹¶è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> recent_orders<br>PARALLEL <span class="hljs-number">8</span><br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> orders<br><span class="hljs-keyword">WHERE</span> order_date <span class="hljs-operator">&gt;=</span> <span class="hljs-type">DATE</span> <span class="hljs-string">&#x27;2023-01-01&#x27;</span>;<br></code></pre></td></tr></table></figure><p>3.åˆ›å»ºè¡¨å¹¶è‡ªå®šä¹‰åˆ—åç§°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE TABLE</span> product_info (<br>    id NUMBER,<br>    name VARCHAR2(<span class="hljs-number">100</span>),<br>    price NUMBER<br>)<br>PARALLEL <span class="hljs-number">4</span><br>NOLOGGING<br><span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span> product_id,<br>       product_name,<br>       list_price<br><span class="hljs-keyword">FROM</span> products;<br></code></pre></td></tr></table></figure><ul><li>TRUNCATE table ï¼šæ¸…ç©ºè¡¨æ•°æ®è¯­å¥ï¼ˆæ…ç”¨â­ï¸ï¼‰</li><li>ä¿®æ”¹è¡¨å­—æ®µå‘½ä»¤ï¼ˆæœ‰æ•°æ®çš„æƒ…å†µä¸‹ï¼‰</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"> <span class="hljs-comment">/*ä¿®æ”¹åŸå­—æ®µånameä¸ºname_tmp*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM rename <span class="hljs-keyword">column</span> EII_ID <span class="hljs-keyword">to</span> EII_ID_T;<br><span class="hljs-comment">/*å¢åŠ ä¸€ä¸ªå’ŒåŸå­—æ®µååŒåçš„å­—æ®µname*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM <span class="hljs-keyword">add</span> EII_ID varchar2(<span class="hljs-number">50</span>);<br><span class="hljs-comment">/*å°†åŸå­—æ®µname_tmpæ•°æ®æ›´æ–°åˆ°å¢åŠ çš„å­—æ®µname*/</span><br><span class="hljs-keyword">update</span> MO_ENTITY_INVOICE_ITEM  <span class="hljs-keyword">set</span> EII_ID<span class="hljs-operator">=</span><span class="hljs-built_in">trim</span>(EII_ID_T);<br><span class="hljs-comment">/*æ›´æ–°å®Œï¼Œåˆ é™¤åŸå­—æ®µname_tmp*/</span><br><span class="hljs-keyword">alter table</span> MO_ENTITY_INVOICE_ITEM <span class="hljs-keyword">drop</span> <span class="hljs-keyword">column</span> EII_ID_T<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>oracle</category>
      
    </categories>
    
    
    <tags>
      
      <tag>oracleå°æŠ€å·§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatisæºç è§£æ</title>
    <link href="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="MyBatisæºç è§£æ"><a href="#MyBatisæºç è§£æ" class="headerlink" title="MyBatisæºç è§£æ"></a>MyBatisæºç è§£æ</h1><h2 id="MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ"></a>MyBatisæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>MyBatisæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œæ”¯æŒ<strong>å®šåˆ¶åŒ–SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„</strong>ã€‚MyBatisé¿å…äº†å‡ ä¹æ‰€æœ‰çš„jdbcä»£ç å’Œæ‰‹åŠ¨è®¾ç½®å‚æ•°å’Œè·å–ç»“æœé›†ã€‚</p><h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨MyBatisï¼Ÿ</h2><p>1ã€å‡è½»jdbcå¤æ‚æ€§ï¼Œä¸ç”¨ç¼–å†™é‡å¤çš„ä»£ç </p><p>2ã€å¤„ç†ç®€å•ï¼Œè®©å¼€å‘è€…æ›´åŠ ä¸“æ³¨sqlçš„å¤„ç†</p><h2 id="MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨"><a href="#MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨" class="headerlink" title="MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨"></a>MYBATISæ‰§è¡Œå™¨å’Œå¤„ç†å™¨</h2><h3 id="æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰"><a href="#æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰" class="headerlink" title="æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰"></a>æ‰§è¡Œå™¨ï¼ˆExecutorï¼‰</h3><ul><li>SimpleExecutorï¼šæ™®é€šæ‰§è¡Œå™¨</li><li>ReuseExecutorï¼šé‡å¤åˆ©ç”¨æ‰§è¡Œå™¨</li><li>BatchExecutorï¼šæ‰¹å¤„ç†æ‰§è¡Œå™¨</li></ul><h3 id="å¤„ç†å™¨ï¼ˆHandlerï¼‰"><a href="#å¤„ç†å™¨ï¼ˆHandlerï¼‰" class="headerlink" title="å¤„ç†å™¨ï¼ˆHandlerï¼‰"></a>å¤„ç†å™¨ï¼ˆHandlerï¼‰</h3><ul><li>SimpleStatementHandlerï¼šæ™®é€šå¤„ç†å™¨</li><li>PrepareStatementHandlerï¼šé¢„ç¼–è¯‘å¤„ç†å™¨</li><li>CallableStatementHandlerï¼šå­˜å‚¨è¿‡ç¨‹å¤„ç†å™¨</li></ul><h2 id="Mybatisç¼“å­˜"><a href="#Mybatisç¼“å­˜" class="headerlink" title="Mybatisç¼“å­˜"></a>Mybatisç¼“å­˜</h2><h3 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h3><p>mybatisä¸€çº§ç¼“å­˜ä¸­æœ‰ä¸¤ç§çº§åˆ«ï¼Œsessionçº§åˆ«å’Œstatementçº§åˆ«ï¼Œsessionçº§åˆ«çš„ä¸€çº§ç¼“å­˜å¯èƒ½ä¼šå‡ºç°è„è¯»çš„æƒ…å†µï¼Œæ‰€ä»¥æ¨èä½¿ç”¨statementçº§åˆ«ã€‚</p><p>1.å¼€å¯ä¸€çº§ç¼“å­˜ï¼Œç¼“å­˜çº§åˆ«æ˜¯sessionçº§åˆ«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœï¼šèµ°äº†ä¸€çº§ç¼“å­˜</p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729171834220.png" alt="image-20250729171834220"></p><p>2.å¼€å¯ä¸€çº§ç¼“å­˜ï¼ŒSESSIONçº§åˆ«ç¼“å­˜ï¼Œä¸­é—´æœ‰æ›´æ–°æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> sqlSession.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    studentMapper.updateById(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;ææ–¯&quot;</span>);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœï¼šæ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œä¸€çº§ç¼“å­˜å¤±æ•ˆ</p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729172019023.png" alt="image-20250729172019023" style="zoom:150%;"><p>3.å¼€å¯ä¸¤ä¸ªsessionä¼šè¯ï¼Œå…¶ä¸­ä¸€ä¸ªä¼šè¯æ›´æ”¹æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstCacheTest3</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">sm1</span> <span class="hljs-operator">=</span> sqlSession1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> sqlSession2.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student1:&#123;&#125;&quot;</span>, sm1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student2:&#123;&#125;&quot;</span>, sm2.queryById(<span class="hljs-number">1</span>));<br><br>    sm1.updateById(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;å‘¨äº”&quot;</span>);<br><br>    log.info(<span class="hljs-string">&quot;===============&gt; student1:&#123;&#125;&quot;</span>, sm1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;===============&gt; student2:&#123;&#125;&quot;</span>, sm2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœï¼šä¸¤ä¸ªsessionä¼šè¯äº’ä¸å½±å“ï¼Œsession1æ‰§è¡Œæ›´æ”¹æ“ä½œåï¼Œä¸€çº§ç¼“å­˜å¤±æ•ˆï¼Œsession2è¿˜æ˜¯æ­£å¸¸èµ°ä¸€çº§ç¼“å­˜ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå‡ºç°è„è¯»æƒ…å†µã€‚</p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729172517955.png" alt="image-20250729172517955"></p><h3 id="äºŒçº§ç¼“å­˜"><a href="#äºŒçº§ç¼“å­˜" class="headerlink" title="äºŒçº§ç¼“å­˜"></a>äºŒçº§ç¼“å­˜</h3><p>å¼€å¯äºŒçº§ç¼“å­˜</p><p>1.å¼€å¯äºŒçº§ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;setting name=<span class="hljs-string">&quot;cacheEnabled&quot;</span> value=<span class="hljs-string">&quot;true&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><p>2.mapperæ–‡ä»¶ä¸­åŠ å…¥äºŒçº§ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;cache/&gt;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨cache-refæ ‡ç­¾è¡¨ç¤ºå¼•ç”¨åˆ«çš„å‘½åç©ºè§çš„cacheé…ç½®ï¼Œä¸¤ä¸ªå‘½åç©ºè§çš„æ“ä½œä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªcache.</strong></p><blockquote><p>ğŸŒˆæ³¨æ„ï¼šä½†æ˜¯ä¸€ä¸ªå‘½ä»¤ç©ºé—´çš„é…ç½®æ–‡ä»¶åƒä¸‡ä¸è¦åŒæ—¶é…ç½®cacheå’Œcache-refä¸¤ä¸ªæ ‡ç­¾ï¼Œå› ä¸ºä¼šæ ¹æ®åŠ è½½é¡ºåºçš„é—®é¢˜å¯¼è‡´ç‹¬äº«ç¼“å­˜è¿˜æ˜¯å…±äº«ç¼“å­˜ä¸ä¸€å®šï¼ï¼ï¼</p></blockquote><p><strong>å®éªŒ1:</strong></p><p>æµ‹è¯•äºŒçº§ç¼“å­˜ï¼Œä¸æäº¤äº‹åŠ¡ï¼Œä¸¤ä¸ªæŸ¥è¯¢æ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">secondCacheTest1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper1</span> <span class="hljs-operator">=</span> s1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper2</span> <span class="hljs-operator">=</span> s2.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;======&gt; mapper1:&#123;&#125;&quot;</span>, mapper1.queryById(<span class="hljs-number">1</span>));<br>    log.info(<span class="hljs-string">&quot;======&gt; mapper2:&#123;&#125;&quot;</span>, mapper2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šmapper1äº‹åŠ¡æ²¡æœ‰æäº¤ï¼Œæ²¡æœ‰èµ°äºŒçº§ç¼“å­˜ã€‚</p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804102540851.png" alt="image-äºŒçº§ç¼“å­˜æ²¡æœ‰æäº¤äº‹åŠ¡ç»“æœ"></p><p><strong>å®éªŒ2:</strong></p><p>æµ‹è¯•äºŒçº§ç¼“å­˜ï¼Œæäº¤äº‹åŠ¡ï¼Œä¸¤ä¸ªæŸ¥è¯¢æ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">secondCacheTest1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper1</span> <span class="hljs-operator">=</span> s1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">mapper2</span> <span class="hljs-operator">=</span> s2.getMapper(StudentMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;======&gt; mapper1:&#123;&#125;&quot;</span>, mapper1.queryById(<span class="hljs-number">1</span>));<br>    s1.commit();<br>    log.info(<span class="hljs-string">&quot;======&gt; mapper2:&#123;&#125;&quot;</span>, mapper2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šmapper1äº‹åŠ¡æäº¤åï¼Œèµ°äº†äºŒçº§ç¼“å­˜</p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804102425743.png" alt="image-äºŒçº§ç¼“å­˜äº‹åŠ¡æäº¤åç»“æœ"></p><p><strong>å®éªŒ3:</strong></p><p>ä¸¤ä¸ªå®ä½“ï¼Œä¸ä½¿ç”¨cache-refçš„æƒ…å†µä¸‹ï¼Œæ›´æ”¹å…¶ä¸­ä¸€ä¸ªå®ä½“çš„å±æ€§åæäº¤ï¼Œæ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">secondCacheTest2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session1</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session2</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session3</span> <span class="hljs-operator">=</span> factory.openSession(<span class="hljs-literal">true</span>);<br><br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper</span> <span class="hljs-operator">=</span> session1.getMapper(StudentMapper.class);<br>    <span class="hljs-type">StudentMapper</span> <span class="hljs-variable">studentMapper2</span> <span class="hljs-operator">=</span> session2.getMapper(StudentMapper.class);<br>    <span class="hljs-type">OrderMapper</span> <span class="hljs-variable">orderMapper</span> <span class="hljs-operator">=</span> session3.getMapper(OrderMapper.class);<br><br>    log.info(<span class="hljs-string">&quot;=====&gt; studentMapper:&#123;&#125;&quot;</span>, studentMapper.queryById(<span class="hljs-number">1</span>));<br>    session1.close();<br>    log.info(<span class="hljs-string">&quot;=====&gt; studentMapper:&#123;&#125;&quot;</span>, studentMapper2.queryById(<span class="hljs-number">1</span>));<br><br>    orderMapper.updateById(<span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">100</span>));<br>    session3.commit();<br>    log.info(<span class="hljs-string">&quot;=====&gt; studentMapper:&#123;&#125;&quot;</span>, studentMapper2.queryById(<span class="hljs-number">1</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“è®ºï¼šä¸ä½¿ç”¨cache-refçš„æƒ…å†µä¸‹ï¼Œå³ä½¿åšäº†æ›´æ–°æ“ä½œå¹¶æäº¤ï¼Œä¹Ÿä¼šç»§ç»­èµ°ç¼“å­˜ï¼ï¼ï¼</p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804105633154.png" alt="image-äºŒçº§ç¼“å­˜æ²¡æœ‰ä½¿ç”¨cache-ref"></p><p><strong>å®éªŒ4:</strong></p><p>ä¸¤ä¸ªå®ä½“ï¼Œåœ¨å®ä½“çš„é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨cache-refçš„æƒ…å†µä¸‹ï¼Œæ›´æ”¹å…¶ä¸­ä¸€ä¸ªå®ä½“çš„å±æ€§åæäº¤ï¼Œæ˜¯å¦ä¼šèµ°ç¼“å­˜ï¼Ÿ</p><p>ç»“è®ºï¼šä½¿ç”¨cache-refæ ‡ç­¾åï¼Œå°†ä¸¤ä¸ªå®ä½“åˆå¹¶æˆä¸€ä¸ªcacheï¼Œæ‰€ä»¥æœ‰æ›´æ–°æ“ä½œåï¼Œä¸ä¼šå†èµ°ç¼“å­˜ã€‚</p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250804105935423.png" alt="image-äºŒçº§ç¼“å­˜ä½¿ç”¨äº†cache-ref"></p><blockquote><p>ğŸŒˆæ³¨æ„ï¼šä½¿ç”¨cache-refçš„åæœå°±æ˜¯ç¼“å­˜çš„ç²’åº¦å˜ç²—äº†ï¼Œå¤šä¸ªmapperä¸‹çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šå¯¹ç¼“å­˜ä½¿ç”¨é€ æˆå½±å“ã€‚</p></blockquote><h2 id="PageHelperåˆ†é¡µæ’ä»¶åŸç†"><a href="#PageHelperåˆ†é¡µæ’ä»¶åŸç†" class="headerlink" title="PageHelperåˆ†é¡µæ’ä»¶åŸç†"></a>PageHelperåˆ†é¡µæ’ä»¶åŸç†</h2><p>1ã€å°†PageInterceptoræ‹¦æˆªå™¨åŠ å…¥åˆ°pluginæ‹¦æˆªå™¨è´£ä»»é“¾ä¸­</p><p>2ã€åˆ›å»ºsqlsessionÂ¶çš„æ—¶å€™ï¼Œåˆå§‹åŒ–executoræ‰§è¡Œå™¨æ—¶ï¼Œä¼šæ‰§è¡Œpluginæ‹¦æˆªå™¨é“¾ï¼Œåˆ›å»ºexecutoråŠ¨æ€ä»£ç†å¯¹è±¡</p><p>3ã€åœ¨æ‰§è¡Œsqlsession#queryæ–¹æ³•æ—¶ï¼Œä¼šå…ˆæ‰§è¡Œä»£ç†æ–¹æ³•ï¼Œè¿›åˆ°PageInterceptoræ‹¦æˆªå™¨ä¸­ï¼Œè¿›è¡Œåˆ†é¡µå‚æ•°æ‹¼æ¥</p><p>4ã€æœ€åå†æ‰§è¡Œexecutorå…·ä½“æ–¹æ³•</p><h2 id="MyBatisè§£æé…ç½®æ–‡ä»¶"><a href="#MyBatisè§£æé…ç½®æ–‡ä»¶" class="headerlink" title="MyBatisè§£æé…ç½®æ–‡ä»¶"></a>MyBatisè§£æé…ç½®æ–‡ä»¶</h2><p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;<br><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250729212435064.png" alt="image-äºŒçº§ç¼“å­˜"></p><h2 id="äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ"><a href="#äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ" class="headerlink" title="äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ"></a>äº†è§£mybatis-spring-boot-starterå®ç°åŸç†æºç è§£æ</h2><h3 id="1ã€mybatisè‡ªåŠ¨é…ç½®ç±»-MybatisAutoConfiguration"><a href="#1ã€mybatisè‡ªåŠ¨é…ç½®ç±»-MybatisAutoConfiguration" class="headerlink" title="1ã€mybatisè‡ªåŠ¨é…ç½®ç±» MybatisAutoConfiguration"></a>1ã€mybatisè‡ªåŠ¨é…ç½®ç±» MybatisAutoConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@org</span>.springframework.context.annotation.Configuration<br><span class="hljs-meta">@ConditionalOnClass(&#123; SqlSessionFactory.class, SqlSessionFactoryBean.class &#125;)</span><br><span class="hljs-meta">@ConditionalOnSingleCandidate(DataSource.class)</span><br><span class="hljs-meta">@EnableConfigurationProperties(MybatisProperties.class)</span><br><span class="hljs-meta">@AutoConfigureAfter(&#123; DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisAutoConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(MybatisAutoConfiguration.class);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MybatisProperties properties;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Interceptor[] interceptors;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandler[] typeHandlers;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LanguageDriver[] languageDrivers;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DatabaseIdProvider databaseIdProvider;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ConfigurationCustomizer&gt; configurationCustomizers;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MybatisAutoConfiguration</span><span class="hljs-params">(MybatisProperties properties, ObjectProvider&lt;Interceptor[]&gt; interceptorsProvider,</span><br><span class="hljs-params">      ObjectProvider&lt;TypeHandler[]&gt; typeHandlersProvider, ObjectProvider&lt;LanguageDriver[]&gt; languageDriversProvider,</span><br><span class="hljs-params">      ResourceLoader resourceLoader, ObjectProvider&lt;DatabaseIdProvider&gt; databaseIdProvider,</span><br><span class="hljs-params">      ObjectProvider&lt;List&lt;ConfigurationCustomizer&gt;&gt; configurationCustomizersProvider)</span> &#123;<br>    <span class="hljs-built_in">this</span>.properties = properties;<br>    <span class="hljs-built_in">this</span>.interceptors = interceptorsProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.typeHandlers = typeHandlersProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.languageDrivers = languageDriversProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;<br>    <span class="hljs-built_in">this</span>.databaseIdProvider = databaseIdProvider.getIfAvailable();<br>    <span class="hljs-built_in">this</span>.configurationCustomizers = configurationCustomizersProvider.getIfAvailable();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>    checkConfigFileExists();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkConfigFileExists</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.isCheckConfigLocation() &amp;&amp; StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.resourceLoader.getResource(<span class="hljs-built_in">this</span>.properties.getConfigLocation());<br>      Assert.state(resource.exists(),<br>          <span class="hljs-string">&quot;Cannot find config location: &quot;</span> + resource + <span class="hljs-string">&quot; (please add config file or check your Mybatis configuration)&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">sqlSessionFactory</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">SqlSessionFactoryBean</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBean</span>();<br>    factory.setDataSource(dataSource);<br>    factory.setVfs(SpringBootVFS.class);<br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      factory.setConfigLocation(<span class="hljs-built_in">this</span>.resourceLoader.getResource(<span class="hljs-built_in">this</span>.properties.getConfigLocation()));<br>    &#125;<br>    applyConfiguration(factory);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.getConfigurationProperties() != <span class="hljs-literal">null</span>) &#123;<br>      factory.setConfigurationProperties(<span class="hljs-built_in">this</span>.properties.getConfigurationProperties());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.interceptors)) &#123;<br>      factory.setPlugins(<span class="hljs-built_in">this</span>.interceptors);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.databaseIdProvider != <span class="hljs-literal">null</span>) &#123;<br>      factory.setDatabaseIdProvider(<span class="hljs-built_in">this</span>.databaseIdProvider);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasLength(<span class="hljs-built_in">this</span>.properties.getTypeAliasesPackage())) &#123;<br>      factory.setTypeAliasesPackage(<span class="hljs-built_in">this</span>.properties.getTypeAliasesPackage());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties.getTypeAliasesSuperType() != <span class="hljs-literal">null</span>) &#123;<br>      factory.setTypeAliasesSuperType(<span class="hljs-built_in">this</span>.properties.getTypeAliasesSuperType());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasLength(<span class="hljs-built_in">this</span>.properties.getTypeHandlersPackage())) &#123;<br>      factory.setTypeHandlersPackage(<span class="hljs-built_in">this</span>.properties.getTypeHandlersPackage());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.typeHandlers)) &#123;<br>      factory.setTypeHandlers(<span class="hljs-built_in">this</span>.typeHandlers);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.properties.resolveMapperLocations())) &#123;<br>      factory.setMapperLocations(<span class="hljs-built_in">this</span>.properties.resolveMapperLocations());<br>    &#125;<br>    Set&lt;String&gt; factoryPropertyNames = Stream<br>        .of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>(SqlSessionFactoryBean.class).getPropertyDescriptors()).map(PropertyDescriptor::getName)<br>        .collect(Collectors.toSet());<br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LanguageDriver</span>&gt; defaultLanguageDriver = <span class="hljs-built_in">this</span>.properties.getDefaultScriptingLanguageDriver();<br>    <span class="hljs-keyword">if</span> (factoryPropertyNames.contains(<span class="hljs-string">&quot;scriptingLanguageDrivers&quot;</span>) &amp;&amp; !ObjectUtils.isEmpty(<span class="hljs-built_in">this</span>.languageDrivers)) &#123;<br>      <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>      factory.setScriptingLanguageDrivers(<span class="hljs-built_in">this</span>.languageDrivers);<br>      <span class="hljs-keyword">if</span> (defaultLanguageDriver == <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.languageDrivers.length == <span class="hljs-number">1</span>) &#123;<br>        defaultLanguageDriver = <span class="hljs-built_in">this</span>.languageDrivers[<span class="hljs-number">0</span>].getClass();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (factoryPropertyNames.contains(<span class="hljs-string">&quot;defaultScriptingLanguageDriver&quot;</span>)) &#123;<br>      <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>      factory.setDefaultScriptingLanguageDriver(defaultLanguageDriver);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> factory.getObject();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyConfiguration</span><span class="hljs-params">(SqlSessionFactoryBean factory)</span> &#123;<br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.properties.getConfiguration();<br>    <span class="hljs-keyword">if</span> (configuration == <span class="hljs-literal">null</span> &amp;&amp; !StringUtils.hasText(<span class="hljs-built_in">this</span>.properties.getConfigLocation())) &#123;<br>      configuration = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (configuration != <span class="hljs-literal">null</span> &amp;&amp; !CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.configurationCustomizers)) &#123;<br>      <span class="hljs-keyword">for</span> (ConfigurationCustomizer customizer : <span class="hljs-built_in">this</span>.configurationCustomizers) &#123;<br>        customizer.customize(configuration);<br>      &#125;<br>    &#125;<br>    factory.setConfiguration(configuration);<br>  &#125;<br><br>  <span class="hljs-meta">@Bean</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean</span><br>  <span class="hljs-keyword">public</span> SqlSessionTemplate <span class="hljs-title function_">sqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory)</span> &#123;<br>    <span class="hljs-type">ExecutorType</span> <span class="hljs-variable">executorType</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.properties.getExecutorType();<br>    <span class="hljs-keyword">if</span> (executorType != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sqlSessionFactory, executorType);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sqlSessionFactory);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * This will just scan the same base package as Spring Boot does. If you want more power, you can explicitly use</span><br><span class="hljs-comment">   * &#123;<span class="hljs-doctag">@link</span> org.mybatis.spring.annotation.MapperScan&#125; but this will get typed mappers working correctly, out-of-the-box,</span><br><span class="hljs-comment">   * similar to using Spring Data JPA repositories.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfiguredMapperScannerRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryAware</span>, ImportBeanDefinitionRegistrar &#123;<br><br>    <span class="hljs-keyword">private</span> BeanFactory beanFactory;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br><br>      <span class="hljs-keyword">if</span> (!AutoConfigurationPackages.has(<span class="hljs-built_in">this</span>.beanFactory)) &#123;<br>        logger.debug(<span class="hljs-string">&quot;Could not determine auto-configuration package, automatic mapper scanning disabled.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br><br>      logger.debug(<span class="hljs-string">&quot;Searching for mappers annotated with @Mapper&quot;</span>);<br><br>      List&lt;String&gt; packages = AutoConfigurationPackages.get(<span class="hljs-built_in">this</span>.beanFactory);<br>      <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>        packages.forEach(pkg -&gt; logger.debug(<span class="hljs-string">&quot;Using auto-configuration base package &#x27;&#123;&#125;&#x27;&quot;</span>, pkg));<br>      &#125;<br><br>      <span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;processPropertyPlaceHolders&quot;</span>, <span class="hljs-literal">true</span>);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;annotationClass&quot;</span>, Mapper.class);<br>      builder.addPropertyValue(<span class="hljs-string">&quot;basePackage&quot;</span>, StringUtils.collectionToCommaDelimitedString(packages));<br>      <span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">beanWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperImpl</span>(MapperScannerConfigurer.class);<br>      Stream.of(beanWrapper.getPropertyDescriptors())<br>          <span class="hljs-comment">// Need to mybatis-spring 2.0.2+</span><br>          .filter(x -&gt; x.getName().equals(<span class="hljs-string">&quot;lazyInitialization&quot;</span>)).findAny()<br>          .ifPresent(x -&gt; builder.addPropertyValue(<span class="hljs-string">&quot;lazyInitialization&quot;</span>, <span class="hljs-string">&quot;$&#123;mybatis.lazy-initialization:false&#125;&quot;</span>));<br>      registry.registerBeanDefinition(MapperScannerConfigurer.class.getName(), builder.getBeanDefinition());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanFactory</span><span class="hljs-params">(BeanFactory beanFactory)</span> &#123;<br>      <span class="hljs-built_in">this</span>.beanFactory = beanFactory;<br>    &#125;<br><br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * If mapper registering configuration or mapper scanning configuration not present, this configuration allow to scan</span><br><span class="hljs-comment">   * mappers based on the same component-scanning path as Spring Boot itself.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@org</span>.springframework.context.annotation.Configuration<br>  <span class="hljs-meta">@Import(AutoConfiguredMapperScannerRegistrar.class)</span><br>  <span class="hljs-meta">@ConditionalOnMissingBean(&#123; MapperFactoryBean.class, MapperScannerConfigurer.class &#125;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerRegistrarNotFoundConfiguration</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>      logger.debug(<br>          <span class="hljs-string">&quot;Not found configuration for registering mapper bean using @MapperScan, MapperFactoryBean and MapperScannerConfigurer.&quot;</span>);<br>    &#125;<br><br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹ä¸€ä¸‹MybatisAutoConfigurationç±»ä¸Šçš„å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p>@org.springframework.context.annotation.Configurationï¼šè¯¥æ³¨è§£è¡¨æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è§£æåŠ è½½ï¼Œç”ŸæˆBeanå¯¹è±¡æ”¾å…¥å®¹å™¨ä¸­</p><ul><li>å±æ€§å€¼1ï¼švalueï¼šæ³¨å…¥å®¹å™¨ä¸­çš„Beanåç§°ï¼ˆä¸èµ‹å€¼é»˜è®¤å°é©¼å³°ç±»åç§°ï¼‰</li><li>å±æ€§å€¼2ï¼šproxyBeanMethodsï¼šæ˜¯å¦å•ä¾‹ï¼ˆé»˜è®¤trueï¼‰</li></ul></li><li><p>@ConditionalOnClass({ SqlSessionFactory.class, SqlSessionFactoryBean.class })ï¼šç±»æ¡ä»¶åˆ¤æ–­ï¼Œå½“æœ‰SqlSessionFactoryç±»å’ŒSqlSessionFactoryBeanç±»ï¼Œä¸¤ä¸ªç±»åŒæ—¶å­˜åœ¨æ—¶åŠ è½½</p></li><li><p>@ConditionalOnSingleCandidate(DataSource.class)ï¼šå•ä¾‹æ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªç±»å‹çš„DataSourceçš„Beanå®šä¹‰æ—¶æ‰åŠ è½½</p></li><li><p>@EnableConfigurationProperties(MybatisProperties.class)ï¼šåŠ è½½mybatiså±æ€§å€¼</p></li><li><p>@AutoConfigureAfter({ DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class })ï¼šå…ˆå®Œæˆä¸¤ä¸ªé…ç½®ç±»åŠ è½½åå†åŠ è½½ï¼Œå…ˆåé¡ºåºåŠ è½½åˆ¤æ–­</p></li></ul><p>æ ¹æ®æ¡ä»¶æ³¨è§£åˆ¤æ–­åŠ è½½Beanï¼š</p><ul><li>sqlSessionFactoryï¼šsessionå·¥åœº</li><li>sqlSessionTemplateï¼šsessionæ¨¡æ¿æ–¹æ³•ï¼Œsessionå®‰å…¨å¤„ç†å’Œäº‹åŠ¡ç®¡ç†</li><li>mapperScannerRegistrarNotFoundConfigurationï¼šæ²¡æœ‰MapperFactoryBeanå’ŒMapperScannerConfigurerä¸¤ä¸ªBeanæ—¶åŠ è½½ï¼ŒåŒæ—¶å¼•å…¥AutoConfiguredMapperSannerRegistraræ³¨å†Œç±»ã€‚<ul><li><strong>å½“åˆ¤æ–­@ConditionalOnMissingBeanæ¡ä»¶ç±»æ˜¯å¦æ»¡è¶³ï¼Œæ»¡è¶³æ‰ä¼šæ‰§è¡Œ@Importæ³¨è§£å¼•å…¥çš„æ³¨å†Œç±»ï¼Œå¦åˆ™ä¸ä¼šæ‰§è¡Œå¼•å…¥æ³¨å†Œç±»</strong></li><li><strong>å¦‚æœæ²¡æœ‰ä½¿ç”¨@MapperScanæ³¨è§£å’Œæ‰‹åŠ¨é…ç½®è¿‡MapperFactoryBeanã€MapperScannerConfigureré…ç½®ï¼Œä¼šè‡ªåŠ¨æ‰«æå¯åŠ¨ç±»æ‰€åœ¨åŒ…è·¯å¾„</strong></li><li>mapperScannerRegistrarNotFoundConfigurationé…ç½®ä¸­å¼•å…¥äº†AutoConfiguredMapperScannerRegistraræ³¨å†Œå™¨ï¼Œè¯¥ç±»å®ç°äº†ImportBeanDefinitionRegistraræ¥å£ï¼Œåœ¨å®¹å™¨å¯åŠ¨æ—¶ä¼šæ‰§è¡ŒregisterBeanDefinitionsæ–¹æ³•</li><li>è¿™ä¸ªæ³¨å†Œå™¨ä¸­ä¼šæ³¨å…¥MapperScannerConfigurerçš„BeanDifinitionè¿›è¡Œæ³¨å†Œ</li></ul></li></ul><h3 id="2ã€MapperScannerConfigurer-æ‰«æmapperé…ç½®ç±»"><a href="#2ã€MapperScannerConfigurer-æ‰«æmapperé…ç½®ç±»" class="headerlink" title="2ã€MapperScannerConfigurer æ‰«æmapperé…ç½®ç±»"></a>2ã€MapperScannerConfigurer æ‰«æmapperé…ç½®ç±»</h3><p>MapperScannerConfigurerç±»å®ç°äº†BeanDefinitionRegistryPostProcessoræ¥å£ï¼Œè€ŒBeanDefinitionRegistryPostProcessoræ¥å£ç»§æ‰¿äº†BeanFactoryPostProcessæ¥å£ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.processPropertyPlaceHolders) &#123;<br>    processPropertyPlaceHolders();<br>  &#125;<br><br>  <span class="hljs-type">ClassPathMapperScanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);<br>  scanner.setAddToConfig(<span class="hljs-built_in">this</span>.addToConfig);<br>  scanner.setAnnotationClass(<span class="hljs-built_in">this</span>.annotationClass);<br>  scanner.setMarkerInterface(<span class="hljs-built_in">this</span>.markerInterface);<br>  scanner.setSqlSessionFactory(<span class="hljs-built_in">this</span>.sqlSessionFactory);<br>  scanner.setSqlSessionTemplate(<span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>  scanner.setSqlSessionFactoryBeanName(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName);<br>  scanner.setSqlSessionTemplateBeanName(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName);<br>  scanner.setResourceLoader(<span class="hljs-built_in">this</span>.applicationContext);<br>  scanner.setBeanNameGenerator(<span class="hljs-built_in">this</span>.nameGenerator);<br>  scanner.setMapperFactoryBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br>  <span class="hljs-keyword">if</span> (StringUtils.hasText(lazyInitialization)) &#123;<br>    scanner.setLazyInitialization(Boolean.valueOf(lazyInitialization));<br>  &#125;<br>  scanner.registerFilters();<br>  <span class="hljs-comment">// æ‰«æmapperæ¥å£æ–¹æ³•</span><br>  scanner.scan(<br>      StringUtils.tokenizeToStringArray(<span class="hljs-built_in">this</span>.basePackage, ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS));<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œæ‰«æçš„æ–¹æ³•æ˜¯ClassPathMapperScanner#doScanæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">doScan</span><span class="hljs-params">(String... basePackages)</span> &#123;<br>  <span class="hljs-comment">// æ‰§è¡Œçš„æ˜¯çˆ¶ç±»ClassPathBeanDefinitionScannerç±»ä¸­çš„æ‰«ææ–¹æ³•</span><br>  Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-built_in">super</span>.doScan(basePackages);<br><br>  <span class="hljs-keyword">if</span> (beanDefinitions.isEmpty()) &#123;<br>    LOGGER.warn(() -&gt; <span class="hljs-string">&quot;No MyBatis mapper was found in &#x27;&quot;</span> + Arrays.toString(basePackages)<br>        + <span class="hljs-string">&quot;&#x27; package. Please check your configuration.&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å°†mapperæ¥å£æ–¹æ³•å…¨éƒ½å˜æˆMapperFactoryBeanå·¥å‚å¯¹è±¡</span><br>    processBeanDefinitions(beanDefinitions);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> beanDefinitions;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰«ææŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰mapperæ¥å£åï¼Œæ‰§è¡Œbeanå®šä¹‰ä¿¡æ¯å¤„ç†å™¨æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MapperFactoryBean</span>&gt; mapperFactoryBeanClass = MapperFactoryBean.class;<br><br><span class="hljs-comment">// ===================&gt; æ‰§è¡Œbeanå®šä¹‰ä¿¡æ¯å¤„ç†å™¨ &lt;====================</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBeanDefinitions</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; beanDefinitions)</span> &#123;<br>  GenericBeanDefinition definition;<br>  <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : beanDefinitions) &#123;<br>    definition = (GenericBeanDefinition) holder.getBeanDefinition();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">beanClassName</span> <span class="hljs-operator">=</span> definition.getBeanClassName();<br>    LOGGER.debug(() -&gt; <span class="hljs-string">&quot;Creating MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + beanClassName<br>        + <span class="hljs-string">&quot;&#x27; mapperInterface&quot;</span>);<br><br>    <span class="hljs-comment">// the mapper interface is the original class of the bean</span><br>    <span class="hljs-comment">// but, the actual class of the bean is MapperFactoryBean</span><br>    definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName); <span class="hljs-comment">// issue #59</span><br>    <br>    <span class="hljs-comment">// ================&gt; å°†æ‰«æå‡ºæ¥çš„mapperå®šä¹‰ä¿¡æ¯è®¾ç½®æˆmapperFactoryBean &lt;==================</span><br>    definition.setBeanClass(<span class="hljs-built_in">this</span>.mapperFactoryBeanClass);<br><br>    definition.getPropertyValues().add(<span class="hljs-string">&quot;addToConfig&quot;</span>, <span class="hljs-built_in">this</span>.addToConfig);<br><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">explicitFactoryUsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName)) &#123;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionFactoryBeanName));<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionFactory != <span class="hljs-literal">null</span>) &#123;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionFactory);<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName)) &#123;<br>      <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>        LOGGER.warn(<br>            () -&gt; <span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>      &#125;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeBeanReference</span>(<span class="hljs-built_in">this</span>.sqlSessionTemplateBeanName));<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlSessionTemplate != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (explicitFactoryUsed) &#123;<br>        LOGGER.warn(<br>            () -&gt; <span class="hljs-string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span>);<br>      &#125;<br>      definition.getPropertyValues().add(<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span>, <span class="hljs-built_in">this</span>.sqlSessionTemplate);<br>      explicitFactoryUsed = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!explicitFactoryUsed) &#123;<br>      LOGGER.debug(() -&gt; <span class="hljs-string">&quot;Enabling autowire by type for MapperFactoryBean with name &#x27;&quot;</span> + holder.getBeanName() + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>      definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);<br>    &#125;<br>    definition.setLazyInit(lazyInitialization);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨AbstractBeanFactory#doGetBeanæ–¹æ³•ä¸­ï¼Œè·å–åˆ°mapperæ¥å£å¯¹åº”çš„mapperFactoryBeanå·¥å‚å¯¹è±¡åï¼Œæ ¹æ®å·¥å‚å¯¹è±¡åˆ›å»ºmapperProxyä»£ç†å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>sharedInstance = getSingleton(beanName, () -&gt; &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>&#125;<br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br><span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br><span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>destroySingleton(beanName);<br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br>&#125;);<br>    <span class="hljs-comment">// æ ¹æ®å·¥å‚å¯¹è±¡è·å–å¯¹è±¡</span><br>bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸šåŠ¡æ–¹æ³•æ­£å¼è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StudentService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StudentDao studentDao;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">queryById</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student1</span> <span class="hljs-operator">=</span> studentDao.queryById(id);<br>        studentDao.updateById(String.valueOf(id), <span class="hljs-string">&quot;å¼ ä¸‰222&quot;</span>);<br>        <span class="hljs-keyword">return</span> student1;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151230617.png" alt="image-20250531151230617"></p><p>æ³¨å…¥çš„beanå¯¹è±¡æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šè¿›å…¥åˆ°MapperProxyä»£ç†ç±»ä¸­çš„invokeæ–¹æ³•ä¸­ï¼Œç„¶åè¿›å…¥åˆ°MapperMethodç±»ä¸­ã€‚</p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151601515.png" alt="image-20250531151601515"></p><p><img src="/2025/05/24/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/image-20250531151739625.png" alt="image-20250531151739625"></p>]]></content>
    
    
    <categories>
      
      <category>mybatis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æºç è§£æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
